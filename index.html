<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Engine</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root { --theme-accent: #FF8C42; --theme-bg: #3D2B1F; --theme-accent-rgb: 255, 140, 66; --gray-marble: #F0F0F0; --radius: 12px; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: var(--gray-marble); color: #3D2B1F; font-family: -apple-system, sans-serif; margin: 0; padding: 0; overflow-x: hidden; width: 100%; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 20px 15px; }
        h1 { border: 4px solid #1A1A1A; text-align: center; margin: 0; background: var(--theme-accent); padding: 15px 12px; box-shadow: 6px 6px 0px #000; border-radius: var(--radius); color: var(--theme-bg); font-weight: 900; line-height: 1.2; }
        
        .save-status { text-align: center; font-size: 10px; font-weight: bold; margin: 10px 0 20px 0; color: #888; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .status-dot.active { background: #00C853; box-shadow: 0 0 8px #00C853; }

        .rebalance-panel { background: white; border: 4px solid #1A1A1A; padding: 20px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); }
        .chart-btn { background: var(--theme-accent); color: var(--theme-bg); border: 2px solid #1A1A1A; padding: 5px 12px; font-size: 0.75rem; font-weight: 900; border-radius: 6px; cursor: pointer; box-shadow: 2px 2px 0px #1A1A1A; }

        .category-card { background: #fff; border: 4px solid #1A1A1A; padding: 15px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); position: relative; }
        .category-header { background: var(--theme-bg); color: var(--theme-accent); padding: 12px 15px; margin: -15px -15px 10px -15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; cursor: pointer; }
        .btn-delete-card { position: absolute; top: -12px; right: -12px; width: 28px; height: 28px; border-radius: 50%; background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; font-weight: bold; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; }

        .target-input { width: 42px; background: var(--theme-accent); color: var(--theme-bg); border: 1px solid #1A1A1A; font-weight: bold; text-align: center; border-radius: 6px; }
        .target-amount-label { font-size: 9px; font-weight: 900; opacity: 0.8; text-align: right; margin-top: 2px; }

        .asset-header-row { display: grid; grid-template-columns: 20px 1.2fr 0.6fr 0.6fr 1fr 0.6fr 55px; gap: 4px; padding-bottom: 8px; border-bottom: 1px solid #EEE; margin-bottom: 5px; }
        .asset-header-row span { font-size: 9px; font-weight: 900; color: #BBB; text-align: center; }

        .asset-list { margin-bottom: 15px; min-height: 5px; }
        .asset-item { display: grid; grid-template-columns: 20px 1.2fr 0.6fr 0.6fr 1fr 0.6fr 55px; gap: 4px; margin-bottom: 12px; align-items: center; }
        .btn-delete-left { background: transparent; border: none; color: #FF4444; font-size: 18px; cursor: pointer; }

        .static-view { background: #1A1A1A; color: white; padding: 8px 2px; font-size: 9px; text-align: center; min-height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 900; cursor: pointer; border: 1px solid transparent; overflow: hidden; }
        .static-view.empty-placeholder { background: transparent !important; color: #CCC !important; border: none !important; font-weight: 400; }

        .asset-item div:nth-child(2) .static-view { background: #1A1A1A; color: white; }
        .asset-item div:nth-child(3) .static-view:not(.empty-placeholder), 
        .asset-item div:nth-child(4) .static-view:not(.empty-placeholder) { background: #EEE; color: #888; border: 1px solid #DDD; }
        .asset-item div:nth-child(5) .static-view { background: #F8F8F8; color: #1A1A1A; border: 1px solid #DDD; }
        .asset-item div:nth-child(6) .static-view { background: #666; color: white; }

        .edit-container { position: relative; display: none; width: 100%; }
        .edit-input { width: 100%; height: 38px; border: 2px solid #1A1A1A; border-radius: 6px; text-align: center; font-weight: bold; font-size: 12px; outline: none; }

        .card-footer { margin-top: 20px; padding-top: 15px; border-top: 2px dashed #DDD; }
        .footer-row { display: flex; justify-content: space-between; align-items: center; }
        .cat-sum-display { font-size: 1.1rem; font-weight: 900; }
        .status-tag { margin-top: 12px; padding: 10px; text-align: center; font-size: 0.8rem; border-radius: 8px; font-weight: 900; background: rgba(var(--theme-accent-rgb), 0.15); color: var(--theme-bg); border: 1px solid rgba(var(--theme-accent-rgb), 0.3); }

        .btn { background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; padding: 12px; font-weight: bold; width: 100%; border-radius: var(--radius); box-shadow: 4px 4px 0px #000; cursor: pointer; margin-bottom: 10px; font-size: 1rem; }
        .btn-reset { background: #ddd; color: #888; border-color: #bbb; margin-top: 20px; font-size: 0.8rem; }
        
        .collapsed .asset-list, .collapsed .asset-header-row, .collapsed .btn-add-asset { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>Portfolio Engine<br><small style="font-size: 0.6em;">è³‡ç”¢çµ„åˆè¨ˆç®—å™¨</small></h1>
    <div class="save-status"><div class="status-dot" id="saveDot"></div><span id="saveText">æ­£åœ¨è¼‰å…¥...</span></div>

    <div class="rebalance-panel">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="font-size: 0.8rem; font-weight: 900; color: #888;">Total Assets (TWD)</div>
            <div style="display:flex; gap:8px;">
                <button class="chart-btn" onclick="syncPrices()" id="syncBtn">ğŸ”„ åŒæ­¥å ±åƒ¹</button>
                <button class="chart-btn" onclick="toggleChart()">åœ–è¡¨</button>
            </div>
        </div>
        <div id="rebalanceSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 5px;">$0</div>
        <div id="target-sum-alert" style="display:none; color:red; font-size:12px; font-weight:bold;"></div>
        <div id="chartContainer" style="display:none; margin-top: 20px; height: 220px;"><canvas id="portfolioChart"></canvas></div>
    </div>

    <div id="mainGrid"></div>
    <button class="btn" onclick="addCategory()">+ æ–°å¢æŠ•è³‡å€åŸŸ</button>
    <button class="btn btn-reset" onclick="clearAll()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
</div>

<datalist id="stockList"></datalist>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxy9lgNdsTEW4fCpEmyYeAlAsYhQzHNlXfWFztXdx_W5Qn6vNBgNcRU-THXesDopY_k/exec";
    let usdRate = 32.5; // é è¨­åŒ¯ç‡
    let categories = [];
    let stockData = [];
    let myChart = null;

    function formatCurrency(num) { return "$" + Math.round(num || 0).toLocaleString(); }

    async function loadData() {
        try {
            const res = await fetch('csvjson.json');
            stockData = await res.json();
            const dl = document.getElementById('stockList');
            stockData.forEach(s => { const o = document.createElement('option'); o.value = s.s + ' ' + s.n; dl.appendChild(o); });
        } catch(e) { console.log("JSON Load fail"); }

        const saved = localStorage.getItem('myPortfolio_v5');
        const savedCats = localStorage.getItem('catConfig_v5');
        if (savedCats) {
            categories = JSON.parse(savedCats);
        } else {
            categories = [{id:'cat_1', name:'å°è‚¡'}, {id:'cat_2', name:'ç¾è‚¡'}];
        }
        renderUI(saved ? JSON.parse(saved) : {});
        document.getElementById('saveText').innerText = "è‡ªå‹•å„²å­˜ä¸­";
    }

    function renderUI(savedData) {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = '';
        categories.forEach(cat => {
            const data = savedData[cat.id] || { target: 50, assets: [], collapsed: false };
            const card = document.createElement('div');
            card.id = cat.id;
            card.className = `category-card ${data.collapsed ? 'collapsed' : ''}`;
            card.innerHTML = `
                <button class="btn-delete-card" onclick="deleteCategory('${cat.id}')">Ã—</button>
                <div class="category-header" onclick="toggleCategory('${cat.id}')">
                    <span style="font-weight:900;">${cat.name}</span>
                    <div onclick="event.stopPropagation()">
                        ç›®æ¨™ <input type="number" class="target-input" value="${data.target}" oninput="calculateAll()"> %
                        <div class="target-amount-label">$0</div>
                    </div>
                </div>
                <div class="asset-header-row"><span></span><span>åç¨±</span><span>è‚¡æ•¸</span><span>å–®åƒ¹</span><span>ç¾å€¼</span><span>ç›®æ¨™%</span><span></span></div>
                <div class="asset-list" id="list-${cat.id}"></div>
                <button class="btn btn-add-asset" onclick="addAsset('${cat.id}')">+ æ–°å¢æ¨™çš„</button>
                <div class="card-footer">
                    <div class="footer-row"><span style="font-size:0.75rem;">å€åŸŸåˆè¨ˆ</span><span class="cat-sum-display">$0</span><span class="current-p">0%</span></div>
                    <div class="status-tag status-alert">âœ… æ¯”ä¾‹ç†æƒ³</div>
                </div>
            `;
            grid.appendChild(card);
            if (data.assets && data.assets.length > 0) {
                data.assets.forEach(a => addAsset(cat.id, a.name, a.value, a.targetP, a.qty, a.price));
            } else { addAsset(cat.id); }
        });
        calculateAll();
    }

    function addAsset(catId, name='', value=0, targetP=0, qty='', price='') {
        const list = document.getElementById(`list-${catId}`);
        const div = document.createElement('div');
        div.className = 'asset-item';
        div.innerHTML = `
            <button class="btn-delete-left" onclick="this.closest('.asset-item').remove(); calculateAll();">Ã—</button>
            <div>
                <div class="static-view" onclick="editMode(this)">${name || 'åç¨±'}</div>
                <div class="edit-container"><input type="text" class="edit-input asset-name" list="stockList" value="${name}" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <div class="static-view ${(!qty || qty==0)?'empty-placeholder':''}" onclick="editMode(this)">${(!qty || qty==0)?'-':qty}</div>
                <div class="edit-container"><input type="number" class="edit-input asset-qty" value="${qty}" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <div class="static-view ${(!price || price==0)?'empty-placeholder':''}" onclick="editMode(this)">${(!price || price==0)?'-':price}</div>
                <div class="edit-container"><input type="number" class="edit-input asset-price" value="${price}" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <div class="static-view" onclick="editMode(this)">${formatCurrency(value)}</div>
                <div class="edit-container"><input type="number" class="edit-input asset-value" value="${value}" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <div class="static-view" onclick="editMode(this)">${targetP}%</div>
                <div class="edit-container"><input type="number" class="edit-input target-p-input" value="${targetP}" onblur="autoViewMode(this)"></div>
            </div>
            <div style="font-size:10px; text-align:right;"><div class="ratio-val">0%</div></div>
        `;
        list.appendChild(div);
    }

    function editMode(el) {
        el.style.display = 'none';
        const container = el.nextElementSibling;
        container.style.display = 'block';
        container.querySelector('input').focus();
    }

    function autoViewMode(inputEl) {
        const item = inputEl.closest('.asset-item');
        const view = inputEl.parentElement.previousElementSibling;

        if (inputEl.classList.contains('asset-name')) {
            let val = inputEl.value.trim().split(' ')[0];
            inputEl.value = val;
            const stock = stockData.find(s => s.s == val);
            if (stock && stock.p) {
                const pIn = item.querySelector('.asset-price');
                if(!pIn.value || pIn.value == 0) {
                    pIn.value = stock.p;
                    const pView = pIn.parentElement.previousElementSibling;
                    pView.innerText = stock.p; pView.classList.remove('empty-placeholder');
                }
            }
        }

        const name = item.querySelector('.asset-name').value;
        const q = parseFloat(item.querySelector('.asset-qty').value);
        const p = parseFloat(item.querySelector('.asset-price').value);
        const vIn = item.querySelector('.asset-value');

        if (!isNaN(q) && !isNaN(p) && q > 0 && p > 0) {
            vIn.value = /[a-zA-Z]/.test(name) ? Math.round(q * p * usdRate) : Math.round(q * p);
        }

        // è¦–è¦ºæ¸²æŸ“é‚è¼¯
        let val = inputEl.value;
        if (inputEl.type === 'number') {
            if (!val || val == 0) {
                if (inputEl.classList.contains('asset-qty') || inputEl.classList.contains('asset-price')) {
                    view.innerText = "-"; view.classList.add('empty-placeholder');
                } else { view.innerText = "$0"; view.classList.remove('empty-placeholder'); }
            } else {
                view.innerText = inputEl.classList.contains('asset-value') ? formatCurrency(val) : 
                                 inputEl.classList.contains('target-p-input') ? val+"%" : val;
                view.classList.remove('empty-placeholder');
            }
        } else { view.innerText = val || "åç¨±"; }

        inputEl.parentElement.style.display = 'none';
        view.style.display = 'flex';
        calculateAll();
    }

    async function syncPrices() {
        const btn = document.getElementById('syncBtn');
        let symbols = [];
        categories.forEach(cat => {
            document.querySelectorAll(`#list-${cat.id} .asset-name`).forEach(i => {
                const s = i.value.trim();
                if(s) symbols.push(/^[a-zA-Z]/.test(s) ? `NYSEARCA:${s}` : `TPE:${s}`);
            });
        });
        if(symbols.length === 0) return;
        btn.innerText = "â³...";
        try {
            const res = await fetch(`${GAS_URL}?symbols=${encodeURIComponent(symbols.join(','))}`);
            const data = await res.json();
            if(data["CURRENCY:USDTWD"]) usdRate = data["CURRENCY:USDTWD"];
            document.querySelectorAll('.asset-item').forEach(item => {
                const name = item.querySelector('.asset-name').value.trim();
                const key = /^[a-zA-Z]/.test(name) ? `NYSEARCA:${name}` : `TPE:${name}`;
                if(data[key]) {
                    const pIn = item.querySelector('.asset-price');
                    pIn.value = data[key];
                    autoViewMode(pIn);
                }
            });
            alert("åŒæ­¥å®Œæˆï¼åŒ¯ç‡ï¼š" + usdRate);
        } catch(e) { alert("åŒæ­¥å¤±æ•—"); }
        btn.innerText = "ğŸ”„ åŒæ­¥å ±åƒ¹";
        calculateAll();
    }

    function calculateAll() {
        let total = 0, catSums = {};
        categories.forEach(cat => {
            let sum = 0;
            const card = document.getElementById(cat.id);
            if(!card) return;
            card.querySelectorAll('.asset-value').forEach(v => sum += parseFloat(v.value)||0);
            catSums[cat.id] = sum;
            total += sum;
        });

        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if(!card) return;
            const target = parseFloat(card.querySelector('.target-input').value)||0;
            const targetAmt = total * (target/100);
            card.querySelector('.target-amount-label').innerText = formatCurrency(targetAmt);
            card.querySelector('.cat-sum-display').innerText = formatCurrency(catSums[cat.id]);
            const p = total > 0 ? (catSums[cat.id]/total*100).toFixed(1) : 0;
            card.querySelector('.current-p').innerText = p + "%";
            
            const diff = catSums[cat.id] - targetAmt;
            const tag = card.querySelector('.status-alert');
            tag.innerHTML = total === 0 ? "è«‹è¼¸å…¥è³‡æ–™" : (Math.abs(p-target)<1 ? "âœ… æ¯”ä¾‹ç†æƒ³" : 
                (diff > 0 ? `âš ï¸ å»ºè­°ç§»å‡º ${formatCurrency(diff)}` : `âš ï¸ å»ºè­°è£œå…¥ ${formatCurrency(Math.abs(diff))}`));
        });

        document.getElementById('rebalanceSummary').innerText = formatCurrency(total);
        forceSave();
    }

    function forceSave() {
        const data = {};
        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if(!card) return;
            const assets = [];
            card.querySelectorAll('.asset-item').forEach(item => {
                assets.push({
                    name: item.querySelector('.asset-name').value,
                    qty: item.querySelector('.asset-qty').value,
                    price: item.querySelector('.asset-price').value,
                    value: item.querySelector('.asset-value').value,
                    targetP: item.querySelector('.target-p-input').value
                });
            });
            data[cat.id] = { target: card.querySelector('.target-input').value, collapsed: card.classList.contains('collapsed'), assets };
        });
        localStorage.setItem('myPortfolio_v5', JSON.stringify(data));
        localStorage.setItem('catConfig_v5', JSON.stringify(categories));
    }

    function toggleCategory(id) { document.getElementById(id).classList.toggle('collapsed'); forceSave(); }
    function deleteCategory(id) { if(confirm('åˆªé™¤ï¼Ÿ')) { categories = categories.filter(c=>c.id!==id); renderUI({}); forceSave(); } }
    function addCategory() { categories.push({id:'cat_'+Date.now(), name:'æ–°å€åŸŸ'}); renderUI({}); }
    function clearAll() { if(confirm('é‡ç½®ï¼Ÿ')) { localStorage.clear(); location.reload(); } }
    function toggleChart() { const c = document.getElementById('chartContainer'); c.style.display = c.style.display==='none'?'block':'none'; }

    window.onload = loadData;
</script>
</body>
</html>
