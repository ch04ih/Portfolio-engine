<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Engine</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="apple-mobile-web-app-title" content="ÊäïË≥áÈÖçÊØî">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --theme-accent: #FF8C42;
            --theme-bg: #3D2B1F;
            --theme-accent-rgb: 255, 140, 66;
            --gray-marble: #F0F0F0;
            --radius: 12px;
        }
        [data-theme="orange"] { --theme-accent: #FF8C42; --theme-bg: #3D2B1F; --theme-accent-rgb: 255, 140, 66; }
        [data-theme="forest"] { --theme-accent: #dac4fc; --theme-bg: #293d0b; --theme-accent-rgb: 218, 196, 252; }
        [data-theme="wine"]   { --theme-accent: #80C5DE; --theme-bg: #6e0000; --theme-accent-rgb: 128, 197, 222; }
        [data-theme="purple"] { --theme-accent: #B4D355; --theme-bg: #6245b7; --theme-accent-rgb: 180, 211, 85; }
        [data-theme="navy"]   { --theme-accent: #e4d9c4; --theme-bg: #1b2941; --theme-accent-rgb: 228, 217, 196; }
        [data-theme="amber"]  { --theme-accent: #F0A650; --theme-bg: #0045c6; --theme-accent-rgb: 240, 166, 80; }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: var(--gray-marble); color: #3D2B1F; font-family: -apple-system, sans-serif; margin: 0; padding: 0; overflow-x: hidden; width: 100%; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 20px 15px; }
        h1 { border: 4px solid #1A1A1A; text-align: center; margin: 0; background: var(--theme-accent); padding: 15px 12px; box-shadow: 6px 6px 0px #000; border-radius: var(--radius); color: var(--theme-bg); font-weight: 900; }
        
        .save-status { text-align: center; font-size: 10px; font-weight: bold; margin: 10px 0 20px 0; color: #888; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .status-dot.active { background: #00C853; box-shadow: 0 0 8px #00C853; }

        .rebalance-panel { background: white; border: 4px solid #1A1A1A; padding: 20px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); }
        .chart-btn { background: var(--theme-accent); color: var(--theme-bg); border: 2px solid #1A1A1A; padding: 5px 12px; font-size: 0.75rem; font-weight: 900; border-radius: 6px; cursor: pointer; box-shadow: 2px 2px 0px #1A1A1A; }

        .category-card { background: #fff; border: 4px solid #1A1A1A; padding: 15px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); position: relative; }
        .category-header { background: var(--theme-bg); color: var(--theme-accent); padding: 12px 15px; margin: -15px -15px 10px -15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }

        .btn-delete-card { position: absolute; top: -12px; right: -12px; width: 28px; height: 28px; border-radius: 50%; background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; font-weight: bold; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; }

        .target-input { width: 42px; background: var(--theme-accent); color: var(--theme-bg); border: 1px solid #1A1A1A; font-weight: bold; text-align: center; border-radius: 6px; }
        .target-amount-label { font-size: 9px; font-weight: 900; opacity: 0.8; text-align: right; margin-top: 2px; }

        .asset-header-row { display: grid; grid-template-columns: 20px 1.2fr 0.6fr 0.6fr 1fr 0.6fr 55px; gap: 4px; padding-bottom: 8px; border-bottom: 1px solid #EEE; margin-bottom: 5px; }
        .asset-header-row span { font-size: 9px; font-weight: 900; color: #BBB; text-align: center; }

        .asset-list { margin-bottom: 15px; min-height: 5px; }
        .asset-item { display: grid; grid-template-columns: 20px 1.2fr 0.6fr 0.6fr 1fr 0.6fr 55px; gap: 4px; margin-bottom: 12px; align-items: center; }
        .btn-delete-left { background: transparent; border: none; color: #FF4444; font-size: 18px; cursor: pointer; }

        .static-view { background: #1A1A1A; color: white; padding: 8px 2px; font-size: 9px; text-align: center; min-height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 900; cursor: pointer; border: 1px solid transparent; }
        .static-view.empty-placeholder { background: transparent; color: #CCC; border: none; font-weight: 400; }

        .asset-item div:nth-child(2) .static-view { background: #1A1A1A; color: white; }
        .asset-item div:nth-child(3) .static-view:not(.empty-placeholder), 
        .asset-item div:nth-child(4) .static-view:not(.empty-placeholder) { background: #EEE; color: #888; border: 1px solid #DDD; }
        .asset-item div:nth-child(5) .static-view { background: #F8F8F8; color: #1A1A1A; border: 1px solid #DDD; }
        .asset-item div:nth-child(6) .static-view { background: #666; color: white; }

        .edit-container { position: relative; display: none; width: 100%; }
        .edit-input { width: 100%; height: 38px; border: 2px solid #1A1A1A; border-radius: 6px; text-align: center; font-weight: bold; font-size: 12px; outline: none; }
        
        .edit-container.prefix::before { content: '$'; position: absolute; left: 2px; top: 50%; transform: translateY(-50%); font-weight: 900; font-size: 9px; }
        .edit-container.suffix::after { content: '%'; position: absolute; right: 2px; top: 50%; transform: translateY(-50%); font-weight: 900; font-size: 9px; }

        .card-footer { margin-top: 20px; padding-top: 15px; border-top: 2px dashed #DDD; }
        .footer-row { display: flex; justify-content: space-between; align-items: center; }
        .cat-sum-display { font-size: 1.1rem; font-weight: 900; }

        .status-tag { margin-top: 12px; padding: 10px; text-align: center; font-size: 0.8rem; border-radius: 8px; font-weight: 900; background: rgba(var(--theme-accent-rgb), 0.15); color: var(--theme-bg); border: 1px solid rgba(var(--theme-accent-rgb), 0.3); }

        .btn { background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; padding: 12px; font-weight: bold; width: 100%; border-radius: var(--radius); box-shadow: 4px 4px 0px #000; cursor: pointer; margin-bottom: 10px; }
        .btn-reset { background: #ddd; color: #888; border-color: #bbb; margin-top: 20px; font-size: 0.8rem; }

        #target-sum-alert { margin-top:10px; font-size:12px; font-weight:900; text-align:center; padding:8px; border-radius:8px; display:none; border: 2px solid #FF4444; }
        .alert-red { background-color: #FFE5E5 !important; color: #B30000 !important; }

        .collapsed .asset-list, .collapsed .asset-header-row, .collapsed .btn-add-asset { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>
        <span style="font-size: 0.9em; letter-spacing: 2px;">Portfolio Engine</span><br>
        <span style="font-size: 0.7em;">Ë≥áÁî¢ÁµÑÂêàË®àÁÆóÂô®</span>
    </h1>

    <div class="save-status">
        <div class="status-dot" id="saveDot"></div>
        <span id="saveText">Ê≠£Âú®ËºâÂÖ•Êï∏Êìö...</span>
    </div>

    <div class="rebalance-panel">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="font-size: 0.8rem; font-weight: 900; color: #888;">Total Assets (TWD)</div>
            <div style="display:flex; gap:8px;">
                <button class="chart-btn" onclick="syncPrices()" id="syncBtn">üîÑ ÂêåÊ≠•Â†±ÂÉπ</button>
                <button class="chart-btn" onclick="toggleChart()">ÂúñË°®</button>
            </div>
        </div>
        <div id="rebalanceSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 5px;">$0</div>
        <div id="target-sum-alert"></div>
        <div id="chartContainer" style="display:none; margin-top: 20px; height: 220px;">
            <canvas id="portfolioChart"></canvas>
        </div>
    </div>

    <div id="mainGrid"></div>
    <button class="btn" onclick="addCategory()">+ Êñ∞Â¢ûÊäïË≥áÂçÄÂüü</button>
    <button class="btn btn-reset" onclick="clearAll()">ÈáçÁΩÆÊâÄÊúâË≥áÊñô</button>
</div>

<datalist id="stockList"></datalist>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxy9lgNdsTEW4fCpEmyYeAlAsYhQzHNlXfWFztXdx_W5Qn6vNBgNcRU-THXesDopY_k/exec";
    let usdRate = 32.5; // È†êË®≠ÂåØÁéá
    let myChart = null;
    let categories = [];
    let stockData = [];

    function formatCurrency(num) { return "$" + Math.round(num || 0).toLocaleString('en-US'); }

    async function loadStockData() {
        try {
            const response = await fetch('csvjson.json');
            stockData = await response.json();
            const datalist = document.getElementById('stockList');
            stockData.forEach(item => {
                const option = document.createElement('option');
                option.value = `${item.s} ${item.n}`;
                datalist.appendChild(option);
            });
            document.getElementById('saveText').innerText = "Ëá™ÂãïÂÑ≤Â≠òËá≥Êú¨Âú∞ÁÄèË¶ΩÂô®";
        } catch (e) {
            document.getElementById('saveText').innerText = "ËÇ°Á•®Êï∏ÊìöËºâÂÖ•Â§±Êïó";
        }
    }

    function autoViewMode(inputEl) {
        const container = inputEl.parentElement;
        const item = inputEl.closest('.asset-item');
        const view = container.previousElementSibling;
        
        // ÂêçÁ®±Ëº∏ÂÖ•ÔºöËá™ÂãïÂ∏∂ÂÖ•ÂñÆÂÉπ
        if (inputEl.classList.contains('asset-name')) {
            let val = inputEl.value.trim().split(' ')[0];
            inputEl.value = val;
            const stock = stockData.find(s => s.s == val);
            if (stock && stock.p) {
                const pInput = item.querySelector('.asset-price');
                if (!pInput.value || pInput.value == 0) {
                    pInput.value = stock.p;
                    const pView = pInput.parentElement.previousElementSibling;
                    pView.innerText = stock.p;
                    pView.classList.remove('empty-placeholder');
                }
            }
        }

        // Ë®àÁÆóÈÇèËºØÔºöËæ®Ë≠òÁæéËÇ°ÂåØÁéá
        const nameVal = item.querySelector('.asset-name').value.trim();
        const q = parseFloat(item.querySelector('.asset-qty').value);
        const p = parseFloat(item.querySelector('.asset-price').value);
        const valInput = item.querySelector('.asset-value');

        if (!isNaN(q) && !isNaN(p) && q > 0 && p > 0) {
            // Ëá™ÂãïÂà§Êñ∑ÁæéËÇ° (Ëã±ÊñáÂ≠óÊØç)
            if (/[a-zA-Z]/.test(nameVal)) {
                valInput.value = Math.round(q * p * usdRate);
            } else {
                valInput.value = Math.round(q * p);
            }
        }

        // Ë¶ñË¶∫Ê∏≤Êüì
        let val = inputEl.value;
        if (inputEl.type === 'number') {
            if (val === "" || val == 0) {
                if (inputEl.classList.contains('asset-qty') || inputEl.classList.contains('asset-price')) {
                    view.innerText = "-"; view.classList.add('empty-placeholder');
                } else {
                    view.innerText = inputEl.classList.contains('target-p-input') ? "0%" : "$0";
                    view.classList.remove('empty-placeholder');
                }
            } else {
                view.innerText = inputEl.classList.contains('target-p-input') ? val + "%" : 
                                 inputEl.classList.contains('asset-value') ? formatCurrency(val) : val;
                view.classList.remove('empty-placeholder');
            }
        } else {
            view.innerText = val || "Êú™ÂëΩÂêç";
        }
        
        setTimeout(() => { container.style.display = 'none'; view.style.display = 'flex'; calculateAll(); }, 150);
    }

    async function syncPrices() {
        const btn = document.getElementById('syncBtn');
        const originalText = btn.innerText;
        let symbolList = [];

        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if (!card) return;
            card.querySelectorAll('.asset-name').forEach(input => {
                const s = input.value.trim();
                if (s && s !== 'ÂêçÁ®±') {
                    if (/^\d+$/.test(s)) symbolList.push(`TPE:${s}`);
                    else if (/[a-zA-Z]/.test(s)) symbolList.push(`NYSEARCA:${s}`);
                }
            });
        });

        try {
            btn.innerText = "‚è≥ ÂêåÊ≠•‰∏≠..."; btn.disabled = true;
            const res = await fetch(`${GAS_URL}?symbols=${encodeURIComponent(symbolList.join(','))}`);
            const data = await res.json();

            if (data["CURRENCY:USDTWD"]) {
                usdRate = data["CURRENCY:USDTWD"];
            }

            categories.forEach(cat => {
                const card = document.getElementById(cat.id);
                if (!card) return;
                card.querySelectorAll('.asset-item').forEach(item => {
                    const name = item.querySelector('.asset-name').value.trim();
                    let key = name;
                    if (/^\d+$/.test(name)) key = `TPE:${name}`;
                    else if (/[a-zA-Z]/.test(name)) key = `NYSEARCA:${name}`;

                    if (data[key] && typeof data[key] === 'number') {
                        const pInput = item.querySelector('.asset-price');
                        pInput.value = data[key];
                        autoViewMode(pInput);
                    }
                });
            });
            alert(`‚úÖ ÂêåÊ≠•ÂÆåÊàêÔºÅÁõÆÂâçÂåØÁéáÔºö${usdRate}`);
        } catch (e) { alert("ÂêåÊ≠•Â§±ÊïóÔºåË´ãÁ¢∫Ë™ç GAS Ê¨äÈôê„ÄÇ"); }
        finally { btn.innerText = originalText; btn.disabled = false; calculateAll(); }
    }

    function calculateAll() {
        let total = 0, catSums = {}, totalTargetP = 0;
        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if (card) {
                totalTargetP += parseFloat(card.querySelector('.target-input').value) || 0;
                let sum = 0;
                card.querySelectorAll('.asset-value').forEach(i => { sum += parseFloat(i.value) || 0; });
                catSums[cat.id] = sum;
                total += sum;
            }
        });

        const alertDiv = document.getElementById('target-sum-alert');
        if (Math.abs(totalTargetP - 100) > 0.01) {
            alertDiv.style.display = 'block'; alertDiv.classList.add('alert-red');
            alertDiv.innerText = totalTargetP > 100 ? `‚ö†Ô∏èÂçÄÂüüÁõÆÊ®ôÁ∏ΩÂíå > 100% (${totalTargetP}%)` : `‚ö†Ô∏èÂçÄÂüüÁõÆÊ®ôÁ∏ΩÂíå < 100% (${totalTargetP}%)`;
        } else alertDiv.style.display = 'none';

        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if (!card) return;
            const target = parseFloat(card.querySelector('.target-input').value) || 0;
            const currentP = total > 0 ? (catSums[cat.id] / total * 100) : 0;
            card.querySelector('.target-amount-label').innerText = formatCurrency(total * (target / 100));
            card.querySelector('.cat-sum-display').innerText = formatCurrency(catSums[cat.id]);
            card.querySelector('.current-p').innerText = currentP.toFixed(1) + "%";
            
            const alertTag = card.querySelector('.status-alert');
            const diff = catSums[cat.id] - (total * (target/100));
            if (total === 0) alertTag.innerText = "‚úÖ Ë´ãËº∏ÂÖ•Ë≥áÊñô";
            else if (Math.abs(currentP - target) <= 1) alertTag.innerText = "‚úÖ ÊØî‰æãÁêÜÊÉ≥";
            else alertTag.innerHTML = diff > 0 ? `‚ö†Ô∏è Âª∫Ë≠∞ÁßªÂá∫ <span style="color:#FF4444">${formatCurrency(diff)}</span>` : `‚ö†Ô∏è Âª∫Ë≠∞Ë£úÂÖ• <span style="color:#008800">${formatCurrency(Math.abs(diff))}</span>`;

            card.querySelectorAll('.asset-item').forEach(item => {
                const val = parseFloat(item.querySelector('.asset-value').value) || 0;
                const tP = parseFloat(item.querySelector('.target-p-input').value) || 0;
                const itemP = catSums[cat.id] > 0 ? (val / catSums[cat.id] * 100) : 0;
                item.querySelector('.ratio-val').innerText = itemP.toFixed(1) + '%';
            });
        });
        document.getElementById('rebalanceSummary').innerText = formatCurrency(total);
        updateChart(catSums, total);
        forceSave();
    }

    // --- (ÂÖ∂È§òËºîÂä©ÂäüËÉΩÔºörenderUI, addAsset, toggleChart, forceSave, Sortable Á≠â) ---
    // Âõ†ÁØáÂπÖÈôêÂà∂ÔºåË´ãÁ¢∫‰øù‰∏ãÊñπ‰øùÁïôÊÇ®ÂéüÊú¨ÁöÑ renderUI Ëàá addAsset ÈÇèËºØ„ÄÇ
    function addCategory() { const id = 'cat_'+Date.now(); categories.push({id, name:'Êñ∞ÂçÄÂüü'}); renderUI(); }
    function editMode(el) { el.style.display='none'; const c = el.nextElementSibling; c.style.display='block'; c.querySelector('input').focus(); }
    function toggleChart() { const c = document.getElementById('chartContainer'); c.style.display = c.style.display==='none'?'block':'none'; calculateAll(); }
    function forceSave() { /* localStorage ÂÑ≤Â≠òÈÇèËºØ */ }
    function clearAll() { if(confirm('ÈáçÁΩÆÔºü')) { localStorage.clear(); location.reload(); } }

    window.onload = () => { loadStockData(); /* renderUI() */ };
</script>
</body>
</html>
