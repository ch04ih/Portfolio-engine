<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å†å¹³è¡¡æŠ•è³‡çµ„åˆè¨ˆç®—å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS å…§å®¹ */
        :root {
            --theme-accent: #FF8C42;
            --theme-bg: #3D2B1F;
            --theme-accent-rgb: 255, 140, 66;
            --gray-marble: #F0F0F0;
            --radius: 12px;
        }

        [data-theme="orange"] { --theme-accent: #FF8C42; --theme-bg: #3D2B1F; --theme-accent-rgb: 255, 140, 66; }
        [data-theme="forest"] { --theme-accent: #dac4fc; --theme-bg: #293d0b; --theme-accent-rgb: 218, 196, 252; }
        [data-theme="wine"]   { --theme-accent: #80C5DE; --theme-bg: #6e0000; --theme-accent-rgb: 128, 197, 222; }
        [data-theme="purple"] { --theme-accent: #B4D355; --theme-bg: #6245b7; --theme-accent-rgb: 180, 211, 85; }
        [data-theme="navy"]   { --theme-accent: #e4d9c4; --theme-bg: #1b2941; --theme-accent-rgb: 228, 217, 196; }
        [data-theme="amber"]  { --theme-accent: #F0A650; --theme-bg: #0045c6; --theme-accent-rgb: 240, 166, 80; }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none !important; margin: 0 !important; }

        html, body { background-color: var(--gray-marble); color: #3D2B1F; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 24px 18px; }

        h1 { text-transform: uppercase; font-size: 1.4rem; border: 4px solid #1A1A1A; text-align: center; margin-bottom: 25px; background: var(--theme-accent); padding: 12px; box-shadow: 6px 6px 0px #000; border-radius: var(--radius); color: var(--theme-bg); }

        .rebalance-panel { background: white; border: 4px solid #1A1A1A; padding: 20px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); }

        .category-card { background: #fff; border: 4px solid #1A1A1A; padding: 15px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); position: relative; }
        .category-header { background: var(--theme-bg); color: var(--theme-accent); padding: 15px; margin: -15px -15px 15px -15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-radius: 8px 8px 0 0; }

        .btn-delete-card { position: absolute; top: -12px; right: -12px; width: 28px; height: 28px; border-radius: 50%; background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 0px #000; z-index: 10; display: flex; align-items: center; justify-content: center; }

        .category-title-wrap { display: flex; align-items: center; gap: 8px; flex-grow: 1; }
        .target-input { width: 45px; background: var(--theme-accent); color: var(--theme-bg); border: 1px solid #1A1A1A; font-weight: bold; text-align: center; border-radius: 6px; padding: 2px; margin: 0 5px; }

        .asset-list { margin-bottom: 15px; }
        .asset-item { display: grid; grid-template-columns: 25px 1.1fr 0.8fr 1.3fr 55px; gap: 6px; margin-bottom: 12px; align-items: center; }
        .btn-delete-left { background: transparent; border: none; color: #FF4444; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .static-view { background: #1A1A1A; color: white; padding: 8px; font-size: 11px; text-align: center; min-height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 900; }
        .asset-item div:nth-child(4) .static-view { background: #F8F8F8; color: #1A1A1A; border: 1px solid #DDD; font-size: 10px; }

        .edit-container { position: relative; display: none; width: 100%; }
        .edit-input { width: 100%; height: 38px; border: 2px solid #1A1A1A; border-radius: 6px; text-align: center; font-weight: bold; }
        .edit-container.prefix::before { content: '$'; position: absolute; left: 6px; top: 50%; transform: translateY(-50%); font-weight: bold; font-size: 11px; z-index: 2; }
        .edit-container.suffix::after { content: '%'; position: absolute; right: 6px; top: 50%; transform: translateY(-50%); font-weight: bold; font-size: 11px; z-index: 2; }

        .input-error { border: 2px solid #FF4444 !important; animation: shake 0.2s ease-in-out 2; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

        .card-footer { margin-top: 20px; padding-top: 15px; border-top: 2px dashed #DDD; display: block; }
        .footer-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .cat-sum-display { flex-grow: 1; text-align: center; font-size: 1.1rem; font-weight: 900; }
        .footer-label, .current-p { font-size: 0.75rem; font-weight: 900; width: 60px; }
        .current-p { text-align: right; }

        .status-tag { margin-top: 12px; padding: 10px; text-align: center; font-size: 0.8rem; border-radius: 8px; font-weight: 900; background: rgba(var(--theme-accent-rgb), 0.15) !important; color: var(--theme-bg) !important; border: 1px solid rgba(var(--theme-accent-rgb), 0.3); }

        .btn { background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; padding: 12px; font-weight: bold; width: 100%; border-radius: var(--radius); box-shadow: 4px 4px 0px #000; cursor: pointer; }
        .btn-reset { background: #ddd; color: #888; border-color: #bbb; margin: 20px 0; box-shadow: 3px 3px 0px #999; font-size: 0.8rem; }
        .chart-btn { background: var(--theme-accent); color: var(--theme-bg); border: 2px solid #1A1A1A; padding: 5px 12px; font-size: 0.7rem; font-weight: 900; border-radius: 6px; cursor: pointer; box-shadow: 2px 2px 0px #1A1A1A; }

        .theme-panel { display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 12px; }
        .theme-toggle-icon { font-size: 0.75rem; font-weight: bold; cursor: pointer; background: white; padding: 5px 12px; border: 2px solid #1A1A1A; border-radius: 20px; box-shadow: 2px 2px 0px #000; }
        .theme-options { display: none; gap: 10px; margin-top: 10px; background: white; padding: 10px; border: 2px solid #1A1A1A; border-radius: 12px; box-shadow: 4px 4px 0px #000; z-index: 100; }
        .theme-panel.active .theme-options { display: flex; }
        .theme-options button { width: 24px !important; height: 24px !important; border-radius: 50% !important; border: 2px solid #fff !important; cursor: pointer; padding: 0 !important; box-shadow: none !important; }

        .collapsed .asset-list, 
        .collapsed .category-card > .btn { 
            display: none; 
        }
        .collapsed .card-footer { display: block; margin-top: 10px; }

        .chevron { transition: 0.3s; font-size: 0.8rem; }
        .collapsed .chevron { transform: rotate(-90deg); }
    </style>
</head>
<body>

<div class="container">
    <div class="theme-panel" id="themePanel">
        <div class="theme-toggle-icon" onclick="toggleThemePanel()">ğŸ¨ ä¸»é¡Œé…è‰²</div>
        <div class="theme-options">
            <button style="background: #FF8C42" onclick="setTheme('orange')"></button>
            <button style="background: #293d0b" onclick="setTheme('forest')"></button>
            <button style="background: #6e0000" onclick="setTheme('wine')"></button>
            <button style="background: #6245b7" onclick="setTheme('purple')"></button>
            <button style="background: #1b2941" onclick="setTheme('navy')"></button>
            <button style="background: #0045c6" onclick="setTheme('amber')"></button>
        </div>
    </div>

    <h1>Portfolio Rebalance</h1>

    <div class="rebalance-panel">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="font-size: 0.8rem; font-weight: 900; color: #888;">ç¸½è³‡ç”¢ç¾å€¼</div>
            <button class="chart-btn" onclick="toggleChart()">ğŸ“Š æ¯”ä¾‹åœ–è¡¨</button>
        </div>
        <div id="rebalanceSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 5px;">$0</div>
        
        <div id="chartContainer" style="display:none; margin-top: 20px; height: 220px;">
            <canvas id="portfolioChart"></canvas>
        </div>
    </div>

    <div class="grid"></div>

    <button class="btn" style="margin-top: 10px;" onclick="addCategory()">+ æ–°å¢æŠ•è³‡å€åŸŸ</button>
    <button class="btn btn-reset" onclick="clearAll()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
</div>

<script>
    /* JavaScript å…§å®¹ */
    let categories = JSON.parse(localStorage.getItem('catConfig')) || [
        { id: 'cat_1', name: 'æˆé•·å‹æŠ•è³‡' },
        { id: 'cat_2', name: 'é˜²å®ˆå‹æŠ•è³‡' },
        { id: 'cat_3', name: 'é«˜è‚¡æ¯æŠ•è³‡' },
        { id: 'cat_4', name: 'å®‰å…¨å­˜æ¬¾' }
    ];
    let myChart = null;

    function formatCurrency(num) { return "$" + Math.round(num || 0).toLocaleString('en-US'); }

    function setTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('userTheme', themeName);
        const panel = document.getElementById('themePanel');
        if (panel) panel.classList.remove('active');
        calculateAll();
    }

    function toggleThemePanel() { const panel = document.getElementById('themePanel'); if (panel) panel.classList.toggle('active'); }

    function addCategory() {
        const newId = 'cat_' + Date.now();
        categories.push({ id: newId, name: 'æ–°æŠ•è³‡å€åŸŸ' });
        saveCatConfig();
        init();
    }

    function deleteCategory(id) {
        event.stopPropagation();
        if (confirm('ç¢ºå®šè¦åˆªé™¤æ•´å€‹å€åŸŸå—ï¼Ÿ')) {
            categories = categories.filter(c => c.id !== id);
            saveCatConfig();
            const savedData = JSON.parse(localStorage.getItem('myPortfolio')) || {};
            delete savedData[id];
            localStorage.setItem('myPortfolio', JSON.stringify(savedData));
            init();
        }
    }

    function editCatName(id, el) {
        event.stopPropagation();
        const currentName = el.innerText;
        const input = document.createElement('input');
        input.style.cssText = `background: rgba(255, 255, 255, 0.2); border: 1px solid var(--theme-accent); color: white; font-size: 1rem; font-weight: bold; width: 140px; border-radius: 4px; padding: 2px 8px; outline: none;`;
        input.value = currentName;
        el.style.display = 'none';
        el.parentElement.insertBefore(input, el);
        input.focus();
        input.select();
        const finishEdit = () => {
            const newName = input.value.trim() || currentName;
            el.innerText = newName;
            input.remove();
            el.style.display = 'inline';
            const cat = categories.find(c => c.id === id);
            if (cat) cat.name = newName;
            saveCatConfig();
            calculateAll();
        };
        input.onblur = finishEdit;
        input.onkeydown = (e) => { if (e.key === 'Enter') finishEdit(); };
        input.onclick = (e) => e.stopPropagation();
    }

    function saveCatConfig() { localStorage.setItem('catConfig', JSON.stringify(categories)); }

    function editMode(el) {
        const container = el.nextElementSibling;
        el.style.display = 'none';
        container.style.display = 'block';
        const input = container.querySelector('input');
        if (input) { input.classList.remove('input-error'); input.focus(); if (input.type === 'number') input.select(); }
    }

    function autoViewMode(inputEl) {
        if (inputEl.type === 'number') {
            const val = inputEl.value;
            if (val === "" || isNaN(val) || parseFloat(val) < 0) {
                inputEl.classList.add('input-error');
                return; 
            } else {
                inputEl.classList.remove('input-error');
            }
        }
        setTimeout(() => {
            const container = inputEl.parentElement;
            const view = container.previousElementSibling;
            if (!container || !view || inputEl.classList.contains('input-error')) return;
            container.style.display = 'none';
            view.style.display = 'flex';
            const val = inputEl.value;
            if (inputEl.classList.contains('asset-value')) view.innerText = val > 0 ? formatCurrency(val) : "$0";
            else if (inputEl.classList.contains('target-p-input')) view.innerText = val > 0 ? (val + "%") : "ç›®æ¨™%";
            else view.innerText = val || "åç¨±";
            calculateAll();
        }, 150);
    }

    function init() {
        const savedTheme = localStorage.getItem('userTheme') || 'orange';
        setTheme(savedTheme);
        const savedData = JSON.parse(localStorage.getItem('myPortfolio')) || {};
        const grid = document.querySelector('.grid');
        if (!grid) return;
        grid.innerHTML = '';

        categories.forEach(cat => {
            const data = savedData[cat.id] || { target: 25, assets: [], collapsed: false };
            const card = document.createElement('div');
            card.id = cat.id;
            card.className = `category-card ${data.collapsed ? 'collapsed' : ''}`;
            card.innerHTML = `
                <button class="btn-delete-card" onclick="deleteCategory('${cat.id}')">Ã—</button>
                <div class="category-header" onclick="toggleCategory('${cat.id}')">
                    <div class="category-title-wrap">
                        <span class="chevron">â–¼</span> 
                        <span class="cat-name-text" onclick="editCatName('${cat.id}', this)">${cat.name}</span>
                    </div>
                    <div onclick="event.stopPropagation()" style="display:flex; align-items:center;">
                        ç›®æ¨™ <input type="number" min="0" class="target-input" value="${data.target}" oninput="calculateAll()"> %
                    </div>
                </div>
                <div class="asset-list" id="list-${cat.id}"></div>
                <button class="btn" onclick="addAsset('${cat.id}')">+ æ–°å¢æ¨™çš„</button>
                <div class="card-footer">
                    <div class="footer-row">
                        <span class="footer-label">å€åŸŸåˆè¨ˆ</span>
                        <span class="cat-sum-display">$0</span>
                        <span class="current-p">0%</span>
                    </div>
                    <div class="status-tag status-alert">âœ… æ¯”ä¾‹ç†æƒ³</div>
                </div>
            `;
            grid.appendChild(card);
            if (data.assets && data.assets.length > 0) data.assets.forEach(a => addAsset(cat.id, a.name, a.value, a.targetP));
            else addAsset(cat.id);
        });
        
        const panel = document.querySelector('.rebalance-panel');
        if (panel && !document.getElementById('target-sum-alert')) {
            const alertDiv = document.createElement('div');
            alertDiv.id = 'target-sum-alert';
            alertDiv.style.cssText = "margin-top:10px; font-size:12px; font-weight:bold; text-align:center; padding:5px; border-radius:6px; display:none;";
            panel.appendChild(alertDiv);
        }
        calculateAll();
    }

    function addAsset(catId, name = '', value = 0, targetP = 0) {
        const list = document.getElementById(`list-${catId}`);
        if (!list) return;
        const div = document.createElement('div');
        div.className = 'asset-item';
        div.innerHTML = `
            <button class="btn-delete-left" onclick="this.closest('.asset-item').remove(); calculateAll();">Ã—</button>
            <div>
                <div class="static-view" onclick="editMode(this)">${name || 'åç¨±'}</div>
                <div class="edit-container"><input type="text" class="edit-input asset-name" value="${name}" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <div class="static-view" style="background:#666;" onclick="editMode(this)">${targetP > 0 ? targetP + '%' : 'ç›®æ¨™%'}</div>
                <div class="edit-container suffix"><input type="number" min="0" class="edit-input target-p-input" value="${targetP}" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <div class="static-view" onclick="editMode(this)">${value > 0 ? formatCurrency(value) : '$0'}</div>
                <div class="edit-container prefix"><input type="number" min="0" class="edit-input asset-value" value="${value}" onblur="autoViewMode(this)"></div>
            </div>
            <div class="asset-ratio-tag"><div class="ratio-val" style="font-size:10px; font-weight:bold;">0%</div><div class="diff-suggestion" style="font-size:9px;"></div></div>
        `;
        list.appendChild(div);
    }

    function calculateAll() {
        let total = 0, catSums = {}, totalTargetP = 0;
        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if (card) {
                const rawTarget = parseFloat(card.querySelector('.target-input').value) || 0;
                totalTargetP += Math.max(0, rawTarget);
                let sum = 0;
                const list = document.getElementById(`list-${cat.id}`);
                if (list) list.querySelectorAll('.asset-value').forEach(i => { sum += Math.max(0, parseFloat(i.value) || 0); });
                catSums[cat.id] = sum; total += sum;
            }
        });

        const sumAlert = document.getElementById('target-sum-alert');
        if (sumAlert) {
            if (Math.abs(totalTargetP - 100) > 0.01) {
                sumAlert.style.display = 'block'; sumAlert.style.background = '#FFE5E5'; sumAlert.style.color = '#D00000';
                sumAlert.innerText = `âš ï¸ å€åŸŸç›®æ¨™ç¸½å’Œç‚º ${totalTargetP.toFixed(0)}% (æ‡‰ç‚º 100%)`;
            } else { sumAlert.style.display = 'none'; }
        }

        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if (!card) return;
            const target = Math.max(0, parseFloat(card.querySelector('.target-input').value) || 0);
            const currentP = total > 0 ? (catSums[cat.id] / total * 100) : 0;
            card.querySelector('.cat-sum-display').innerText = formatCurrency(catSums[cat.id]);
            card.querySelector('.current-p').innerText = currentP.toFixed(1) + "%";
            const alert = card.querySelector('.status-alert');
            const diff = catSums[cat.id] - (total * target / 100);
            
            if (total === 0) { alert.innerText = "âœ… è«‹é–‹å§‹è¼¸å…¥è³‡ç”¢"; }
            else if (Math.abs(currentP - target) <= 1) { alert.innerText = "âœ… æ¯”ä¾‹ç†æƒ³"; }
            else { alert.innerHTML = diff > 0 ? `âš ï¸ å»ºè­°ç§»å‡º <span style="color:#FF4444">${formatCurrency(diff)}</span>` : `âš ï¸ å»ºè­°è£œå…¥ <span style="color:#008800">${formatCurrency(Math.abs(diff))}</span>`; }

            card.querySelectorAll('.asset-item').forEach(item => {
                const val = Math.max(0, parseFloat(item.querySelector('.asset-value').value) || 0);
                const tP = Math.max(0, parseFloat(item.querySelector('.target-p-input').value) || 0);
                const itemP = catSums[cat.id] > 0 ? (val / catSums[cat.id] * 100) : 0;
                item.querySelector('.ratio-val').innerText = itemP.toFixed(1) + '%';
                const sug = item.querySelector('.diff-suggestion');
                if (total > 0 && catSums[cat.id] > 0 && tP > 0 && Math.abs(itemP - tP) > 1) {
                    const d = (total * (target/100) * (tP/100)) - val;
                    sug.innerText = d > 0 ? `+${Math.round(d).toLocaleString()}` : Math.round(d).toLocaleString();
                    sug.style.color = d > 0 ? "#008800" : "#FF4444";
                } else { sug.innerText = total === 0 ? '-' : 'åˆç†'; sug.style.color = "#888"; }
            });
        });
        document.getElementById('rebalanceSummary').innerText = formatCurrency(total);
        updateChart(catSums, total); autoSave();
    }

    function updateChart(catSums, total) {
        const ctx = document.getElementById('portfolioChart');
        if (!ctx || document.getElementById('chartContainer').style.display === 'none') return;
        const styles = getComputedStyle(document.documentElement);
        const accent = styles.getPropertyValue('--theme-accent').trim();
        const bg = styles.getPropertyValue('--theme-bg').trim();
        const chartColors = [accent, bg, accent + 'CC', bg + '99', '#888888', '#1A1A1A'];
        const data = { 
            labels: categories.map(c => c.name), 
            datasets: [{ data: categories.map(c => catSums[c.id]), backgroundColor: chartColors, borderColor: '#FFFFFF', borderWidth: 2, hoverOffset: 10 }] 
        };
        if (myChart) { myChart.data = data; myChart.update(); } 
        else { myChart = new Chart(ctx, { type: 'doughnut', data: data, options: { maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10, weight: 'bold' }, padding: 15 } } } } }); }
    }

    function autoSave() {
        const data = {};
        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if (!card) return;
            const assets = [];
            card.querySelectorAll('.asset-item').forEach(item => {
                assets.push({ name: item.querySelector('.asset-name').value, value: Math.max(0, item.querySelector('.asset-value').value || 0), targetP: Math.max(0, item.querySelector('.target-p-input').value || 0) });
            });
            data[cat.id] = { target: card.querySelector('.target-input').value, collapsed: card.classList.contains('collapsed'), assets: assets };
        });
        localStorage.setItem('myPortfolio', JSON.stringify(data));
    }

    function clearAll() { 
        if (confirm('âš ï¸ æ³¨æ„ï¼šé€™å°‡æ°¸ä¹…åˆªé™¤æ‰€æœ‰è¨­å®šèˆ‡è³‡æ–™ï¼Œç¢ºå®šé‡ç½®å—ï¼Ÿ')) { 
            localStorage.clear(); window.location.replace(window.location.href); setTimeout(() => window.location.reload(true), 100);
        } 
    }
    function toggleCategory(id) { const card = document.getElementById(id); if (card) { card.classList.toggle('collapsed'); autoSave(); } }
    function toggleChart() { const c = document.getElementById('chartContainer'); c.style.display = c.style.display === 'none' ? 'block' : 'none'; calculateAll(); }
    document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
