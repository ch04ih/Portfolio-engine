<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Engine Pro</title>
    
    <link rel="apple-touch-icon" href="icon.png?v=3">
    <link rel="icon" type="image/png" href="icon.png?v=3">
    <meta name="apple-mobile-web-app-title" content="æŠ•è³‡é…æ¯”">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --theme-accent: #FF8C42;
            --theme-bg: #3D2B1F;
            --theme-accent-rgb: 255, 140, 66;
            --gray-marble: #F0F0F0;
            --radius: 12px;
        }
        [data-theme="orange"] { --theme-accent: #FF8C42; --theme-bg: #3D2B1F; --theme-accent-rgb: 255, 140, 66; }
        [data-theme="forest"] { --theme-accent: #dac4fc; --theme-bg: #293d0b; --theme-accent-rgb: 218, 196, 252; }
        [data-theme="wine"]   { --theme-accent: #80C5DE; --theme-bg: #6e0000; --theme-accent-rgb: 128, 197, 222; }
        [data-theme="purple"] { --theme-accent: #B4D355; --theme-bg: #6245b7; --theme-accent-rgb: 180, 211, 85; }
        [data-theme="navy"]   { --theme-accent: #e4d9c4; --theme-bg: #1b2941; --theme-accent-rgb: 228, 217, 196; }
        [data-theme="amber"]  { --theme-accent: #F0A650; --theme-bg: #0045c6; --theme-accent-rgb: 240, 166, 80; }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: var(--gray-marble); color: #3D2B1F; font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; overflow-x: hidden; width: 100%; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 20px 15px; }

        h1 { border: 4px solid #1A1A1A; text-align: center; margin: 0; background: var(--theme-accent); padding: 15px 12px; box-shadow: 6px 6px 0px #000; border-radius: var(--radius); color: var(--theme-bg); font-weight: 900; line-height: 1.2; }
        
        .save-status { text-align: center; font-size: 10px; font-weight: bold; margin: 10px 0 20px 0; color: #888; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .status-dot.active { background: #00C853; box-shadow: 0 0 8px #00C853; }

        .rebalance-panel { background: white; border: 4px solid #1A1A1A; padding: 20px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); }
        
        /* æ›´æ–°æŒ‰éˆ•æ¨£å¼ï¼šå¼·åˆ¶ä¸€è¡Œä¸æ›è¡Œ */
        .chart-btn { 
            background: var(--theme-accent); 
            color: var(--theme-bg); 
            border: 2px solid #1A1A1A; 
            padding: 5px 10px; 
            font-size: 0.75rem; 
            font-weight: 900; 
            border-radius: 6px; 
            cursor: pointer; 
            box-shadow: 2px 2px 0px #1A1A1A; 
            white-space: nowrap; 
            flex-shrink: 0;
        }

        .category-card { background: #fff; border: 4px solid #1A1A1A; padding: 15px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); position: relative; }
        .category-header { background: var(--theme-bg); color: var(--theme-accent); padding: 12px 15px; margin: -15px -15px 10px -15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; cursor: grab; }

        .btn-delete-card { position: absolute; top: -12px; right: -12px; width: 28px; height: 28px; border-radius: 50%; background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 0px #000; z-index: 10; display: flex; align-items: center; justify-content: center; }

        .target-input { width: 42px; background: var(--theme-accent); color: var(--theme-bg); border: 1px solid #1A1A1A; font-weight: bold; text-align: center; border-radius: 6px; padding: 2px; }
        .target-amount-label { font-size: 9px; font-weight: 900; opacity: 0.8; text-align: right; margin-top: 2px; letter-spacing: 0.5px; }

        .asset-header-row { display: grid; grid-template-columns: 20px 1.2fr 0.6fr 0.6fr 1fr 0.6fr 55px; gap: 4px; padding: 0 0 8px 0; margin-bottom: 5px; border-bottom: 1px solid #EEE; }
        .asset-header-row span { font-size: 9px; font-weight: 900; color: #BBB; text-align: center; letter-spacing: 1px; }

        .asset-list { margin-bottom: 15px; min-height: 5px; }
        .asset-item { display: grid; grid-template-columns: 20px 1.2fr 0.6fr 0.6fr 1fr 0.6fr 55px; gap: 4px; margin-bottom: 12px; align-items: center; padding: 0; border-radius: 8px; cursor: grab; width: 100%; position: relative; }
        .btn-delete-left { background: transparent; border: none; color: #FF4444; font-size: 18px; cursor: pointer; padding: 0; z-index: 2; }

        .static-view { background: #1A1A1A; color: white; padding: 8px 2px; font-size: 9px; text-align: center; min-height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 900; cursor: pointer; overflow: hidden; white-space: nowrap; border: 1px solid transparent; }

/* åªè¦é€™ä¸€æ®µï¼šè®“ empty-placeholder ç¶­æŒæ·ºç°è‰²åº•ã€æœ‰é‚Šæ¡†ã€ä¸é€æ˜ */
.static-view.empty-placeholder { background: #EEE !important; border: 1px solid #DDD !important; color: #BBB !important; }


        .asset-item div:nth-child(2) .static-view { background: #1A1A1A; color: white; }
        .asset-item div:nth-child(3) .static-view:not(.empty-placeholder), 
        .asset-item div:nth-child(4) .static-view:not(.empty-placeholder) { background: #EEE; color: #888; border: 1px solid #DDD; }
        .asset-item div:nth-child(5) .static-view { background: #F8F8F8; color: #1A1A1A; border: 1px solid #DDD; }
        .asset-item div:nth-child(6) .static-view { background: #666; color: white; }

        .edit-container { position: relative; display: none; width: 100%; }
        .edit-input { width: 100%; height: 38px; border: 2px solid #1A1A1A; border-radius: 6px; text-align: center; font-weight: bold; background: white; font-size: 12px; outline: none; padding: 0 4px; }
        .edit-container.prefix::before { content: '$'; position: absolute; left: 2px; top: 50%; transform: translateY(-50%); font-weight: 900; font-size: 9px; color: #1A1A1A; z-index: 2; }
        .edit-container.suffix::after { content: '%'; position: absolute; right: 2px; top: 50%; transform: translateY(-50%); font-weight: 900; font-size: 9px; color: #1A1A1A; z-index: 2; }

        .card-footer { margin-top: 20px; padding-top: 15px; border-top: 2px dashed #DDD; }
        .footer-row { display: flex; justify-content: space-between; align-items: center; }
        .cat-sum-display { font-size: 1.1rem; font-weight: 900; }

        .status-tag { margin-top: 12px; padding: 10px; text-align: center; font-size: 0.8rem; border-radius: 8px; font-weight: 900; background: rgba(var(--theme-accent-rgb), 0.15); color: var(--theme-bg); border: 1px solid rgba(var(--theme-accent-rgb), 0.3); }

        .btn { background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; padding: 12px; font-weight: bold; width: 100%; border-radius: var(--radius); box-shadow: 4px 4px 0px #000; cursor: pointer; margin-bottom: 10px; font-size: 1rem; }
        .btn-reset { background: #ddd; color: #888; border-color: #bbb; margin-top: 20px; box-shadow: 3px 3px 0px #999; font-size: 0.8rem; }

        #target-sum-alert { margin-top:10px; font-size:12px; font-weight:900; text-align:center; padding:8px; border-radius:8px; display:none; border: 2px solid #FF4444; }
        .alert-red { background-color: #FFE5E5 !important; color: #B30000 !important; }

        .theme-panel { display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 10px; }
        .theme-toggle-icon { font-size: 0.75rem; font-weight: bold; cursor: pointer; background: white; padding: 5px 12px; border: 2px solid #1A1A1A; border-radius: 20px; box-shadow: 2px 2px 0px #000; }
        .theme-options { display: none; gap: 10px; margin-top: 10px; background: white; padding: 10px; border: 2px solid #1A1A1A; border-radius: 12px; box-shadow: 4px 4px 0px #000; z-index: 100; }
        .theme-panel.active .theme-options { display: flex; }
        .theme-options button { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #1A1A1A; cursor: pointer; position: relative; overflow: hidden; padding: 0; }
        .theme-options button::after { content: ''; position: absolute; top: 0; left: 50%; width: 50%; height: 100%; background: var(--btn-bg); }

        .collapsed .asset-list, .collapsed .asset-header-row, .collapsed .btn-add-asset { display: none; }
        .chevron { transition: 0.3s; font-size: 0.8rem; }
        .collapsed .chevron { transform: rotate(-90deg); }
        .sortable-ghost { opacity: 0.3; background: var(--theme-accent) !important; border: 2px dashed #000; }
    </style>
</head>
<body>

<div class="container">
    <div class="theme-panel" id="themePanel">
        <div class="theme-toggle-icon" onclick="toggleThemePanel()">ğŸ¨ ä¸»é¡Œé…è‰²</div>
        <div class="theme-options">
            <button style="background: #FF8C42; --btn-bg: #3D2B1F" onclick="setTheme('orange')"></button>
            <button style="background: #dac4fc; --btn-bg: #293d0b" onclick="setTheme('forest')"></button>
            <button style="background: #80C5DE; --btn-bg: #6e0000" onclick="setTheme('wine')"></button>
            <button style="background: #B4D355; --btn-bg: #6245b7" onclick="setTheme('purple')"></button>
            <button style="background: #e4d9c4; --btn-bg: #1b2941" onclick="setTheme('navy')"></button>
            <button style="background: #F0A650; --btn-bg: #0045c6" onclick="setTheme('amber')"></button>
        </div>
    </div>

    <h1>
        <span style="font-size: 0.9em; letter-spacing: 2px;">Portfolio Engine</span><br>
        <span style="font-size: 0.7em;">è³‡ç”¢çµ„åˆè¨ˆç®—å™¨</span>
    </h1>

    <div class="save-status">
        <div class="status-dot" id="saveDot"></div>
        <span id="saveText">æ­£åœ¨è¼‰å…¥æ•¸æ“š...</span>
    </div>

    <div class="rebalance-panel">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px; gap: 10px;">
            <div style="font-size: 0.8rem; font-weight: 900; color: #888; flex-grow: 1;">Total Assets | è³‡ç”¢ç¸½ç¾å€¼ (TWD)</div>
            <div style="display:flex; gap:8px; flex-shrink: 0;">
                <button class="chart-btn" onclick="syncPrices()" id="syncBtn">ğŸ”„ åŒæ­¥å ±åƒ¹</button>
                <button class="chart-btn" onclick="toggleChart()">åœ–è¡¨</button>
            </div>
        </div>
        <div id="rebalanceSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px; margin-bottom: 5px;">$0</div>
        <div id="target-sum-alert"></div>
        <div id="chartContainer" style="display:none; margin-top: 20px; height: 220px;">
            <canvas id="portfolioChart"></canvas>
        </div>
    </div>

    <div id="mainGrid"></div>

    <button class="btn" onclick="addCategory()">+ æ–°å¢æŠ•è³‡å€åŸŸ</button>
    <button class="btn btn-reset" onclick="clearAll()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
</div>

<datalist id="stockList"></datalist>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxy9lgNdsTEW4fCpEmyYeAlAsYhQzHNlXfWFztXdx_W5Qn6vNBgNcRU-THXesDopY_k/exec"; 
    let myChart = null;
    let categories = [];
    let stockData = [];
    let usdRate = 32.5;

    function formatCurrency(num) { return "$" + Math.round(num || 0).toLocaleString('en-US'); }

    const DEFAULT_CONFIG = [
        { id: 'cat_1', name: 'æˆé•·å‹æŠ•è³‡', target: 40 },
        { id: 'cat_2', name: 'é€²æ”»å‹æŠ•è³‡', target: 10 },
        { id: 'cat_3', name: 'é˜²å®ˆå‹æŠ•è³‡', target: 20 },
        { id: 'cat_4', name: 'é«˜è‚¡æ¯æŠ•è³‡', target: 20 },
        { id: 'cat_5', name: 'å®‰å…¨å­˜æ¬¾', target: 10 }
    ];

    async function loadStockData() {
        try {
            const response = await fetch('csvjson.json');
            stockData = await response.json();
            const datalist = document.getElementById('stockList');
            stockData.forEach(item => {
                const option = document.createElement('option');
                option.value = `${item.s} ${item.n}`;
                datalist.appendChild(option);
            });
            document.getElementById('saveText').innerText = "è‡ªå‹•å„²å­˜è‡³æœ¬åœ°ç€è¦½å™¨";
        } catch (e) {
            document.getElementById('saveText').innerText = "è‚¡ç¥¨æ•¸æ“šè¼‰å…¥å¤±æ•—";
        }
    }

    // è¼”åŠ©å‡½å¼ï¼šå–å¾— CSS è®Šæ•¸å€¼
    function getCSSVar(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function forceSave() {
        try {
            const data = {};
            // å„²å­˜æ™‚ä¾ç…§ç•¶å‰ DOM é †åºé‡æ–°æ•´ç† categories
            const newCategories = [];
            document.querySelectorAll('.category-card').forEach(card => {
                const catId = card.id;
                const assets = [];
                card.querySelectorAll('.asset-item').forEach(item => {
                    assets.push({
                        name: item.querySelector('.asset-name').value || '',
                        qty: item.querySelector('.asset-qty').value || '',
                        price: item.querySelector('.asset-price').value || '',
                        value: parseFloat(item.querySelector('.asset-value').value) || 0,
                        targetP: parseFloat(item.querySelector('.target-p-input').value) || 0
                    });
                });
                const catName = card.querySelector('.cat-name-text').innerText;
                newCategories.push({ id: catId, name: catName });
                data[catId] = { 
                    target: parseFloat(card.querySelector('.target-input').value) || 0, 
                    collapsed: card.classList.contains('collapsed'), 
                    assets: assets 
                };
            });
            categories = newCategories;
            localStorage.setItem('myPortfolio_v5', JSON.stringify(data));
            localStorage.setItem('catConfig_v5', JSON.stringify(categories));
            const dot = document.getElementById('saveDot');
            if (dot) { dot.classList.add('active'); setTimeout(() => dot.classList.remove('active'), 800); }
        } catch(e) {}
    }

    function setTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('userTheme', themeName);
        if (document.getElementById('themePanel')) document.getElementById('themePanel').classList.remove('active');
        calculateAll();
    }

    function toggleThemePanel() { document.getElementById('themePanel').classList.toggle('active'); }

    function editMode(el) {
        const container = el.nextElementSibling;
        el.style.display = 'none';
        container.style.display = 'block';
        const input = container.querySelector('input');
        if (input) { input.focus(); input.select(); }
    }

    function autoViewMode(inputEl) {
        const container = inputEl.parentElement;
        const item = inputEl.closest('.asset-item');
        const view = container.previousElementSibling;
        
        if (inputEl.classList.contains('asset-name')) {
            let val = inputEl.value.trim();
            if (val.includes(' ')) val = val.split(' ')[0];
            inputEl.value = val;
            const stock = stockData.find(s => s.s == val);
            if (stock && stock.p) {
                const priceInput = item.querySelector('.asset-price');
                if (!priceInput.value || priceInput.value == 0) {
                    priceInput.value = stock.p;
                    const priceView = priceInput.parentElement.previousElementSibling;
                    priceView.innerText = stock.p;
                    priceView.classList.remove('empty-placeholder');
                }
            }
        }

        const name = item.querySelector('.asset-name').value.trim();
        const q = parseFloat(item.querySelector('.asset-qty').value);
        const p = parseFloat(item.querySelector('.asset-price').value);
        
        if ((inputEl.classList.contains('asset-qty') || inputEl.classList.contains('asset-price') || inputEl.classList.contains('asset-name')) && q > 0 && p > 0) {
            const valInput = item.querySelector('.asset-value');
            if (/[a-zA-Z]/.test(name)) { valInput.value = Math.round(q * p * usdRate); } 
            else { valInput.value = Math.round(q * p); }
            valInput.parentElement.previousElementSibling.innerText = formatCurrency(valInput.value);
        }

        let displayVal = inputEl.value;
        if (inputEl.type === 'number') {
            if (displayVal === "" || displayVal == 0) {
                if (inputEl.classList.contains('asset-qty') || inputEl.classList.contains('asset-price')) {
                    view.innerText = "-"; view.classList.add('empty-placeholder');
                } else {
                    view.innerText = inputEl.classList.contains('target-p-input') ? "0%" : "$0";
                    view.classList.remove('empty-placeholder');
                }
            } else {
                view.innerText = inputEl.classList.contains('target-p-input') ? displayVal + "%" : 
                                 inputEl.classList.contains('asset-value') ? formatCurrency(displayVal) : displayVal;
                view.classList.remove('empty-placeholder');
            }
        } else { view.innerText = displayVal || "æœªå‘½å"; }
        
        setTimeout(() => { container.style.display = 'none'; view.style.display = 'flex'; calculateAll(); }, 150);
    }

  async function syncPrices() {
    const btn = document.getElementById('syncBtn');
    const originalText = btn.innerText;
    let symbolList = [];

    // 1. æ”¶é›†ä¸¦ä¾ç…§ä½ çš„æ–°è¦å‰‡åˆ¤æ–·ä»£è™Ÿ
    document.querySelectorAll('.asset-item').forEach(item => {
        const s = item.querySelector('.asset-name').value.trim().toUpperCase();
        if (s && s !== 'åç¨±') {
            let fullSymbol;
            if (/^[A-Z]+$/.test(s)) {
                // è¦å‰‡ 1ï¼šç´”è‹±æ–‡ -> NASDAQ:
                fullSymbol = `NASDAQ:${s}`;
            } else if (/^\d+$/.test(s)) {
                // è¦å‰‡ 2ï¼šç´”æ•¸å­— -> TPE:
                fullSymbol = `TPE:${s}`;
            } else if (/^\d{5}B$/i.test(s)) {
                // è¦å‰‡ 3ï¼š5å€‹æ•¸å­—+B -> TWO:
                fullSymbol = `TWO:${s}`;
            } else {
                // å‚™ç”¨ï¼šå…¶ä»–æƒ…æ³é è¨­ç”¨ TPE (æˆ–å¯ä¾éœ€æ±‚èª¿æ•´)
                fullSymbol = `TPE:${s}`;
            }
            symbolList.push(fullSymbol);
        }
    });

    if (symbolList.length === 0) return alert("è«‹å…ˆè¼¸å…¥æ¨™çš„ä»£è™Ÿ");

    try {
        btn.innerText = "â³ åŒæ­¥ä¸­...";
        btn.disabled = true;
        
        const finalUrl = `${GAS_URL}?symbols=${encodeURIComponent(symbolList.join(','))}`;
        const response = await fetch(finalUrl);
        const cloudPrices = await response.json();

        if (cloudPrices["CURRENCY:USDTWD"]) { usdRate = cloudPrices["CURRENCY:USDTWD"]; }

        let updatedCount = 0;
        document.querySelectorAll('.asset-item').forEach(item => {
            const nameInput = item.querySelector('.asset-name');
            const priceInput = item.querySelector('.asset-price');
            const s = nameInput.value.trim().toUpperCase();
            
            let key;
            if (/^[A-Z]+$/.test(s)) key = `NASDAQ:${s}`;
            else if (/^\d+$/.test(s)) key = `TPE:${s}`;
            else if (/^\d{5}B$/i.test(s)) key = `TWO:${s}`;
            else key = `TPE:${s}`;

            if (cloudPrices[key] && typeof cloudPrices[key] === 'number') {
                priceInput.value = cloudPrices[key];
                autoViewMode(priceInput);
                updatedCount++;
            }
        });
        
        alert(`âœ… åŒæ­¥å®Œæˆï¼æ›´æ–°äº† ${updatedCount} ç­†å ±åƒ¹ã€‚\nç›®å‰åŒ¯ç‡ï¼š${usdRate}`);
    } catch (e) { 
        alert("åŒæ­¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– GAS è¨­å®šã€‚"); 
    } finally { 
        btn.innerText = originalText; 
        btn.disabled = false; 
        calculateAll(); 
    }
}




    function calculateAll() {
        let total = 0, catSums = {}, totalTargetP = 0;
        document.querySelectorAll('.category-card').forEach(card => {
            const catId = card.id;
            totalTargetP += parseFloat(card.querySelector('.target-input').value) || 0;
            let sum = 0;
            card.querySelectorAll('.asset-value').forEach(i => { sum += parseFloat(i.value) || 0; });
            catSums[catId] = sum;
            total += sum;
        });

        const alertDiv = document.getElementById('target-sum-alert');
        if (Math.abs(totalTargetP - 100) > 0.01) {
            alertDiv.style.display = 'block'; alertDiv.classList.add('alert-red');
            alertDiv.innerText = totalTargetP > 100 ? `âš ï¸å€åŸŸç›®æ¨™ç¸½å’Œ > 100% (${totalTargetP}%)` : `âš ï¸å€åŸŸç›®æ¨™ç¸½å’Œ < 100% (${totalTargetP}%)`;
        } else { alertDiv.style.display = 'none'; }

        document.querySelectorAll('.category-card').forEach(card => {
            const catId = card.id;
            const target = parseFloat(card.querySelector('.target-input').value) || 0;
            const currentP = total > 0 ? (catSums[catId] / total * 100) : 0;
            card.querySelector('.target-amount-label').innerText = formatCurrency(total * (target / 100));
            card.querySelector('.cat-sum-display').innerText = formatCurrency(catSums[catId]);
            card.querySelector('.current-p').innerText = currentP.toFixed(1) + "%";
            
            const alertTag = card.querySelector('.status-alert');
            const diff = catSums[catId] - (total * (target / 100));
            if (total === 0) alertTag.innerText = "âœ… è«‹è¼¸å…¥è³‡æ–™";
            else if (Math.abs(currentP - target) <= 1) alertTag.innerText = "âœ… æ¯”ä¾‹ç†æƒ³";
            else alertTag.innerHTML = diff > 0 ? `âš ï¸ å»ºè­°ç§»å‡º <span style="color:#FF4444">${formatCurrency(diff)}</span>` : `âš ï¸ å»ºè­°è£œå…¥ <span style="color:#008800">${formatCurrency(Math.abs(diff))}</span>`;

            card.querySelectorAll('.asset-item').forEach(item => {
                const val = parseFloat(item.querySelector('.asset-value').value) || 0;
                const tP = parseFloat(item.querySelector('.target-p-input').value) || 0;
                item.querySelector('.ratio-val').innerText = (catSums[catId] > 0 ? (val / catSums[catId] * 100).toFixed(1) : 0) + '%';
                const sug = item.querySelector('.diff-suggestion');
                if (total > 0 && catSums[catId] > 0 && tP > 0) {
                    const d = (total * (target/100) * (tP/100)) - val;
                    sug.innerText = d > 0 ? `+${Math.round(d)}` : Math.round(d);
                    sug.style.color = d > 0 ? "#008800" : "#FF4444";
                } else sug.innerText = "";
            });
        });
        document.getElementById('rebalanceSummary').innerText = formatCurrency(total);
        updateChart(catSums, total);
        forceSave();
    }

    // æ›´æ–°åœ–è¡¨ï¼šä½¿ç”¨ä¸»é¡Œè‰²æ¼¸å±¤
    function updateChart(catSums, grandTotal) {
        const ctx = document.getElementById('portfolioChart');
        if (!ctx || document.getElementById('chartContainer').style.display === 'none') return;
        const chartCtx = ctx.getContext('2d');
        
        const currentAccent = getCSSVar('--theme-accent');
        const currentBg = getCSSVar('--theme-bg');

        const catIds = Object.keys(catSums);
        const dataValues = catIds.map(id => catSums[id]);
        
        // å»ºç«‹æ¼¸å±¤é¡è‰²
        const backgroundColors = catIds.map((_, i) => {
            const factor = i / (catIds.length > 1 ? catIds.length - 1 : 1);
            // ç°¡å–®çš„ Canvas æ¼¸å±¤æˆ–æ··åˆè‰²è¨ˆç®—
            return interpolateColor(currentAccent, currentBg, factor);
        });

        const data = { 
            labels: catIds.map(id => {
                const card = document.getElementById(id);
                return card ? card.querySelector('.cat-name-text').innerText : 'æœªçŸ¥';
            }), 
            datasets: [{ 
                data: dataValues, 
                backgroundColor: backgroundColors,
                hoverOffset: 15,
                borderWidth: 3, 
                borderColor: '#fff' 
            }] 
        };

        if (myChart) { 
            myChart.data = data; 
            myChart.update(); 
        } else { 
            myChart = new Chart(ctx, { 
                type: 'doughnut', data: data, 
                options: { 
                    cutout: '65%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { weight: 'bold', size: 10 } } },
                        tooltip: { 
                            backgroundColor: 'rgba(26,26,26,0.9)',
                            titleFont: { size: 14 },
                            callbacks: { label: (c) => ` ç¾å€¼: ${formatCurrency(c.raw)} (${grandTotal > 0 ? ((c.raw/grandTotal)*100).toFixed(1) : 0}%)` } 
                        } 
                    } 
                } 
            }); 
        }
    }

    // é¡è‰²æ’å€¼è¼”åŠ©å‡½å¼ (Hex to RGB æ··åˆ)
    function interpolateColor(color1, color2, factor) {
        const r1 = parseInt(color1.substring(1,3), 16);
        const g1 = parseInt(color1.substring(3,5), 16);
        const b1 = parseInt(color1.substring(5,7), 16);
        const r2 = parseInt(color2.substring(1,3), 16);
        const g2 = parseInt(color2.substring(3,5), 16);
        const b2 = parseInt(color2.substring(5,7), 16);
        const r = Math.round(r1 + factor * (r2 - r1));
        const g = Math.round(g1 + factor * (g2 - g1));
        const b = Math.round(b1 + factor * (b2 - b1));
        return `rgb(${r}, ${g}, ${b})`;
    }

    function renderUI() {
        const savedData = JSON.parse(localStorage.getItem('myPortfolio_v5')) || {};
        const grid = document.getElementById('mainGrid'); 
        grid.innerHTML = '';
        
        categories.forEach(cat => {
            const data = savedData[cat.id] || { target: 20, assets: [], collapsed: false };
            const card = document.createElement('div');
            card.id = cat.id; card.className = `category-card ${data.collapsed ? 'collapsed' : ''}`;
            card.innerHTML = `
                <button class="btn-delete-card" onclick="deleteCategory('${cat.id}')">Ã—</button>
                <div class="category-header">
                    <div onclick="toggleCategory('${cat.id}')"><span class="chevron">â–¼</span> <span class="cat-name-text" contenteditable="true" onblur="forceSave()">${cat.name}</span></div>
                    <div>ç›®æ¨™ <input type="number" class="target-input" value="${data.target}" oninput="calculateAll()"> %<div class="target-amount-label">$0</div></div>
                </div>
                <div class="asset-header-row"><span></span><span>åç¨±</span><span>è‚¡æ•¸</span><span>å–®åƒ¹</span><span>ç¾å€¼</span><span>ç›®æ¨™%</span><span></span></div>
                <div class="asset-list" id="list-${cat.id}"></div>
                <button class="btn btn-add-asset" onclick="addAsset('${cat.id}')">+ æ–°å¢æ¨™çš„</button>
                <div class="card-footer"><div class="footer-row"><span style="font-size:0.75rem; color:#888;">å€åŸŸåˆè¨ˆ</span><span class="cat-sum-display">$0</span><span class="current-p">0%</span></div><div class="status-tag status-alert">âœ… æ¯”ä¾‹ç†æƒ³</div></div>
            `;
            grid.appendChild(card);
            if (data.assets && data.assets.length > 0) data.assets.forEach(a => addAsset(cat.id, a.name, a.value, a.targetP, a.qty, a.price));
            else addAsset(cat.id);

            // åˆå§‹åŒ–å…§éƒ¨æ¨™çš„æ’åº
            new Sortable(document.getElementById(`list-${cat.id}`), {
                animation: 150,
                delay: 500, // é•·æŒ‰ 500ms è§¸ç™¼
                delayOnTouchOnly: true,
                onEnd: () => { calculateAll(); }
            });
        });

        // åˆå§‹åŒ–å€åŸŸå¡ç‰‡æ’åº
        new Sortable(grid, {
            animation: 150,
            handle: '.category-header',
            delay: 500,
            delayOnTouchOnly: true,
            onEnd: () => { calculateAll(); }
        });

        calculateAll();
    }

    function addAsset(catId, name='', value=0, targetP=0, qty='', price='') {
        const list = document.getElementById(`list-${catId}`); if(!list) return;
        const div = document.createElement('div'); div.className = 'asset-item';
        const qD = (qty===''||qty==0)?'-':qty; const pD = (price===''||price==0)?'-':price;
        div.innerHTML = `
            <button class="btn-delete-left" onclick="this.closest('.asset-item').remove(); calculateAll();">Ã—</button>
            <div><div class="static-view" onclick="editMode(this)">${name||'åç¨±'}</div><div class="edit-container"><input type="text" class="edit-input asset-name" list="stockList" value="${name}" onblur="autoViewMode(this)"></div></div>
            <div><div class="static-view ${qD==='-'}?empty-placeholder:''" onclick="editMode(this)">${qD}</div><div class="edit-container"><input type="number" class="edit-input asset-qty" value="${qty}" onblur="autoViewMode(this)"></div></div>
            <div><div class="static-view ${pD==='-'}?empty-placeholder:''" onclick="editMode(this)">${pD}</div><div class="edit-container prefix"><input type="number" class="edit-input asset-price" value="${price}" onblur="autoViewMode(this)"></div></div>
            <div><div class="static-view" onclick="editMode(this)">${formatCurrency(value)}</div><div class="edit-container prefix"><input type="number" class="edit-input asset-value" value="${value}" onblur="autoViewMode(this)"></div></div>
            <div><div class="static-view" onclick="editMode(this)">${targetP}%</div><div class="edit-container suffix"><input type="number" class="target-p-input edit-input" value="${targetP}" onblur="autoViewMode(this)"></div></div>
            <div style="font-size:10px; font-weight:bold; text-align:right;"><div class="ratio-val">0%</div><div class="diff-suggestion" style="font-size:8px;"></div></div>
        `;
        list.appendChild(div);
    }

    function addCategory() { categories.push({ id: 'cat_'+Date.now(), name: 'æ–°æŠ•è³‡å€åŸŸ' }); renderUI(); }
    function deleteCategory(id) { if (confirm('ç¢ºå®šåˆªé™¤å€åŸŸï¼Ÿ')) { categories = categories.filter(c => c.id !== id); renderUI(); forceSave(); } }
    function toggleCategory(id) { 
        if (event.target.tagName !== 'INPUT' && !event.target.isContentEditable) { 
            document.getElementById(id).classList.toggle('collapsed'); 
            forceSave(); 
        } 
    }
    function toggleChart() { const c = document.getElementById('chartContainer'); c.style.display = c.style.display === 'none' ? 'block' : 'none'; calculateAll(); }
    function clearAll() { if (confirm('ç¢ºå®šé‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) { localStorage.clear(); location.reload(); } }

    window.onload = () => { 
        loadStockData(); 
        const savedCats = localStorage.getItem('catConfig_v5'); 
        categories = savedCats ? JSON.parse(savedCats) : DEFAULT_CONFIG.map(d => ({ id: d.id, name: d.name })); 
        renderUI(); 
        setTheme(localStorage.getItem('userTheme') || 'orange'); 
    };
</script>
</body>
</html>
