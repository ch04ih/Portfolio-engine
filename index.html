<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Engine Pro</title>
    
    <link id="apple-icon" rel="apple-touch-icon" href="icon-orange.png?v=4">
    <link id="favicon" rel="icon" type="image/png" href="icon-orange.png?v=4">
    <meta name="apple-mobile-web-app-title" content="æŠ•è³‡é…æ¯”">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --theme-accent: #F0A650;
            --theme-bg: #0045c6;
            --theme-accent-rgb: 255, 140, 66;
            --gray-marble: #F0F0F0;
            --radius: 12px;
        }
        [data-theme="orange"] { --theme-accent: #FF8C42; --theme-bg: #3D2B1F; --theme-accent-rgb: 255, 140, 66; }
        [data-theme="forest"] { --theme-accent: #dac4fc; --theme-bg: #293d0b; --theme-accent-rgb: 218, 196, 252; }
        [data-theme="wine"]   { --theme-accent: #80C5DE; --theme-bg: #6e0000; --theme-accent-rgb: 128, 197, 222; }
        [data-theme="purple"] { --theme-accent: #B4D355; --theme-bg: #6245b7; --theme-accent-rgb: 180, 211, 85; }
        [data-theme="navy"]   { --theme-accent: #e4d9c4; --theme-bg: #1b2941; --theme-accent-rgb: 228, 217, 196; }
        [data-theme="amber"]  { --theme-accent: #F0A650; --theme-bg: #0045c6; --theme-accent-rgb: 240, 166, 80; }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: var(--gray-marble); color: #3D2B1F; font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; overflow-x: hidden; width: 100%; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 20px 15px; }

        h1 { border: 4px solid #1A1A1A; text-align: center; margin: 0; background: var(--theme-accent); padding: 15px 12px; box-shadow: 6px 6px 0px #000; border-radius: var(--radius); color: var(--theme-bg); font-weight: 900; line-height: 1.2; }
        
        .save-status { text-align: center; font-size: 10px; font-weight: bold; margin: 10px 0 20px 0; color: #888; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .status-dot.active { background: #00C853; box-shadow: 0 0 8px #00C853; }

        .rebalance-panel { background: white; border: 4px solid #1A1A1A; padding: 20px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); }
        .chart-btn { background: var(--theme-accent); color: var(--theme-bg); border: 2px solid #1A1A1A; padding: 5px 10px; font-size: 0.7rem; font-weight: 900; border-radius: 6px; cursor: pointer; box-shadow: 2px 2px 0px #1A1A1A; white-space: nowrap; flex-shrink: 0; }

        .category-card { background: #fff; border: 4px solid #1A1A1A; padding: 15px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); position: relative; }
        .category-header { background: var(--theme-bg); color: var(--theme-accent); padding: 12px 15px; margin: -15px -15px 10px -15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; cursor: grab; }

        .btn-delete-card { position: absolute; top: -12px; right: -12px; width: 28px; height: 28px; border-radius: 50%; background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 0px #000; z-index: 10; display: flex; align-items: center; justify-content: center; }

        .target-input { width: 42px; background: var(--theme-accent); color: var(--theme-bg); border: 1px solid #1A1A1A; font-weight: bold; text-align: center; border-radius: 6px; padding: 2px; }
        .target-amount-label { font-size: 9px; font-weight: 900; opacity: 0.8; text-align: right; margin-top: 2px; letter-spacing: 0.5px; }

        .asset-header-row { display: grid; grid-template-columns: 20px 1.2fr 0.6fr 0.6fr 1.1fr 0.8fr 45px; gap: 8px; padding: 0 0 8px 0; margin-bottom: 5px; border-bottom: 1px solid #DDD; }
        .asset-header-row span { font-size: 9px; font-weight: 900; color: #888; text-align: center; }

        .asset-list { margin-bottom: 15px; min-height: 5px; }
        .asset-item { display: grid; grid-template-columns: 20px 1.2fr 0.6fr 0.6fr 1.1fr 0.8fr 45px; gap: 8px; padding: 8px 0; align-items: center; border-bottom: 1px solid #F2F2F2; cursor: grab; }
        
        .static-view { background: transparent; border: none; color: #333; font-size: 12px; min-height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 500; cursor: pointer; border-radius: 4px; }
        .static-view.empty-placeholder { color: #BBB !important; font-style: italic; }

        .asset-item div:nth-child(2) .static-view { font-weight: 900; color: #1A1A1A; background-color: #F0F4F8 !important; padding: 0 4px; justify-content: center; } 
        .asset-item div:nth-child(3) .static-view, .asset-item div:nth-child(4) .static-view { font-size: 11px; color: #999; } 
        .asset-item div:nth-child(5) .static-view { font-weight: 900; color: #1A1A1A; justify-content: flex-end; background-color: #FFF9E6 !important; padding-right: 4px; } 
        .asset-item div:nth-child(6) .static-view { font-size: 11px; color: var(--theme-bg); justify-content: flex-end; opacity: 0.8; } 

        .edit-container { position: relative; display: none; width: 100%; }
        .edit-input { width: 100%; height: 28px; border: 2px solid #1A1A1A; border-radius: 6px; text-align: center; font-weight: bold; background: white; font-size: 12px; outline: none; }
        .edit-container.prefix::before { content: '$'; position: absolute; left: 2px; top: 50%; transform: translateY(-50%); font-weight: 900; font-size: 9px; color: #1A1A1A; z-index: 2; }
        .edit-container.suffix::after { content: '%'; position: absolute; right: 2px; top: 50%; transform: translateY(-50%); font-weight: 900; font-size: 9px; color: #1A1A1A; z-index: 2; }

        .btn-delete-left { background: transparent; border: none; color: #FF4444; font-size: 16px; cursor: pointer; padding: 0; text-align: left; }
        .card-footer { margin-top: 10px; padding-top: 15px; border-top: 2px dashed #DDD; }
        .footer-row { display: flex; justify-content: space-between; align-items: center; }
        .cat-sum-display { font-size: 1.1rem; font-weight: 900; }
        
        /* åˆè¨ˆç™¾åˆ†æ¯”å­—é«”ç¸®å° */
        .current-p { font-size: 0.85rem; font-weight: 700; color: #555; }

        .status-tag { margin-top: 12px; padding: 10px; text-align: center; font-size: 0.8rem; border-radius: 8px; font-weight: 900; background: rgba(var(--theme-accent-rgb), 0.15); color: var(--theme-bg); border: 1px solid rgba(var(--theme-accent-rgb), 0.3); }
        .btn { background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; padding: 12px; font-weight: bold; width: 100%; border-radius: var(--radius); box-shadow: 4px 4px 0px #000; cursor: pointer; margin-bottom: 10px; font-size: 1rem; }
        
        #chartContainer { display:none; margin-top: 20px; width: 100%; height: auto; min-height: 250px; }
        #portfolioChart { width: 100% !important; height: auto !important; }

        .theme-panel { display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 10px; }
        .theme-toggle-icon { font-size: 0.75rem; font-weight: bold; cursor: pointer; background: white; padding: 5px 12px; border: 2px solid #1A1A1A; border-radius: 20px; box-shadow: 2px 2px 0px #000; }
        .theme-options { display: none; gap: 10px; margin-top: 10px; background: white; padding: 10px; border: 2px solid #1A1A1A; border-radius: 12px; box-shadow: 4px 4px 0px #000; z-index: 100; }
        .theme-panel.active .theme-options { display: flex; }
        
        /* é›™è‰²ä¸»é¡Œé è¦½æŒ‰éµ */
        .theme-options button { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #1A1A1A; cursor: pointer; position: relative; overflow: hidden; padding: 0; }
        .theme-options button::after { content: ''; position: absolute; top: 0; right: 0; width: 50%; height: 100%; background: var(--btn-accent); }
        
        /* ç•¶å¡ç‰‡æ”¶åˆæ™‚ï¼Œéš±è—åˆ—è¡¨ã€æ¨™é ­è¡Œã€æ–°å¢æŒ‰éˆ•ä»¥åŠå»ºè­°æ¨™ç±¤ */
        .collapsed .asset-list, .collapsed .asset-header-row, .category-card.collapsed .btn, .category-card.collapsed .status-tag { display: none !important;}

        /* è®“ footer çš„é–“è·åœ¨æ”¶åˆæ™‚æ›´ç·Šæ¹Šï¼ˆé¸é…ï¼‰ */
        .collapsed .card-footer {margin-top: 5px;padding-top: 10px; border-top: none;}
        .chevron { display: inline-block; transition: 0.3s; font-size: 0.8rem; tranform: rotate(0deg);}
        .collapsed .chevron { transform: rotate(-90deg); }

        /* 1. æ¯ä¸€é çš„å…±åŒè¨­å®šï¼šé è¨­éš±è—ï¼Œå¡«æ»¿ç©ºé–“ */
        .page-view {display: none;animation: fadeIn 0.3s ease-in-out; /* æ›é æ™‚æœ‰å€‹æ·¡å…¥æ•ˆæœ */}
        
        @keyframes fadeIn {from { opacity: 0; }to { opacity: 1; }}
        
        /* 2. é¦–é æ¨™é¡Œæ¨£å¼ (ç›´æ¥å¥—ç”¨ä½ åŸæœ¬æœ€æ¼‚äº®çš„è¨­è¨ˆ) */
        .dashboard-title {
            border: 4px solid #1A1A1A;
            text-align: center;
            background: var(--theme-accent);
            padding: 15px 12px;
            box-shadow: 6px 6px 0px #000;
            border-radius: var(--radius);
            color: var(--theme-bg);
            font-weight: 900;
            margin-bottom: 40px !important;
        }
        
        /* 3. Dashboard å¡ç‰‡ç¶²æ ¼ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr; /* æ‰‹æ©Ÿä¸Šä¸€åˆ—ä¸€å€‹ */
            gap: 20px;
            margin-top: 20px;
        }
        
        /* 4. å–®å¼µå¡ç‰‡è¨­è¨ˆ */
        .dash-card {
            background: white;
            border: 4px solid #1A1A1A;
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: 6px 6px 0px #1A1A1A;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        /* é»æ“Šæ™‚çš„ä¸‹å£“æ„Ÿ */
        .dash-card:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px #1A1A1A;
        }
        
        .dash-label {
            font-size: 0.9rem;
            font-weight: 900;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .dash-value {
            font-size: 2.2rem;
            font-weight: 900;
            margin-top: 10px;
            color: var(--theme-bg); /* è®“æ•¸å­—é¡è‰²è·Ÿä¸»é¡Œèµ° */
        }
        
        /* æ·¨è³‡ç”¢å¡ç‰‡ç‰¹åˆ¥å¼·èª¿ */
        .dash-card.net-worth {
            background: #f8f9fa;
            border-style: double; /* é›™ç·šé‚Šæ¡†æ›´æœ‰è³ªæ„Ÿ */
        }
        /* åº•éƒ¨å°è¦½åˆ—ï¼šåƒæ‰‹æ©Ÿ App ä¸€æ¨£å›ºå®š */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            border-top: 4px solid #1A1A1A;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .bottom-nav div {
            font-weight: 900;
            font-size: 0.9rem;
            cursor: pointer;
            color: #1A1A1A;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* è®“ container åº•éƒ¨ç•™ç™½ï¼Œä¸ç„¶å…§å®¹æœƒè¢«å°è¦½åˆ—é®ä½ */
        .container {
            padding-bottom: 100px !important;
        }

        /* è¨­å®šè² å‚µé …ç›®çš„æ¬„ä½æ¯”ä¾‹ï¼šåç¨± ä½”å¤§éƒ¨åˆ†ï¼Œé‡‘é¡å±…ä¸­ï¼Œåˆªé™¤éˆ•åœ¨å³ */
        #liabilitiesGrid .asset-item {
            display: grid;
            grid-template-columns: 1.2fr 1.1fr 45px; /* èˆ‡è³‡ç”¢é ç›¸åŒçš„æ¯”ä¾‹ */
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        /* è®“è² å‚µçš„è¼¸å…¥æ¡†ä¹Ÿè·Ÿè³‡ç”¢é ä¸€æ¨£æ¼‚äº® */
        #liabilitiesGrid .edit-input {
            border: 2px solid #1A1A1A;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
            font-weight: bold;
            width: 100%;
        }
    </style>
</head>
<body>


    <div class="theme-panel" id="themePanel">
        <div class="theme-toggle-icon" onclick="toggleThemePanel()">ğŸ¨ ä¸»é¡Œé…è‰²</div>
        <div class="theme-options">
            <button style="background: #3D2B1F; --btn-accent: #FF8C42" onclick="setTheme('orange')"></button>
            <button style="background: #293d0b; --btn-accent: #dac4fc" onclick="setTheme('forest')"></button>
            <button style="background: #6e0000; --btn-accent: #80C5DE" onclick="setTheme('wine')"></button>
            <button style="background: #6245b7; --btn-accent: #B4D355" onclick="setTheme('purple')"></button>
            <button style="background: #1b2941; --btn-accent: #e4d9c4" onclick="setTheme('navy')"></button>
            <button style="background: #0045c6; --btn-accent: #F0A650" onclick="setTheme('amber')"></button>
        </div>
    </div>
    
<div class="container">
    <div id="home-view" class="page-view">
            <h1>è²¡å‹™ç¸½è¦½ Dashboard</h1>
            <div class="dashboard-grid">
                <div class="dash-card" onclick="showPage('assets-view')">
                    <span class="dash-label">ç¸½è³‡ç”¢ (Assets)</span>
                    <span id="dash-total-assets" class="dash-value">$0</span>
                </div>
                <div class="dash-card" onclick="showPage('liabilities-view')">
                    <span class="dash-label">ç¸½è² å‚µ (Liabilities)</span>
                    <span id="dash-total-liabilities" class="dash-value" style="color: #FF4444;">$0</span>
                </div>
                <div class="dash-card">
                    <span class="dash-label">æ·¨è³‡ç”¢ (Net Worth)</span>
                    <span id="dash-net-worth" class="dash-value" style="color: #008800;">$0</span>
                </div>
            </div>
        </div>
    
    <div id="assets-view" class="page-view" style="display:none;">
        <h1>
            <span style="font-size: 0.8em; letter-spacing: 2px;">Portfolio Engine</span><br>
            <span style="font-size: 0.6em;">è³‡ç”¢çµ„åˆè¨ˆç®—å™¨</span>
        </h1>
    
        <div class="save-status">
            <div class="status-dot" id="saveDot"></div>
            <span id="saveText">æ•¸æ“šè¼‰å…¥ä¸­...</span>
        </div>
    
        <div class="rebalance-panel">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
                <div style="font-size: 0.75rem; font-weight: 900; color: #888; flex-grow: 1;">Total Assetsï½œè³‡ç”¢ç¸½ç¾å€¼ (TWD)</div>
                <div style="display:flex; gap:8px;">
                    <button class="chart-btn" onclick="syncPrices()" id="syncBtn">ğŸ”„ æœ€æ–°è‚¡åƒ¹</button>
                    <button class="chart-btn" onclick="toggleChart()">åœ–è¡¨</button>
                </div>
            </div>
            <div id="rebalanceSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px;">$0</div>
            <div id="target-sum-alert" style="display:none; font-size:12px; margin-top:10px; padding:5px; border-radius:5px; background:#FFE5E5; color:#B30000; border:2px solid #FF4444; text-align:center; font-weight:bold;"></div>
            <div id="chartContainer">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>
    
        <div id="mainGrid"></div>
        <button class="btn" onclick="addCategory()">+ æ–°å¢æŠ•è³‡å€åŸŸ</button>
        <button class="btn" style="background:#ddd; border-color:#bbb; color:#888; box-shadow:3px 3px 0px #999; font-size:0.8rem;" onclick="clearAll()">é‡ç½®è³‡æ–™</button>
    </div>    
    
    <div id="liabilities-view" class="page-view" style="display:none;">
        <h1>
            <span style="font-size: 0.8em; letter-spacing: 2px;">Debt Management</span><br>
            <span style="font-size: 0.6em;">è² å‚µç®¡ç†</span>
        </h1>
        
        <div class="rebalance-panel">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
                <div style="font-size: 0.75rem; font-weight: 900; color: #888; flex-grow: 1;">Total Liabilitiesï½œè² å‚µç¸½é¡ (TWD)</div>
                <div style="display:flex; gap:8px;">
                    <button class="chart-btn" onclick="toggleLiabChart()">åœ–è¡¨</button>
                </div>
            </div>
            <div id="liabilitiesSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px;">$0</div>
            
            <div id="liabChartContainer" style="display:none; margin-top: 20px;">
                <canvas id="liabilitiesChart"></canvas>
            </div>
        </div>
    
        <div id="liabilitiesGrid"></div>
    
        <button class="btn" onclick="addLiabilityCategory()" style="width:100%; margin-top:20px; background:#1A1A1A; color:white;">
            â• æ–°å¢è² å‚µåˆ†é¡
        </button>
    </div>
</div>
<nav class="bottom-nav">
        <div onclick="showPage('home-view')">ğŸ  ç¸½è¦½</div>
        <div onclick="showPage('assets-view')">ğŸ’° è³‡ç”¢</div>
        <div onclick="showPage('liabilities-view')">ğŸ“‰ è² å‚µ</div>
    </nav>
<datalist id="stockList"></datalist>

<script>
    function showPage(pageId) {
    // 1. éš±è—æ‰€æœ‰é é¢
    document.querySelectorAll('.page-view').forEach(p => {
        p.style.display = 'none';
    });
    // 2. é¡¯ç¤ºé»æ“Šçš„é‚£ä¸€é 
    document.getElementById(pageId).style.display = 'block';
    
    // 3. æ›é å¾Œè‡ªå‹•æ²å›é ‚éƒ¨ï¼Œé«”é©—æ¯”è¼ƒå¥½
    window.scrollTo(0, 0);
    }
    
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxy9lgNdsTEW4fCpEmyYeAlAsYhQzHNlXfWFztXdx_W5Qn6vNBgNcRU-THXesDopY_k/exec"; 
    let myChart = null, categories = [], stockData = [], usdRate = 32.5;
    let myLiabChart = null; // é€™æ˜¯å°ˆé–€çµ¦è² å‚µç”¨çš„åœ–è¡¨è®Šæ•¸

    function formatNum(num) { return (num === '' || isNaN(num) || num == 0) ? "-" : parseFloat(num).toLocaleString('en-US'); }
    function formatCurrency(num) { return "$" + Math.round(num || 0).toLocaleString('en-US'); }

    const DEFAULT_CONFIG = [
        { id: 'cat_1', name: 'æˆé•·å‹æŠ•è³‡', target: 40 },
        { id: 'cat_2', name: 'é€²æ”»å‹æŠ•è³‡', target: 10 },
        { id: 'cat_3', name: 'é˜²å®ˆå‹æŠ•è³‡', target: 20 },
        { id: 'cat_4', name: 'é«˜è‚¡æ¯æŠ•è³‡', target: 20 },
        { id: 'cat_5', name: 'å®‰å…¨å­˜æ¬¾', target: 10 }
    ];

    async function loadStockData() {
        try {
            const resp = await fetch('csvjson.json');
            stockData = await resp.json();
            const dl = document.getElementById('stockList');
            stockData.forEach(i => { const opt = document.createElement('option'); opt.value = `${i.s} ${i.n}`; dl.appendChild(opt); });
            document.getElementById('saveText').innerText = "è‡ªå‹•å„²å­˜è‡³æœ¬åœ°";
        } catch (e) { document.getElementById('saveText').innerText = "æ•¸æ“šè¼‰å…¥å¤±æ•—"; }
    }

    function forceSave() {
        try {
            const data = {}, newCats = [];
            document.querySelectorAll('.category-card').forEach(card => {
                const assets = [];
                card.querySelectorAll('.asset-item').forEach(item => {
                    assets.push({
                        name: item.querySelector('.asset-name').value || '',
                        qty: item.querySelector('.asset-qty').value || '',
                        price: item.querySelector('.asset-price').value || '',
                        value: parseFloat(item.querySelector('.asset-value').value) || 0,
                        targetP: parseFloat(item.querySelector('.target-p-input').value) || 0
                    });
                });
                newCats.push({ id: card.id, name: card.querySelector('.cat-name-text').innerText });
                data[card.id] = { target: parseFloat(card.querySelector('.target-input').value) || 0, collapsed: card.classList.contains('collapsed'), assets: assets };
            });
            categories = newCats;
            localStorage.setItem('myPortfolio_v5', JSON.stringify(data));
            localStorage.setItem('catConfig_v5', JSON.stringify(categories));
            const dot = document.getElementById('saveDot'); dot.classList.add('active'); setTimeout(() => dot.classList.remove('active'), 800);
        } catch(e) {}
    }

    function setTheme(themeName) {
    // 1. åˆ‡æ›ç¶²é æ•´é«”ä¸»é¡Œ
    document.documentElement.setAttribute('data-theme', themeName);
    localStorage.setItem('userTheme', themeName);
    
    // 2. æ›´æ–° Icon è·¯å¾‘
    // é€™é‚Šæœƒæ ¹æ“šå‚³å…¥çš„ themeName (å¦‚ 'forest') è‡ªå‹•è®Šæˆ 'icon-forest.png'
    const newPath = `icon-${themeName}.png?v=4`; 
    document.getElementById('apple-icon').href = newPath;
    document.getElementById('favicon').href = newPath;

    // 3. é—œé–‰ä¸»é¡Œé¢æ¿èˆ‡é‡æ–°è¨ˆç®—
    if (document.getElementById('themePanel')) {
        document.getElementById('themePanel').classList.remove('active');
    }
    calculateAll();
}
    
    function toggleThemePanel() { document.getElementById('themePanel').classList.toggle('active'); }

    function editMode(el) {
        const con = el.nextElementSibling; el.style.display = 'none'; con.style.display = 'block';
        const i = con.querySelector('input'); if (i) { i.focus(); i.select(); }
    }

    function autoViewMode(iEl) {
        const item = iEl.closest('.asset-item'), view = iEl.parentElement.previousElementSibling;
        if (iEl.classList.contains('asset-name')) {
            let val = iEl.value.trim(); if (val.includes(' ')) val = val.split(' ')[0];
            iEl.value = val;
            const s = stockData.find(st => st.s == val);
            if (s && s.p) { const pI = item.querySelector('.asset-price'); if (!pI.value || pI.value == 0) pI.value = s.p; }
        }
        const name = item.querySelector('.asset-name').value.trim(), q = parseFloat(item.querySelector('.asset-qty').value), p = parseFloat(item.querySelector('.asset-price').value);
        if (q > 0 && p > 0) {
            const vI = item.querySelector('.asset-value');
            const vV = vI.parentElement.previousElementSibling; // æ‰¾åˆ°ç¾å€¼çš„é¡¯ç¤ºå±¤
            vI.value = /^[A-Za-z]+$/.test(name) ? Math.round(q * p * usdRate) : Math.round(q * p);
            if (vV) { 
                vV.innerText = formatCurrency(vI.value); 
                vV.classList.remove('empty-placeholder');
            }
        }

        let dV = iEl.value;
        if (iEl.type === 'number') {
            if (dV === "" || dV == 0) {
                view.innerText = (iEl.classList.contains('asset-qty') || iEl.classList.contains('asset-price')) ? "-" : (iEl.classList.contains('target-p-input') ? "0%" : "$0");
                view.classList.toggle('empty-placeholder', view.innerText === "-");
            } else {
                if (iEl.classList.contains('asset-qty') || iEl.classList.contains('asset-price')) view.innerText = formatNum(dV);
                else if (iEl.classList.contains('asset-value')) view.innerText = formatCurrency(dV);
                else if (iEl.classList.contains('target-p-input')) view.innerText = dV + "%";
                view.classList.remove('empty-placeholder');
            }
        } else { view.innerText = dV || "é»æ“Šè¼¸å…¥"; }
        setTimeout(() => { iEl.parentElement.style.display = 'none'; view.style.display = 'flex'; calculateAll(); }, 150);
    }

    async function syncPrices() {
    const btn = document.getElementById('syncBtn'), oT = btn.innerText;
    let sL = []; document.querySelectorAll('.asset-item').forEach(i => {
        const s = i.querySelector('.asset-name').value.trim().toUpperCase();
        if (s && s !== 'é»æ“Šè¼¸å…¥') sL.push(s);
    });
    if (sL.length === 0) return alert("è«‹è¼¸å…¥ä»£è™Ÿ");
    try {
        btn.innerText = "â³..."; btn.disabled = true;
        const resp = await fetch(`${GAS_URL}?symbols=${encodeURIComponent(sL.join(','))}`);
        const cloud = await resp.json();
        if (cloud["CURRENCY:USDTWD"]) usdRate = cloud["CURRENCY:USDTWD"];
        document.querySelectorAll('.asset-item').forEach(i => {
            const nI = i.querySelector('.asset-name'), s = nI.value.trim().toUpperCase(), p = cloud[s];
            if (p && p > 0) { 
                const pI = i.querySelector('.asset-price'), qI = i.querySelector('.asset-qty'), vI = i.querySelector('.asset-value');
                pI.value = p; 
                autoViewMode(pI); 
                
                // è‡ªå‹•æ›´æ–°ç¾å€¼åŠŸèƒ½
                const q = parseFloat(qI.value) || 0;
                let nV = /^[A-Za-z]+$/.test(nI.value.trim()) ? Math.round(q * p * usdRate) : Math.round(q * p);
                vI.value = nV;
                const vV = vI.parentElement.previousElementSibling;
                if (vV) { vV.innerText = formatCurrency(nV); vV.classList.remove('empty-placeholder'); }
            }
        });
        alert(`âœ… è‚¡åƒ¹å·²æ›´æ–° ç›®å‰åŒ¯ç‡ï¼š${usdRate.toFixed(2)}`);
    } catch (e) { alert("å¤±æ•—"); } finally { btn.innerText = oT; btn.disabled = false; calculateAll(); }
}


    function calculateAll() {
        let total = 0, catSums = {}, totalTargetP = 0;
        document.querySelectorAll('.category-card').forEach(card => {
            totalTargetP += parseFloat(card.querySelector('.target-input').value) || 0;
            let sum = 0; card.querySelectorAll('.asset-value').forEach(i => { sum += parseFloat(i.value) || 0; });
            catSums[card.id] = sum; total += sum;
        });
        const alertDiv = document.getElementById('target-sum-alert');
        if (Math.abs(totalTargetP - 100) > 0.01) { alertDiv.style.display = 'block'; alertDiv.innerText = `âš ï¸ ç›®æ¨™ç¸½å’Œ: ${totalTargetP}%`; } else alertDiv.style.display = 'none';

        document.querySelectorAll('.category-card').forEach(card => {
            const target = parseFloat(card.querySelector('.target-input').value) || 0, curP = total > 0 ? (catSums[card.id] / total * 100) : 0;
            card.querySelector('.target-amount-label').innerText = formatCurrency(total * (target / 100));
            card.querySelector('.cat-sum-display').innerText = formatCurrency(catSums[card.id]);
            card.querySelector('.current-p').innerText = curP.toFixed(1) + "%";
            const tag = card.querySelector('.status-alert'), diff = catSums[card.id] - (total * (target / 100));
            if (total === 0) tag.innerText = "âœ… ç­‰å¾…è³‡æ–™";
            else if (Math.abs(curP - target) <= 3) tag.innerText = "âœ… æ¯”ä¾‹ç†æƒ³";
            else tag.innerHTML = diff > 0 ? `âš ï¸ å»ºè­°ç§»å‡º <span style="color:#FF4444">${formatCurrency(diff)}</span>` : `âš ï¸ å»ºè­°è£œå…¥ <span style="color:#008800">${formatCurrency(Math.abs(diff))}</span>`;

            card.querySelectorAll('.asset-item').forEach(item => {
                const val = parseFloat(item.querySelector('.asset-value').value) || 0, tP = parseFloat(item.querySelector('.target-p-input').value) || 0;
                item.querySelector('.ratio-val').innerText = (catSums[card.id] > 0 ? (val / catSums[card.id] * 100).toFixed(1) : 0) + '%';
                const sug = item.querySelector('.diff-suggestion');
                if (total > 0 && catSums[card.id] > 0 && tP > 0) {
                    const d = (total * (target/100) * (tP/100)) - val;
                    sug.innerText = (d > 0 ? "+" : "") + Math.round(d).toLocaleString();
                    sug.style.color = d > 0 ? "#008800" : "#FF4444";
                } else sug.innerText = "";
            });
        });
        document.getElementById('rebalanceSummary').innerText = formatCurrency(total);
        
        const dashAssets = document.getElementById('dash-total-assets');
        const dashNet = document.getElementById('dash-net-worth');
        const dashLiabilities = document.getElementById('dash-total-liabilities');
    
        // total æ˜¯ä½ åŸæœ¬ code è£¡ç®—å‡ºä¾†çš„ç¸½è³‡ç”¢è®Šæ•¸
        if (dashAssets) dashAssets.innerText = formatCurrency(total);
        if (dashLiabilities) dashLiabilities.innerText = formatCurrency(0); // ç›®å‰è² å‚µå…ˆè¨­ 0
        if (dashNet) dashNet.innerText = formatCurrency(total - 0); 
    
        updateChart(catSums, total); 
        forceSave();
    }

    function updateChart(catSums, grandTotal) {
        const container = document.getElementById('chartContainer');
        const ctx = document.getElementById('portfolioChart'); 
        if (!ctx || container.style.display === 'none') return;
        const cA = getComputedStyle(document.documentElement).getPropertyValue('--theme-accent').trim();
        const cB = getComputedStyle(document.documentElement).getPropertyValue('--theme-bg').trim();
        const ids = Object.keys(catSums);
        const colors = ids.map((_, i) => interpolateColor(cA, cB, i / (ids.length > 1 ? ids.length - 1 : 1)));
        const labels = ids.map(id => document.getElementById(id).querySelector('.cat-name-text').innerText);
        const dataValues = ids.map(id => catSums[id]);
        if (myChart) {
            myChart.data.labels = labels; myChart.data.datasets[0].data = dataValues; myChart.data.datasets[0].backgroundColor = colors;
            myChart.update(); myChart.resize();
        } else {
            myChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: dataValues, backgroundColor: colors, borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
            });
        }
    }

    function updateLiabChart(catSums, total) {
        const container = document.getElementById('liabChartContainer');
        const ctx = document.getElementById('liabilitiesChart');
        if (!ctx || container.style.display === 'none') return;
    
        const cA = "#FF4444"; // è² å‚µç”¨ç´…è‰²ç³»
        const cB = "#800000"; 
        const ids = Object.keys(catSums);
        const colors = ids.map((_, i) => interpolateColor(cA, cB, i / (ids.length > 1 ? ids.length - 1 : 1)));
        const labels = ids.map(id => liabilityCategories.find(c => c.id === id).name);
        const dataValues = ids.map(id => catSums[id]);
    
        if (myLiabChart) {
            myLiabChart.data.labels = labels;
            myLiabChart.data.datasets[0].data = dataValues;
            myLiabChart.data.datasets[0].backgroundColor = colors;
            myLiabChart.update();
        } else {
            myLiabChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: dataValues, backgroundColor: colors, borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
            });
        }
    }

    function interpolateColor(c1, c2, f) {
        const r1 = parseInt(c1.substring(1,3), 16), g1 = parseInt(c1.substring(3,5), 16), b1 = parseInt(c1.substring(5,7), 16);
        const r2 = parseInt(c2.substring(1,3), 16), g2 = parseInt(c2.substring(3,5), 16), b2 = parseInt(c2.substring(5,7), 16);
        return `rgb(${Math.round(r1 + f * (r2-r1))}, ${Math.round(g1 + f * (g2-g1))}, ${Math.round(b1 + f * (b2-b1))})`;
    }

    function renderUI() {
        const saved = JSON.parse(localStorage.getItem('myPortfolio_v5')) || {}, grid = document.getElementById('mainGrid'); grid.innerHTML = '';
        categories.forEach(cat => {
            const data = saved[cat.id] || { target: 20, assets: [], collapsed: false };
            const card = document.createElement('div'); card.id = cat.id; card.className = `category-card ${data.collapsed ? 'collapsed' : ''}`;
            card.innerHTML = `
                <button class="btn-delete-card" onclick="deleteCategory('${cat.id}')">Ã—</button>
                <div class="category-header" onclick="toggleCategory('${cat.id}')">
                    <div><span class="chevron">â–¼</span> <span class="cat-name-text" contenteditable="true" onblur="forceSave()">${cat.name}</span></div>
                    <div onclick="event.stopPropagation()">ç›®æ¨™ <input type="number" class="target-input" value="${data.target}" oninput="calculateAll()"> %<div class="target-amount-label">$0</div></div>
                </div>
                <div class="asset-header-row"><span></span><span>åç¨±</span><span>è‚¡æ•¸</span><span>å–®åƒ¹</span><span>ç¾å€¼</span><span>ç›®æ¨™%</span><span></span></div>
                <div class="asset-list" id="list-${cat.id}"></div>
                <button class="btn" style="padding:6px; font-size:0.8rem;" onclick="addAsset('${cat.id}')">+ æ–°å¢æ¨™çš„</button>
                <div class="card-footer"><div class="footer-row"><span style="font-size:0.75rem; color:#888;">åˆè¨ˆ</span><span class="cat-sum-display">$0</span><span class="current-p">0%</span></div><div class="status-tag status-alert">âœ… æ¯”ä¾‹ç†æƒ³</div></div>
            `;
            grid.appendChild(card);
            if (data.assets && data.assets.length > 0) data.assets.forEach(a => addAsset(cat.id, a.name, a.value, a.targetP, a.qty, a.price));
            else addAsset(cat.id);
            new Sortable(document.getElementById(`list-${cat.id}`), { animation: 150, delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5, onEnd: () => calculateAll() });
        });
        new Sortable(grid, { animation: 150, handle: '.category-header', delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5, onEnd: () => calculateAll() });
        calculateAll();
    }

    function addAsset(catId, name='', value=0, targetP=0, qty='', price='') {
        const list = document.getElementById(`list-${catId}`); if(!list) return;
        const div = document.createElement('div'); div.className = 'asset-item';
        const qD = (qty === '' || qty == 0) ? '-' : formatNum(qty), pD = (price === '' || price == 0) ? '-' : formatNum(price);
        div.innerHTML = `
            <button class="btn-delete-left" onclick="this.closest('.asset-item').remove(); calculateAll();">Ã—</button>
            <div><div class="static-view" onclick="editMode(this)">${name||'é»æ“Šè¼¸å…¥'}</div><div class="edit-container"><input type="text" class="edit-input asset-name" list="stockList" value="${name}" onblur="autoViewMode(this)"></div></div>
            <div><div class="static-view" onclick="editMode(this)">${qD}</div><div class="edit-container"><input type="number" class="edit-input asset-qty" value="${qty}" onblur="autoViewMode(this)"></div></div>
            <div><div class="static-view" onclick="editMode(this)">${pD}</div><div class="edit-container"><input type="number" class="edit-input asset-price" value="${price}" onblur="autoViewMode(this)"></div></div>
            <div><div class="static-view" onclick="editMode(this)">${formatCurrency(value)}</div><div class="edit-container prefix"><input type="number" class="edit-input asset-value" value="${value}" onblur="autoViewMode(this)"></div></div>
            <div><div class="static-view" onclick="editMode(this)">${targetP}%</div><div class="edit-container suffix"><input type="number" class="target-p-input edit-input" value="${targetP}" onblur="autoViewMode(this)"></div></div>
            <div style="font-size:10px; font-weight:bold; text-align:right;"><div class="ratio-val">0%</div><div class="diff-suggestion" style="font-size:8px;"></div></div>
        `;
        list.appendChild(div);
    }

    function addCategory() { categories.push({ id: 'cat_'+Date.now(), name: 'æ–°å€åŸŸ' }); renderUI(); }
    function deleteCategory(id) { if (confirm('æ˜¯å¦ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) { categories = categories.filter(c => c.id !== id); renderUI(); forceSave(); } }
    function toggleCategory(id) {
    // å¦‚æœé»æ“Šçš„æ˜¯è¼¸å…¥æ¡† (INPUT) æˆ–æ­£åœ¨ç·¨è¼¯æ–‡å­— (contenteditable)ï¼Œå‰‡ä¸è§¸ç™¼æ”¶åˆ
        const target = event.target;
        if (target.tagName === 'INPUT' || target.isContentEditable) {
            return;
        }
    
        document.getElementById(id).classList.toggle('collapsed');
        forceSave();
    }
    function toggleChart() { const c = document.getElementById('chartContainer'); c.style.display = c.style.display === 'none' ? 'block' : 'none'; calculateAll(); }
    function toggleLiabChart() {const c = document.getElementById('liabChartContainer');c.style.display = c.style.display === 'none' ? 'block' : 'none';renderLiabilities(); // é‡æ–°æ¸²æŸ“ä¾†è§¸ç™¼åœ–è¡¨æ›´æ–°}
    function clearAll() { if (confirm('æ˜¯å¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡ç½®ï¼Ÿ')) { localStorage.clear(); location.reload(); } }
  
    
    // 1. è² å‚µæ•¸æ“šçµæ§‹
    let liabilityCategories = [];
                                
    
    // 2. æ–°å¢è² å‚µåˆ†é¡
    function addLiabilityCategory() {
        const name = prompt("è«‹è¼¸å…¥è² å‚µåˆ†é¡åç¨±ï¼ˆä¾‹å¦‚ï¼šéŠ€è¡Œè²¸æ¬¾ã€ä¿¡ç”¨å¡ã€ç§äººå€Ÿè²¸ï¼‰");
        if (!name) return;
        const id = 'liab-' + Date.now();
        liabilityCategories.push({ id: id, name: name, items: [] });
        renderLiabilities();
    }
    
    // 3. æ¸²æŸ“è² å‚µç•«é¢
    function renderLiabilities() {
        const grid = document.getElementById('liabilitiesGrid');
        if (!grid) return;
        grid.innerHTML = '';
        let totalLiab = 0;
        let catSums = {};
    
        liabilityCategories.forEach(cat => {
            let catSum = 0;
            const card = document.createElement('div');
            card.className = `category-card ${cat.collapsed ? 'collapsed' : ''}`;
            card.id = cat.id;
    
            let itemsHtml = cat.items.map((item, index) => {
                const val = parseFloat(item.value) || 0;
                catSum += val;
                return `
                    <div class="asset-item">
                        <input type="text" class="edit-input" value="${item.name}" 
                               onchange="updateLiabItem('${cat.id}', ${index}, 'name', this.value)" placeholder="å‚µå‹™åç¨±">
                        <input type="number" class="edit-input asset-value" value="${item.value}" 
                               oninput="updateLiabItem('${cat.id}', ${index}, 'value', this.value)" placeholder="é‡‘é¡">
                        <button onclick="deleteLiabItem('${cat.id}', ${index})" class="btn-delete-left">Ã—</button>
                    </div>
                `;
            }).join('');
    
            card.innerHTML = `
                <div class="category-header" onclick="toggleLiabCategory('${cat.id}')">
                    <div><span class="chevron">â–¼</span> <span class="cat-name-text">${cat.name}</span></div>
                    <div class="cat-sum-display">${formatCurrency(catSum)}</div>
                </div>
                <div class="asset-list">
                    ${itemsHtml}
                    <button class="btn" style="padding:8px; font-size:0.85rem; margin-top:5px;" onclick="addLiabItem('${cat.id}')">+ æ–°å¢é …ç›®</button>
                    <div style="text-align:right; margin-top:15px;">
                        <button onclick="deleteLiabCategory('${cat.id}')" style="font-size:11px; color:#888; background:none; border:none; cursor:pointer; text-decoration:underline;">ğŸ—‘ï¸ åˆªé™¤æ•´å€‹åˆ†é¡</button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
            totalLiab += catSum;
            catSums[cat.id] = catSum;
        });
    
        // æ›´æ–°é¡¯ç¤ºèˆ‡å„²å­˜
        const summaryEl = document.getElementById('liabilitiesSummary');
        if (summaryEl) summaryEl.innerText = formatCurrency(totalLiab);
        updateDashboardLiabilities(totalLiab);
        updateLiabChart(catSums, totalLiab); // æ›´æ–°åœ–è¡¨
        saveLiabilities();
    }

    // æ–°å¢é€™å€‹å‡½å¼ä¾†æ§åˆ¶è² å‚µå¡ç‰‡çš„æ”¶åˆ
    function toggleLiabCategory(id) {
        const cat = liabilityCategories.find(c => c.id === id);
        if (cat) {
            cat.collapsed = !cat.collapsed; // åˆ‡æ›æ•¸æ“šè£¡çš„ç‹€æ…‹
            const el = document.getElementById(id);
            if (el) el.classList.toggle('collapsed'); // åˆ‡æ› CSS æ¨£å¼
            saveLiabilities(); // å„²å­˜ç‹€æ…‹
        }
    }
    
    // 4. è¼”åŠ©å‡½å¼ï¼šæ–°å¢/ä¿®æ”¹/åˆªé™¤
    function addLiabItem(catId) {
        const cat = liabilityCategories.find(c => c.id === catId);
        cat.items.push({ name: '', value: 0 });
        renderLiabilities();
    }
    
    function updateLiabItem(catId, index, key, val) {
        const cat = liabilityCategories.find(c => c.id === catId);
        cat.items[index][key] = val;
        renderLiabilities();
    }
    
    function deleteLiabItem(catId, index) {
        const cat = liabilityCategories.find(c => c.id === catId);
        cat.items.splice(index, 1);
        renderLiabilities();
    }
    
    function deleteLiabCategory(catId) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ•´å€‹åˆ†é¡å—ï¼Ÿ")) {
            liabilityCategories = liabilityCategories.filter(c => c.id !== catId);
            renderLiabilities();
        }
    }
    
    // 5. å„²å­˜åŠŸèƒ½
    function saveLiabilities() {
        localStorage.setItem('liabilityData_v1', JSON.stringify(liabilityCategories));
    }
    
    // 6. è¼‰å…¥åŠŸèƒ½ (æ”¾åœ¨ window.onload è£¡é¢)
    function loadLiabilities() {
        const data = localStorage.getItem('liabilityData_v1');
        if (data) {
            liabilityCategories = JSON.parse(data);
        } else {
            // å¦‚æœæ²’æœ‰èˆŠè³‡æ–™ï¼Œé è¨­ä¸€å¼µå¡ç‰‡
            const defaultId = 'liab-' + Date.now();
            liabilityCategories = [{
                id: defaultId,
                name: "è«‹è¼¸å…¥è² å‚µåç¨±", // é€™è£¡å¯ä»¥æ”¹æˆä½ æƒ³è¦çš„åˆ†é¡åï¼Œä¾‹å¦‚ã€Œä¿¡ç”¨å¡èˆ‡è²¸æ¬¾ã€
                items: [],
                collapsed: false
            }];
        }
        renderLiabilities();
    }

    // è£œä¸Šé€™ä¸€æ®µï¼Œä¸»é æ•¸å­—æ‰æœƒå‹•
    function updateDashboardLiabilities(totalLiab) {
        const dashLiab = document.getElementById('dash-total-liabilities');
        const dashNet = document.getElementById('dash-net-worth');
        const dashAssets = document.getElementById('dash-total-assets');
    
        // å¾ä¸»é æŠ“å–ç›®å‰çš„è³‡ç”¢æ•¸å­—ï¼ˆæŠŠ $ å’Œ , æ‹¿æ‰è½‰æˆç´”æ•¸å­—ï¼‰
        const totalAssets = parseFloat(dashAssets.innerText.replace(/[$,]/g, '')) || 0;
    
        // 1. æ›´æ–°ä¸»é çš„ç¸½è² å‚µæ–‡å­—
        if (dashLiab) dashLiab.innerText = formatCurrency(totalLiab);
        
        // 2. æ›´æ–°ä¸»é çš„æ·¨è³‡ç”¢ (è³‡ç”¢ - è² å‚µ)
        if (dashNet) dashNet.innerText = formatCurrency(totalAssets - totalLiab);
    }
    
    window.onload = () => { loadStockData(); const s = localStorage.getItem('catConfig_v5'); categories = s ? JSON.parse(s) : DEFAULT_CONFIG.map(d => ({ id: d.id, name: d.name })); renderUI(); setTheme(localStorage.getItem('userTheme') || 'orange'); showPage('home-view');};
</script>
</body>
</html>
