<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Engine</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root { --theme-accent: #FF8C42; --theme-bg: #3D2B1F; --gray-marble: #F0F0F0; --radius: 12px; }
        [data-theme="orange"] { --theme-accent: #FF8C42; --theme-bg: #3D2B1F; }
        [data-theme="forest"] { --theme-accent: #dac4fc; --theme-bg: #293d0b; }
        [data-theme="wine"]   { --theme-accent: #80C5DE; --theme-bg: #6e0000; }
        [data-theme="purple"] { --theme-accent: #B4D355; --theme-bg: #6245b7; }
        [data-theme="navy"]   { --theme-accent: #e4d9c4; --theme-bg: #1b2941; }
        [data-theme="amber"]  { --theme-accent: #0045c6; --theme-bg: #F0A650; }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        body { background-color: var(--gray-marble); color: #3D2B1F; font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 50px; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 20px 12px; }

        h1 { border: 4px solid #1A1A1A; text-align: center; margin-bottom: 20px; background: var(--theme-accent); padding: 15px; box-shadow: 6px 6px 0px #000; border-radius: var(--radius); color: var(--theme-bg); font-weight: 900; }

        .category-card { background: #fff; border: 4px solid #1A1A1A; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); position: relative; }
        .category-header { background: var(--theme-bg); color: var(--theme-accent); padding: 12px 15px; display: flex; align-items: center; cursor: pointer; user-select: none; }
        .category-content { padding: 12px; }
        .collapsed .category-content { display: none; }
        
        .arrow-icon { font-size: 10px; margin-right: 8px; transition: transform 0.2s; }
        .collapsed .arrow-icon { transform: rotate(-90deg); }

        .btn-delete-card { position: absolute; top: -10px; right: -10px; width: 28px; height: 28px; background: var(--theme-accent); border: 3px solid #1A1A1A; border-radius: 50%; color: var(--theme-bg); font-weight: 900; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 2px 2px 0px #000; z-index: 10; }

        .grid-row { display: grid; grid-template-columns: 20px 1fr 0.6fr 0.7fr 0.6fr 1.1fr 0.5fr; gap: 4px; align-items: center; margin-bottom: 10px; }
        .label-text { font-size: 8px; font-weight: 900; color: #bbb; text-align: center; margin-bottom: 2px; }

        .static-view { background: #1A1A1A; color: white; padding: 6px 2px; font-size: 10px; text-align: center; min-height: 34px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 900; cursor: pointer; overflow: hidden; }
        .view-price { background: #F0F0F0; color: #1A1A1A; border: 1px solid #DDD; cursor: default; } 

        .edit-container { position: relative; display: none; width: 100%; }
        .edit-input { width: 100%; height: 34px; border: 2px solid #1A1A1A; border-radius: 6px; text-align: center; font-weight: bold; font-size: 11px; outline: none; background: #FFF; }
        
        .search-results { position: absolute; top: 36px; left: 0; right: 0; background: white; border: 3px solid #1A1A1A; border-radius: 8px; z-index: 1000; max-height: 150px; overflow-y: auto; display: none; box-shadow: 4px 4px 0px #000; }
        .search-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 10px; display: flex; justify-content: space-between; font-weight: bold; color: #333; }

        .item-total { font-size: 10px; font-weight: 900; text-align: right; }
        .rebalance-tip { font-size: 8px; font-weight: bold; display: block; text-align: right; margin-top: 1px; }

        .theme-options { display: none; gap: 8px; margin: 10px 0; justify-content: flex-end; }
        .theme-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #1A1A1A; cursor: pointer; position: relative; overflow: hidden; padding: 0; }
        .theme-btn span { position: absolute; top: 0; height: 100%; width: 50%; }

        .btn { background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; padding: 12px; font-weight: bold; width: 100%; border-radius: var(--radius); box-shadow: 4px 4px 0px #000; cursor: pointer; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align:right;">
        <span onclick="document.querySelector('.theme-options').style.display='flex'" style="cursor:pointer; font-size:12px; font-weight:bold; background:#FFF; padding:4px 10px; border:2px solid #000; border-radius:20px;">ğŸ¨ ä¸»é¡Œé…è‰²</span>
        <div class="theme-options">
            <button class="theme-btn" onclick="setTheme('orange')"><span style="left:0; background:#3D2B1F"></span><span style="right:0; background:#FF8C42"></span></button>
            <button class="theme-btn" onclick="setTheme('forest')"><span style="left:0; background:#293d0b"></span><span style="right:0; background:#dac4fc"></span></button>
            <button class="theme-btn" onclick="setTheme('wine')"><span style="left:0; background:#6e0000"></span><span style="right:0; background:#80C5DE"></span></button>
            <button class="theme-btn" onclick="setTheme('purple')"><span style="left:0; background:#6245b7"></span><span style="right:0; background:#B4D355"></span></button>
            <button class="theme-btn" onclick="setTheme('navy')"><span style="left:0; background:#1b2941"></span><span style="right:0; background:#e4d9c4"></span></button>
            <button class="theme-btn" onclick="setTheme('amber')"><span style="left:0; background:#0045c6"></span><span style="right:0; background:#F0A650"></span></button>
        </div>
    </div>

    <h1>Portfolio Engine<br><span style="font-size: 0.6em;">è³‡ç”¢çµ„åˆè¨ˆç®—å™¨</span></h1>

    <div class="category-card" style="padding:20px; border-width: 4px;">
        <div style="font-size: 0.8rem; font-weight: 900; color: #888; margin-bottom: 10px;">TOTAL ASSETS | ç¸½ç¾å€¼</div>
        <div id="rebalanceSummary" style="font-size: 2.4rem; font-weight: 900;">$0</div>
    </div>

    <div id="mainGrid"></div>
    <button class="btn" onclick="addCategory()">+ æ–°å¢æŠ•è³‡å€åŸŸ</button>
</div>

<script>
    let categories = [], STOCK_DB = [], EX_RATE = 32.5;
    // è«‹ç¢ºèªæ­¤ç¶²å€æ˜¯å¦æ­£ç¢ºä¸”å·²ç™¼ä½ˆç‚ºã€Œä»»ä½•äººã€çš†å¯å­˜å–
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkSEPMNB8ApKn9N5fFjKjpTblkgvjOcJ1TE8r5SGC_rj2gNG8N2uKNCX92TxtJy9BL/exec";

    function formatCurrency(num) { return "$" + Math.round(num || 0).toLocaleString(); }

    function handleSearch(inputEl) {
        const query = inputEl.value.toString().toUpperCase();
        const resEl = inputEl.parentElement.querySelector('.search-results');
        if (!query || STOCK_DB.length === 0) { resEl.style.display = 'none'; return; }
        const filtered = STOCK_DB.filter(item => item.s.toString().includes(query) || (item.n && item.n.includes(query))).slice(0, 10);
        if (filtered.length > 0) {
            resEl.innerHTML = filtered.map(item => `<div class="search-item" onmousedown="pickStock(this, '${item.s}', '${item.m}', '${item.n}')"><span>${item.s}</span><span style="color:#888; font-size:9px;">${item.n || ''}</span></div>`).join('');
            resEl.style.display = 'block';
        } else { resEl.style.display = 'none'; }
    }

    async function pickStock(el, s, m, n) {
        const row = el.closest('.grid-row');
        const nameInput = row.querySelector('.asset-name');
        const priceView = row.querySelector('.view-price');
        const priceHidden = row.querySelector('.asset-price');
        const marketHidden = row.querySelector('.asset-market');

        nameInput.value = s;
        marketHidden.value = m;
        priceView.innerText = "è®€å–ä¸­...";
        
        try {
            // å¼·åˆ¶ä½¿ç”¨ JSONP æˆ–ç¢ºä¿ä¼ºæœå™¨å…è¨± CORS
            const response = await fetch(`${SCRIPT_URL}?s=${s}&m=${m}`);
            const data = await response.json();
            const price = parseFloat(data.price);
            
            if (!isNaN(price)) {
                priceHidden.value = price;
                priceView.innerText = (m === 'US' ? 'ğŸ‡ºğŸ‡¸' : '') + price;
                calculateAll(); // æˆåŠŸè®€å–å¾Œç«‹åˆ»é‡ç®—ç¸½åƒ¹
            } else {
                priceView.innerText = "ç„¡å ±åƒ¹";
            }
        } catch (e) {
            console.error("Fetch Error:", e);
            priceView.innerText = "å¤±æ•—";
        }
        
        el.parentElement.style.display = 'none';
        autoViewMode(nameInput);
    }

    function addAsset(catId, name='', qty=0, price=0, targetP=0, market='TPE') {
        const list = document.getElementById(`list-${catId}`);
        if (!list) return;
        const div = document.createElement('div');
        div.className = 'grid-row';
        div.innerHTML = `
            <button onclick="this.closest('.grid-row').remove(); calculateAll();" style="border:none; background:none; color:#FF4444; font-size:16px; font-weight:bold; cursor:pointer;">Ã—</button>
            <div style="position:relative;">
                <div class="static-view" onclick="editMode(this)">${name || 'æœå°‹'}</div>
                <div class="edit-container">
                    <input type="text" class="edit-input asset-name" value="${name}" oninput="handleSearch(this)" onblur="autoViewMode(this)">
                    <div class="search-results"></div>
                </div>
            </div>
            <div>
                <div class="static-view" style="background:#888;" onclick="editMode(this)">${qty}</div>
                <div class="edit-container"><input type="number" class="edit-input asset-qty" value="${qty}" oninput="calculateAll()" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <input type="hidden" class="asset-market" value="${market}">
                <input type="hidden" class="asset-price" value="${price}">
                <div class="static-view view-price">${price > 0 ? (market==='US'?'ğŸ‡ºğŸ‡¸':'')+price : '---'}</div>
            </div>
            <div>
                <div class="static-view" style="background:#666;" onclick="editMode(this)">${targetP}%</div>
                <div class="edit-container"><input type="number" class="edit-input asset-target" value="${targetP}" oninput="calculateAll()" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <div class="item-total">$0</div>
                <span class="rebalance-tip">--</span>
            </div>
            <div class="item-ratio" style="font-size:9px; font-weight:900; text-align:center;">0%</div>
        `;
        list.appendChild(div);
        calculateAll();
    }

    function calculateAll() {
        let grandTotal = 0, catSums = {};
        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if (!card) return;
            let sum = 0;
            card.querySelectorAll('.grid-row').forEach(row => {
                const q = parseFloat(row.querySelector('.asset-qty')?.value || row.querySelector('.edit-input.asset-qty')?.value) || 0;
                const p = parseFloat(row.querySelector('.asset-price').value) || 0;
                const m = row.querySelector('.asset-market').value;
                const sub = (m === 'US' ? p * EX_RATE : p) * q;
                row._subtotal = sub;
                sum += sub;
                row.querySelector('.item-total').innerText = formatCurrency(sub);
            });
            catSums[cat.id] = sum;
            grandTotal += sum;
        });

        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            const sum = catSums[cat.id];
            card.querySelector('.cat-sum').innerText = formatCurrency(sum);
            card.querySelector('.cat-ratio').innerText = grandTotal > 0 ? (sum / grandTotal * 100).toFixed(1) + "%" : "0%";
            
            card.querySelectorAll('.grid-row').forEach(row => {
                const targetP = parseFloat(row.querySelector('.edit-input.asset-target')?.value || row.querySelector('.asset-target')?.innerText) || 0;
                row.querySelector('.item-ratio').innerText = sum > 0 ? (row._subtotal / sum * 100).toFixed(1) + "%" : "0%";
                const tip = row.querySelector('.rebalance-tip');
                if (sum > 0 && targetP > 0) {
                    const diff = row._subtotal - (sum * (targetP / 100));
                    if (Math.abs(diff) < 10) tip.innerHTML = `<span style="color:#bbb">å¹³è¡¡</span>`;
                    else tip.innerHTML = diff > 0 ? `<span style="color:#FF4444">ç§»å‡º${Math.round(diff)}</span>` : `<span style="color:#008800">è£œå…¥${Math.round(Math.abs(diff))}</span>`;
                }
            });
        });
        document.getElementById('rebalanceSummary').innerText = formatCurrency(grandTotal);
        saveData();
    }

    function renderUI() {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = '';
        categories.forEach(cat => {
            const card = document.createElement('div');
            card.id = cat.id;
            card.className = `category-card ${cat.collapsed ? 'collapsed' : ''}`;
            card.innerHTML = `
                <button class="btn-delete-card" onclick="deleteCategory('${cat.id}')">Ã—</button>
                <div class="category-header" onclick="toggleCollapse('${cat.id}')">
                    <span class="arrow-icon">â–¼</span>
                    <span onclick="event.stopPropagation(); editCatName('${cat.id}')" style="font-weight:900; flex:1;">${cat.name}</span>
                    <div style="font-size:11px; font-weight:900;" onclick="event.stopPropagation(); editCatTarget('${cat.id}')">ç›®æ¨™ ${cat.target}%</div>
                </div>
                <div class="category-content">
                    <div class="grid-row" style="opacity:0.4;"><div class="label-text"></div><div class="label-text">æ¨™çš„</div><div class="label-text">è‚¡æ•¸</div><div class="label-text">å–®åƒ¹</div><div class="label-text">ç›®æ¨™%</div><div class="label-text">ç¸½ç¾å€¼</div><div class="label-text">å€åŸŸæ¯”</div></div>
                    <div id="list-${cat.id}" class="asset-list"></div>
                    <button class="btn" style="padding:6px; font-size:11px; margin-top:10px;" onclick="addAsset('${cat.id}')">+ æ–°å¢æ¨™çš„</button>
                    <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #ddd; display:flex; justify-content:space-between; align-items:center;">
                        <span class="cat-sum" style="font-size:1.1rem; font-weight:900;">$0</span>
                        <span class="cat-ratio" style="font-size:11px; font-weight:bold;">0%</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
        initSortable();
    }

    function addCategory() {
        const id = 'cat_' + Date.now();
        categories.push({ id, name: "æ–°å€åŸŸ", target: 20, collapsed: false });
        renderUI();
        addAsset(id);
    }

    function editCatName(id) { const n = prompt("å€åŸŸåç¨±ï¼š"); if(n) { categories.find(c => c.id === id).name = n; renderUI(); calculateAll(); } }
    function editCatTarget(id) { const t = prompt("å æ¯” (%)ï¼š"); if(t) { categories.find(c => c.id === id).target = parseInt(t); renderUI(); calculateAll(); } }
    function deleteCategory(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { categories = categories.filter(c => c.id !== id); renderUI(); calculateAll(); } }
    function toggleCollapse(id) { categories.find(c => c.id === id).collapsed = !categories.find(c => c.id === id).collapsed; document.getElementById(id).classList.toggle('collapsed'); saveData(); }

    function editMode(el) { el.style.display='none'; el.nextElementSibling.style.display='block'; el.nextElementSibling.querySelector('input').focus(); }
    function autoViewMode(inputEl) {
        setTimeout(() => {
            if (document.activeElement && document.activeElement.closest('.search-results')) return;
            const container = inputEl.parentElement;
            const view = container.previousElementSibling;
            view.innerText = inputEl.value + (inputEl.classList.contains('asset-target') ? '%' : '');
            container.style.display='none'; view.style.display='flex';
            calculateAll();
        }, 200);
    }

    function initSortable() {
        new Sortable(document.getElementById('mainGrid'), { delay: 400, delayOnTouchOnly: true, animation: 150, onEnd: () => {
            const newOrder = Array.from(document.getElementById('mainGrid').children).map(el => el.id);
            categories.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
            saveData();
        }});
        document.querySelectorAll('.asset-list').forEach(list => {
            new Sortable(list, { delay: 400, delayOnTouchOnly: true, animation: 150, onEnd: calculateAll });
        });
    }

    function saveData() {
        const data = {};
        categories.forEach(cat => {
            const list = [];
            document.querySelectorAll(`#list-${cat.id} .grid-row`).forEach(row => {
                const name = row.querySelector('.asset-name').value;
                if(name) {
                    list.push({ 
                        name: name, 
                        qty: row.querySelector('.asset-qty').value || row.querySelector('.edit-input.asset-qty')?.value, 
                        value: row.querySelector('.asset-price').value, 
                        targetP: row.querySelector('.edit-input.asset-target')?.value || 0, 
                        market: row.querySelector('.asset-market').value 
                    });
                }
            });
            data[cat.id] = { assets: list };
        });
        localStorage.setItem('myPortfolio_v9', JSON.stringify({ categories, details: data }));
    }

    window.onload = async () => {
        try {
            const response = await fetch('csvjson.json');
            STOCK_DB = await response.json();
        } catch (e) { console.error("Database failed:", e); }

        const saved = JSON.parse(localStorage.getItem('myPortfolio_v9'));
        if (saved) {
            categories = saved.categories;
            renderUI();
            categories.forEach(cat => {
                const details = saved.details[cat.id];
                if (details) details.assets.forEach(a => addAsset(cat.id, a.name, a.qty, a.value, a.targetP, a.market));
            });
        } else { addCategory(); }
        setTheme(localStorage.getItem('userTheme') || 'orange');
    };

    function setTheme(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('userTheme', t); }
</script>
</body>
</html>
