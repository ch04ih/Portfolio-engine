<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Engine Pro</title>
    
    <link id="apple-icon" rel="apple-touch-icon" href="icon-orange.png?v=4">
    <link id="favicon" rel="icon" type="image/png" href="icon-orange.png?v=4">
    <meta name="apple-mobile-web-app-title" content="æŠ•è³‡é…æ¯”">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --theme-accent: #F0A650;
            --theme-bg: #0045c6;
            --theme-accent-rgb: 255, 140, 66;
            --gray-marble: #F0F0F0;
            --radius: 12px;
            --border-dark: #1A1A1A;
        }
        body.night-mode { background-color: #2d2d2d; --border-dark: #5a5a5a; }
        [data-theme="orange"] { --theme-accent: #FF8C42; --theme-bg: #3D2B1F; --theme-accent-rgb: 255, 140, 66; }
        [data-theme="forest"] { --theme-accent: #dac4fc; --theme-bg: #293d0b; --theme-accent-rgb: 218, 196, 252; }
        [data-theme="wine"]   { --theme-accent: #80C5DE; --theme-bg: #6e0000; --theme-accent-rgb: 128, 197, 222; }
        [data-theme="purple"] { --theme-accent: #B4D355; --theme-bg: #6245b7; --theme-accent-rgb: 180, 211, 85; }
        [data-theme="navy"]   { --theme-accent: #e4d9c4; --theme-bg: #1b2941; --theme-accent-rgb: 228, 217, 196; }
        [data-theme="amber"]  { --theme-accent: #F0A650; --theme-bg: #0045c6; --theme-accent-rgb: 240, 166, 80; }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: var(--gray-marble); color: #3D2B1F; font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; overflow-x: hidden; width: 100%; transition: background-color 0.2s ease; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 20px 15px; }

        h1 { border: 4px solid var(--border-dark); text-align: center; margin: 0; background: var(--theme-accent); padding: 15px 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.08); border-radius: var(--radius); color: var(--theme-bg); font-weight: 900; line-height: 1.2; }
        #home-view h1 { margin-bottom: 12px; }
        
        .save-status { text-align: center; font-size: 10px; font-weight: bold; margin: 10px 0 20px 0; color: #888; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .status-dot.active { background: #00C853; box-shadow: 0 0 8px #00C853; }

        .rebalance-panel { background: white; border: 4px solid var(--border-dark); padding: 20px; margin-bottom: 25px; box-shadow: 0 6px 20px rgba(0,0,0,0.10); border-radius: var(--radius); }
        .chart-btn { background: var(--theme-accent); color: var(--theme-bg); border: 2px solid var(--border-dark); padding: 5px 10px; font-size: 0.7rem; font-weight: 900; border-radius: 6px; cursor: pointer; box-shadow: none; white-space: nowrap; flex-shrink: 0; }

        .category-card { background: #fff; border: 4px solid var(--theme-accent); padding: 15px; margin: 0; box-shadow: 0 8px 22px rgba(0,0,0,0.10); border-radius: var(--radius); position: relative; max-width: 100%; overflow: visible; }
        .category-header { background: #fff; color: #1A1A1A; padding: 12px 15px; margin: 0 0 10px 0; display: flex; flex-direction: column; gap: 4px; justify-content: center; align-items: center; border-radius: 8px; cursor: pointer; text-align: center; }
        .category-card:not(.collapsed) .category-header { flex-direction: row; text-align: left; justify-content: space-between; align-items: center; }
        .category-card:not(.collapsed) .category-header > div:nth-child(1) { flex: 0 0 auto; }
        .category-card:not(.collapsed) .category-header > div:nth-child(2) { flex: 1 1 auto; text-align: center; font-weight: 900; }
        .category-header .cat-name-text { font-size: 0.9rem; font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 7em; max-width: 7em; display: inline-block; }
        .simple-asset-header .fixed-name-text, .simple-asset-header .recv-name-text, .liab-header .liab-name-text { font-size: 0.9rem; font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 7em; max-width: 7em; display: inline-block; }
        .category-card:not(.collapsed) .category-header > div:nth-child(3) { flex: 0 0 auto; text-align: right; }
        .card-subtitle { font-size: 10px; color: #888; margin-top: -2px; display: none; text-align: center; }
        .category-card.collapsed .card-subtitle { display: none; }
        .category-header .target-edit { margin-top: 0; }

        /* å¡ç‰‡æ¨£å¼ï¼ˆè² å‚µèˆ‡ç°¡æ˜“è³‡ç”¢å…±äº«ï¼‰ */
        .liab-card, .simple-asset-card { background: #fff; border: 4px solid var(--theme-accent); padding: 15px; margin: 0; box-shadow: 0 6px 18px rgba(0,0,0,0.10); border-radius: var(--radius); position: relative; max-width: 100%; overflow: visible; }
        .liab-header, .simple-asset-header { background: #fff; color: #1A1A1A; padding: 12px 15px; margin: 0 0 10px 0; display: flex; flex-direction: column; gap: 6px; justify-content: center; align-items: center; border-radius: 8px; cursor: pointer; text-align: center; }
        .liab-card:not(.collapsed) .liab-header, .simple-asset-card:not(.collapsed) .simple-asset-header { flex-direction: row; text-align: left; justify-content: space-between; align-items: center; }

        .btn-delete-card { display: none !important; }

        .target-input { width: 42px; background: var(--theme-accent); color: var(--theme-bg); border: 1px solid var(--border-dark); font-weight: bold; text-align: center; border-radius: 6px; padding: 2px; -moz-appearance: textfield; }
        .target-input::-webkit-outer-spin-button, .target-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .target-display { font-size: 10px; color: #888; }
        .category-card.collapsed .target-edit { display: none; }
        .target-amount-label { font-size: 9px; font-weight: 900; opacity: 0.8; text-align: right; margin-top: 2px; letter-spacing: 0.5px; }

        .asset-header-row { display: grid; grid-template-columns: 12px 1.4fr 0.5fr 0.5fr 1.2fr 0.65fr 0.65fr; gap: 6px; padding: 0 0 8px 0; margin-bottom: 5px; border-bottom: 1px solid #DDD; }
        .asset-header-row span { font-size: 9px; font-weight: 900; color: #888; text-align: center; }
        .asset-header-row span:first-child { text-align: center; }

        /* ç°¡åŒ–åˆ—è¡¨æ¬„ä½é…ç½®ï¼ˆåç¨± + é‡‘é¡ï¼Œé å·¦å°é½Šï¼‰ */
        .liab-header-row, .simple-asset-header-row { display: grid; grid-template-columns: 20px 1fr 1fr; gap: 8px; padding: 0 0 8px 0; margin-bottom: 5px; border-bottom: 1px solid #DDD; }
        .liab-header-row span, .simple-asset-header-row span { font-size: 9px; font-weight: 900; color: #888; text-align: left; }
        .liab-header-row span:first-child, .simple-asset-header-row span:first-child { text-align: center; }
        .liab-header-row span:nth-child(2), .simple-asset-header-row span:nth-child(2) { padding-left: 4px; }
        .liab-header-row span:nth-child(3), .simple-asset-header-row span:nth-child(3) { padding-left: 4px; }

        .liab-list, .simple-asset-list { margin-bottom: 15px; min-height: 5px; }
        .liab-item, .simple-asset-item { display: grid; grid-template-columns: 20px 1fr 1fr; gap: 8px; padding: 8px 0; align-items: center; border-bottom: 1px solid #F2F2F2; cursor: grab; }
        .liab-item div:nth-child(2) .static-view,
        .liab-item div:nth-child(2) .edit-input,
        .simple-asset-item div:nth-child(2) .static-view,
        .simple-asset-item div:nth-child(2) .edit-input { justify-content: flex-start; text-align: left; padding-left: 4px; }
        .liab-item div:nth-child(3) .static-view,
        .liab-item div:nth-child(3) .edit-input,
        .simple-asset-item div:nth-child(3) .static-view,
        .simple-asset-item div:nth-child(3) .edit-input { justify-content: flex-start; text-align: left; padding-left: 4px; }

        .asset-list { margin-bottom: 15px; min-height: 5px; }
        .asset-item-wrap { position: relative; overflow: hidden; border-bottom: 1px solid #F2F2F2; }
        .asset-item-delete-reveal { position: absolute; right: 0; top: 0; bottom: 0; width: 56px; background: #e57373; display: flex; align-items: center; justify-content: center; z-index: 0; }
        .asset-item-delete-reveal .asset-item-delete-btn { background: transparent; border: none; color: #fff; font-size: 0.8rem; font-weight: 800; cursor: pointer; padding: 8px; }
        .asset-item { display: grid; grid-template-columns: 1.4fr 0.5fr 0.5fr 1.2fr 0.65fr 0.65fr; gap: 6px; padding: 8px 0; align-items: center; cursor: grab; position: relative; z-index: 1; background: #fff; transition: transform 0.2s ease-out; }
        .asset-item-wrap.reveal .asset-item, .asset-item-wrap.swiped:not(.editing) .asset-item { transform: translateX(-56px); }
        
        .static-view { background: transparent; border: none; color: #333; font-size: 12px; min-height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 500; cursor: pointer; border-radius: 4px; }
        .static-view.empty-placeholder { color: #BBB !important; font-style: italic; }
        .asset-item div:nth-child(1) { min-width: 0; }
        .asset-item div:nth-child(1) .static-view { font-weight: 900; color: #1A1A1A; background-color: #F0F4F8 !important; padding: 0 4px; justify-content: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; } 
        .asset-item div:nth-child(2) .static-view, .asset-item div:nth-child(3) .static-view { font-size: 11px; color: #999; } 
        .asset-item div:nth-child(4) .static-view { font-weight: 900; color: #1A1A1A; justify-content: flex-end; background-color: #FFF9E6 !important; padding-right: 4px; } 
        .asset-item div:nth-child(5) .static-view, .asset-item div:nth-child(6) .static-view { font-size: 11px; color: var(--theme-bg); justify-content: flex-end; opacity: 0.8; } 

        .edit-container { position: relative; display: none; width: 100%; }
        .edit-input { width: 100%; height: 28px; border: 2px solid var(--border-dark); border-radius: 6px; text-align: center; font-weight: bold; background: white; font-size: 12px; outline: none; }
        .edit-container.prefix::before { content: '$'; position: absolute; left: 2px; top: 50%; transform: translateY(-50%); font-weight: 900; font-size: 9px; color: #1A1A1A; z-index: 2; }
        .edit-container.suffix::after { content: '%'; position: absolute; right: 2px; top: 50%; transform: translateY(-50%); font-weight: 900; font-size: 9px; color: #1A1A1A; z-index: 2; }
        .edit-input[type="number"] { text-align: center; padding-right: 0; }
        .edit-container.prefix .edit-input { padding-left: 16px; }
        .edit-container.suffix .edit-input { padding-right: 16px; }
        /* åƒ…åœ¨å›ºå®šè³‡ç”¢ã€æ‡‰æ”¶å¸³æ¬¾èˆ‡è² å‚µé é¢ä½¿ç”¨å³å°é½Šèˆ‡åŠ å¤§å…§è· */
        .simple-asset-card .edit-input[type="number"], .liab-card .edit-input[type="number"] { text-align: right; padding-right: 24px; }
        .simple-asset-card .edit-container.prefix::before, .liab-card .edit-container.prefix::before { left: 10px; font-size: 11px; }
        .simple-asset-card .edit-container.prefix .edit-input, .liab-card .edit-container.prefix .edit-input { padding-left: 32px; }

        /* æ”¶åˆç£è²¼ä¸‰æ¬„æ’ç‰ˆèˆ‡å¡ç‰‡å¯¬åº¦æ§åˆ¶ */
        #mainGrid, #fixedGrid, #recvGrid, #liabGrid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            column-gap: 18px;
            row-gap: 18px;
            width: 100%;
            box-sizing: border-box;
        }
        #mainGrid + .btn { margin-top: 18px; }
        #fixedGrid + .btn { margin-top: 18px; }
        #recvGrid + .btn { margin-top: 18px; }
        #liabGrid + .btn { margin-top: 18px; }
        .category-card, .liab-card, .simple-asset-card { grid-column: 1 / -1; }
        .category-card.collapsed, .liab-card.collapsed, .simple-asset-card.collapsed { grid-column: span 1; padding: 7px; min-height: 80px; width: 100%; border-width: 3px; }
        .liab-card.collapsed, .simple-asset-card.collapsed { min-height: 72px; }
        .liab-card .current-p, .simple-asset-card .current-p { display: none; }
        .category-card.collapsed .category-header, .liab-card.collapsed .liab-header, .simple-asset-card.collapsed .simple-asset-header { padding: 5px 9px; gap: 8px; }
        .category-card.collapsed .card-footer, .liab-card.collapsed .card-footer, .simple-asset-card.collapsed .card-footer { margin-top: 5px; padding-top: 5px; }
        .card-emoji { margin: 0 6px; }
        .card-icon { width: 40px; height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
        .card-icon svg { width: 22px; height: 22px; stroke: #fff; fill: none; stroke-width: 2; }
        .sheet #sheetContent { padding: 24px 12px 16px; }
        .sheet-tools { background: transparent; border-top: none; color: inherit; }
        .icon-grid, .color-grid { background: transparent; border: 3px solid var(--border-dark); border-radius: 12px; min-height: 44px; }
        .icon-grid .icon-dot, .color-grid .color-dot { min-width: 36px; min-height: 36px; }
        .icon-dot { background: #fff; }
        .color-dot { width: 28px; height: 28px; border: 1px solid var(--border-dark); border-radius: 50%; cursor: pointer; box-shadow: 2px 2px 0 var(--border-dark); }
        .sheet .in-sheet { border-width: 3px; padding: 12px; box-shadow: 0 4px 14px rgba(0,0,0,0.08); }
        .sheet .in-sheet .category-header, .sheet .in-sheet .liab-header, .sheet .in-sheet .simple-asset-header { padding: 10px 12px; margin-bottom: 8px; }
        .sheet .in-sheet .asset-list, .sheet .in-sheet .liab-list, .sheet .in-sheet .simple-asset-list { max-height: 48vh; overflow: auto; border: 1px solid #EEE; border-radius: 8px; padding: 4px 8px; }
        .sheet .in-sheet .card-icon { cursor: pointer; }
        .sheet .in-sheet .card-icon:hover { filter: brightness(1.08); }
        .picker-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.25); z-index: 50; }
        .picker-panel-wrap { position: absolute; left: 50%; top: 50px; transform: translateX(-50%); width: min(92vw, 420px); z-index: 51; display: flex; flex-direction: column; align-items: stretch; }
        .picker-tabs { display: flex; padding: 0 0 0; gap: 6px; background: transparent; box-sizing: border-box; }
        .picker-tab { position: relative; flex: 1; padding: 10px 14px; font-size: 0.85rem; font-weight: 800; border: 3px solid var(--border-dark); border-bottom: none; border-radius: 10px 10px 0 0; cursor: pointer; background: #e8e8e8; color: #555; transition: background 0.15s, color 0.15s; box-sizing: border-box; margin-bottom: -1px; }
        .picker-tab.active { background: #fff; color: #1A1A1A; z-index: 1; }
        .picker-panel.picker-floating { max-height: min(78vh, calc(100vh - 100px)); overflow: hidden; -webkit-overflow-scrolling: touch; background: #fff; border-radius: 0 0 12px 12px; border: 3px solid var(--border-dark); border-top: none; box-shadow: 0 12px 40px rgba(0,0,0,0.22); box-sizing: border-box; padding: 0; padding-top: 8px; padding-bottom: 12px; }
        .picker-panel-inner { min-height: 40px; height: min(52vh, calc(100vh - 138px)); max-height: min(52vh, calc(100vh - 138px)); padding: 16px; padding-bottom: 12px; overflow-y: auto; box-sizing: border-box; }
        .picker-tab-content { display: none; }
        .picker-tab-content.active { display: block; }
        /* picker å…§åœ–ç¤ºï¼è‰²å¡Šï¼šä¾è¢å¹•æ¯”ä¾‹è‡ªé©æ‡‰ï¼Œé¿å…æ“ åœ¨ä¸€èµ· */
        .picker-panel .icon-grid { display: grid; width: 100%; box-sizing: border-box; grid-template-columns: repeat(auto-fill, minmax(min(52px, 20vw), 1fr)); gap: clamp(8px, 2.5vw, 14px); padding: 12px 14px; justify-items: center; }
        .picker-panel .icon-grid .icon-dot { width: clamp(40px, 10vw, 52px); height: clamp(40px, 10vw, 52px); min-width: 40px; min-height: 40px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
        .picker-panel .icon-grid .icon-dot svg { width: clamp(18px, 4.5vw, 24px); height: clamp(18px, 4.5vw, 24px); }
        .picker-panel .color-grid { display: grid; width: 100%; box-sizing: border-box; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(8, auto); gap: 6px; padding: 12px 14px; justify-items: center; align-items: center; margin-bottom: 4px; }
        .picker-panel .color-grid .color-dot { width: clamp(30px, 7.5vw, 44px); height: clamp(30px, 7.5vw, 44px); min-width: 30px; min-height: 30px; border: 2px solid var(--border-dark); box-shadow: none; }
        .picker-panel #iconSectionLabel, .picker-panel #iconSectionLabel2, .picker-panel #colorSectionLabel { margin-bottom: 4px; font-size: 0.7rem; font-weight: 800; color: #666; }
        .picker-panel #iconSectionLabel { margin-top: 0; }
        .picker-panel #iconSectionLabel2 { margin-top: 12px; }
        .picker-panel #colorSectionLabel { margin-top: 0; }
        .picker-panel #iconGridOther { margin-bottom: 4px; }
        .sheet .in-sheet .card-footer { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #E5E5E5; }

        .btn-delete-left { background: transparent; border: none; color: #FF4444; font-size: 18px; cursor: pointer; padding: 0; text-align: center; line-height: 1; }
        .card-footer { margin-top: 14px; padding-top: 14px; border-top: 2px dashed #DDD; }
        .footer-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .category-card .footer-row { flex-direction: column; align-items: center; gap: 4px; }
        .liab-card .footer-row, .simple-asset-card .footer-row { flex-direction: column; align-items: center; gap: 4px; }
        .cat-sum-display, .liab-sum-display, .fixed-sum-display, .recv-sum-display { font-size: 1.15rem; font-weight: 900; min-width: 0; }
        .recv-sum-display { padding-bottom: 6px; }
        .cat-sum-display.sum-len-m, .liab-sum-display.sum-len-m, .fixed-sum-display.sum-len-m, .recv-sum-display.sum-len-m { font-size: 1rem; }
        .cat-sum-display.sum-len-l, .liab-sum-display.sum-len-l, .fixed-sum-display.sum-len-l, .recv-sum-display.sum-len-l { font-size: 0.88rem; }
        .cat-sum-display.sum-len-xl, .liab-sum-display.sum-len-xl, .fixed-sum-display.sum-len-xl, .recv-sum-display.sum-len-xl { font-size: 0.76rem; }
        
        .current-p { font-size: 0.75rem; font-weight: 700; color: #555; margin-top: 2px; }
        .category-card .current-p, .liab-card .current-p, .simple-asset-card .current-p { font-size: 0.7rem; color: #999; opacity: 0.9; margin-top: 0; }
        .current-p.p-high { color: #5A7EA8; opacity: 0.85; }
        .current-p.p-low  { color: #B86B6B; opacity: 0.85; }
        .sum-label { font-size: 0.75rem; font-weight: 800; color: #555; }
        .category-card.collapsed .sum-label, .liab-card.collapsed .sum-label, .simple-asset-card.collapsed .sum-label { display: none; }
        /* å°å¡éšå±¤ï¼šé‡‘é¡ç‚ºä¸»ã€åç¨±ç‚ºè¼”ã€æ¯”ä¾‹ç‚ºè¼”åŠ© */
        .category-card.collapsed .cat-name-text { font-weight: 700; color: #555; font-size: 0.82rem; }
        .category-card.collapsed .cat-sum-display { font-weight: 900; color: #1A1A1A; }
        .category-card.collapsed .current-p { font-size: 0.65rem; font-weight: 600; color: #999; opacity: 1; }
        .category-card.collapsed .current-p.p-high { color: #5A7EA8; }
        .category-card.collapsed .current-p.p-low { color: #B86B6B; }
        .liab-card.collapsed .liab-name-text, .simple-asset-card.collapsed .fixed-name-text, .simple-asset-card.collapsed .recv-name-text { font-weight: 700; color: #555; font-size: 0.82rem; }
        .category-card:not(.collapsed) .footer-row, .liab-card:not(.collapsed) .footer-row, .simple-asset-card:not(.collapsed) .footer-row { flex-direction: row; align-items: center; justify-content: space-between; }
        .category-card:not(.collapsed) .cat-sum-display, .liab-card:not(.collapsed) .liab-sum-display, .simple-asset-card:not(.collapsed) .fixed-sum-display { flex: 1; text-align: center; }
        .category-card:not(.collapsed) .current-p, .liab-card:not(.collapsed) .current-p, .simple-asset-card:not(.collapsed) .current-p { flex: 0 0 auto; text-align: right; }

        .category-card.collapsed .cat-name-text, .liab-card.collapsed .liab-name-text, .simple-asset-card.collapsed .fixed-name-text, .simple-asset-card.collapsed .recv-name-text {
            pointer-events: none;
            user-select: none;
        }

        .status-tag { margin-top: 12px; padding: 10px; text-align: center; font-size: 0.8rem; border-radius: 8px; font-weight: 900; background: rgba(var(--theme-accent-rgb), 0.15); color: var(--theme-bg); border: 1px solid rgba(var(--theme-accent-rgb), 0.3); }
        .btn { background: var(--theme-accent); color: var(--theme-bg); border: 3px solid var(--border-dark); padding: 12px; font-weight: bold; width: 100%; border-radius: var(--radius); box-shadow: none; cursor: pointer; margin-bottom: 10px; font-size: 1rem; }
        .btn-subtle { background: #fff; color: #555; border: 2px solid var(--border-dark); font-weight: 700; }
        
        .chart-wrapper { margin-top: 20px; }
        #chartContainer { display:none; width: 100%; min-height: 250px; height: 250px; position: relative; overflow: hidden; flex-direction: column; }
        #chartContainer .chart-slides { flex: 1; min-height: 0; }
        .chart-slides { display: flex; width: 200%; height: 100%; transition: transform 0.25s ease-out; }
        .chart-slides.show-history { transform: translateX(-50%); }
        .chart-slide { width: 50%; flex-shrink: 0; height: 100%; position: relative; }
        #chartContainer .chart-inner-wrap { position: absolute; inset: 0; width: 100%; height: 100%; }
        .chart-history-inner { position: absolute; inset: 0; display: flex; flex-direction: column; padding: 12px; background: #fff; border-radius: var(--radius); }
        .chart-history-header { margin-bottom: 8px; flex-shrink: 0; }
        .chart-history-header strong { font-size: 0.85rem; }
        .chart-history-canvas-wrap { flex: 1; min-height: 0; position: relative; }
        .chart-history-canvas-wrap canvas { width: 100% !important; height: 100% !important; }
        .chart-history-hint { font-size: 11px; color: #888; margin: 6px 0 0; flex-shrink: 0; }
        .chart-to-history { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.2); background: rgba(255,255,255,0.95); color: #333; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; pointer-events: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #chartContainer:hover .chart-to-history { opacity: 1; pointer-events: auto; }
        .chart-to-pie { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.2); background: rgba(255,255,255,0.95); color: #333; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; pointer-events: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 2; }
        .chart-slide-history:hover .chart-to-pie { opacity: 1; pointer-events: auto; }
        @media (hover: none) {
            .chart-to-history { display: none; }
            .chart-to-pie { display: none; }
            .chart-dots { display: flex !important; }
        }
        .chart-dots { display: none; justify-content: center; gap: 8px; padding: 10px 0 0; }
        .chart-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; transition: background 0.2s; }
        .chart-dot.active { background: #555; }
        #portfolioChart { width: 100% !important; height: auto !important; }
        #liabChartContainer { display:none; margin-top: 20px; width: 100%; height: auto; min-height: 250px; }
        #liabChart { width: 100% !important; height: auto !important; }
        #rebalanceSummary, #fixedRebalanceSummary, #recvRebalanceSummary, #liabRebalanceSummary { font-size: clamp(1.6rem, 7.5vw, 2.2rem) !important; }
        .summary-with-trend { position: relative; display: inline-block; min-height: 1.8em; padding-right: 1.4em; }
        .summary-trend { position: absolute; right: 0; bottom: 2px; font-size: 0.9rem; line-height: 1; font-weight: 900; }
        .summary-trend.up { color: #2E7D32; opacity: 0.65; }
        .summary-trend.down { color: #C62828; opacity: 0.65; }
        .category-card.collapsed { cursor: pointer; }
        @keyframes card-shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }
        .category-card.show-delete, .liab-card.show-delete, .simple-asset-card.show-delete { animation: card-shake 0.35s ease-in-out; }
        @media (max-width: 380px) {
            .cat-sum-display, .liab-sum-display, .fixed-sum-display, .recv-sum-display { font-size: 1rem; }
            .asset-item div:nth-child(5) .static-view { font-size: 11px; }
        }

        .theme-panel { display: flex; flex-direction: row; flex-wrap: wrap; align-items: center; justify-content: flex-end; gap: 8px; margin-bottom: 10px; background: rgba(var(--theme-accent-rgb), 0.12); border-radius: 12px; padding: 8px 12px; }
        .theme-toggle-icon, .hide-toggle-icon { font-size: 0.75rem; font-weight: bold; cursor: pointer; background: white; padding: 6px 12px; border: 2px solid var(--border-dark); border-radius: 20px; box-shadow: none; display: inline-flex; align-items: center; }
        .theme-options { display: none; flex-basis: 100%; width: 100%; gap: 10px; margin-top: 10px; padding: 10px 0 0; border-top: 1px solid rgba(0,0,0,0.08); justify-content: flex-end; flex-wrap: wrap; }
        .theme-panel.active .theme-options { display: flex; }
        
        /* é›™è‰²ä¸»é¡Œé è¦½æŒ‰éµ */
        .theme-options button { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border-dark); cursor: pointer; position: relative; overflow: hidden; padding: 0; }
        .theme-options button::after { content: ''; position: absolute; top: 0; right: 0; width: 50%; height: 100%; background: var(--btn-accent); }
        .theme-options button.night-mode-btn { width: 30px; height: 30px; padding: 0; font-size: 1rem; border-radius: 50%; background: #444; color: #eee; }
        .theme-options button.night-mode-btn::after { display: none; }
        .theme-options button.night-mode-btn.active { background: #5a5a5a; color: #fff; }
        
        /* ç•¶å¡ç‰‡æ”¶åˆæ™‚ï¼Œéš±è—åˆ—è¡¨ã€æ¨™é ­è¡Œã€æ–°å¢æŒ‰éˆ•ä»¥åŠå»ºè­°æ¨™ç±¤ */
        .collapsed .asset-list, .collapsed .asset-header-row, 
        .collapsed .liab-list, .collapsed .liab-header-row, 
        .collapsed .simple-asset-list, .collapsed .simple-asset-header-row, 
        .category-card.collapsed .btn, .liab-card.collapsed .btn, .simple-asset-card.collapsed .btn, 
        .category-card.collapsed .status-tag { display: none !important;}

        /* è®“ footer çš„é–“è·åœ¨æ”¶åˆæ™‚æ›´ç·Šæ¹Šï¼ˆé¸é…ï¼‰ */
        .collapsed .card-footer {margin-top: 5px;padding-top: 10px; border-top: none;}
        .chevron { display: inline-block; transition: 0.3s; font-size: 0.8rem; transform: rotate(0deg);}
        .collapsed .chevron { transform: rotate(-90deg); }
        
        /* åº•éƒ¨æ»‘å‡ºç´°ç¯€é æ¨£å¼ */
        .sheet-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.25); z-index: 1500; display: none; }
        .sheet { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%) scale(0.98); width: 95vw; max-width: 520px; max-height: 85vh; background: #fff; border: 3px solid var(--border-dark); box-shadow: 0 16px 48px rgba(0,0,0,0.18); border-radius: 16px; z-index: 2000; transition: transform 0.2s ease, opacity 0.2s ease; overflow: visible; opacity: 0; pointer-events: none; display: flex; flex-direction: column; }
        .sheet.open { transform: translate(-50%, -50%) scale(1); opacity: 1; pointer-events: auto; }
        .sheet-grabber { flex-shrink: 0; width: 40px; height: 4px; background: #ccc; border-radius: 4px; margin: 10px auto 0; }
        .sheet-scroll-wrap { flex: 1; min-height: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 12px; }
        .sheet-footer { flex-shrink: 0; }
        .sheet-close { display: none !important; }
        .sheet-footer { padding: 8px 16px; border-top: 1px solid #eee; background: #fafafa; }
        .btn-delete-card-bottom { width: 100%; padding: 5px 12px; font-size: 0.72rem; font-weight: 700; color: #888; background: transparent; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: color 0.2s, border-color 0.2s; }
        .btn-delete-card-bottom:hover { color: #c62828; border-color: #c62828; }
        .icon-dot { width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border-dark); background: var(--theme-accent); display: inline-flex; align-items: center; justify-content: center; box-shadow: none; cursor: pointer; }
        .icon-dot svg { width: 16px; height: 16px; stroke: #fff; fill: none; stroke-width: 2; }
        .color-dot { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--border-dark); background: var(--dot); box-shadow: none; cursor: pointer; }

        /* 1. æ¯ä¸€é çš„å…±åŒè¨­å®šï¼šé è¨­éš±è—ï¼Œå¡«æ»¿ç©ºé–“ */
        .page-view {
            display: none;
            animation: fadeIn 0.3s ease-in-out; /* æ›é æ™‚æœ‰å€‹æ·¡å…¥æ•ˆæœ */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* 2. é¦–é æ¨™é¡Œæ¨£å¼ (ç›´æ¥å¥—ç”¨ä½ åŸæœ¬æœ€æ¼‚äº®çš„è¨­è¨ˆ) */
        .dashboard-title {
            border: 4px solid var(--border-dark);
            text-align: center;
            background: var(--theme-accent);
            padding: 15px 12px;
            box-shadow: 6px 6px 0px #000;
            border-radius: var(--radius);
            color: var(--theme-bg);
            font-weight: 900;
            margin-bottom: 40px !important;
        }
        
        /* 3. Dashboard å¡ç‰‡ç¶²æ ¼ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr; /* æ‰‹æ©Ÿä¸Šä¸€åˆ—ä¸€å€‹ */
            gap: 20px;
            margin-top: 20px;
        }
        
        /* 4. å–®å¼µå¡ç‰‡è¨­è¨ˆ */
        .dash-card {
            background: white;
            border: 4px solid var(--border-dark);
            padding: 25px;
            border-radius: var(--radius);
            box-shadow: 6px 6px 0px var(--border-dark);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.1s;
        }
        
        /* é»æ“Šæ™‚çš„ä¸‹å£“æ„Ÿ */
        .dash-card:active {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px var(--border-dark);
        }
        
        .dash-label {
            font-size: 0.9rem;
            font-weight: 900;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .dash-value {
            font-size: 2.2rem;
            font-weight: 900;
            margin-top: 10px;
            color: var(--theme-bg); /* è®“æ•¸å­—é¡è‰²è·Ÿä¸»é¡Œèµ° */
        }
        
        /* æ·¨è³‡ç”¢å¡ç‰‡ç‰¹åˆ¥å¼·èª¿ */
        .dash-card.net-worth {
            background: #f8f9fa;
            border-style: double; /* é›™ç·šé‚Šæ¡†æ›´æœ‰è³ªæ„Ÿ */
        }
        /* åº•éƒ¨å°è¦½åˆ— */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            padding: 10px 12px;
            border-top: 2px solid var(--border-dark);
            z-index: 1000;
            border-radius: 16px 16px 0 0;
            background: rgba(255,255,255,0.8);
            backdrop-filter: saturate(150%) blur(10px);
            gap: 10px;
        }
        .bottom-nav .item {
            flex: 1 1 0;
            font-weight: 800;
            font-size: 0.85rem;
            cursor: pointer;
            color: #1A1A1A;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 8px 10px;
            border-radius: 12px;
            transition: transform 0.08s, box-shadow 0.08s, background 0.08s;
            white-space: nowrap;
            gap: 6px;
            justify-content: center;
        }
        .bottom-nav .item:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        .bottom-nav .item.active {
            background: rgba(var(--theme-accent-rgb), 0.5);
            color: var(--theme-bg);
        }
        .nav-dropdown {
            position: fixed;
            bottom: 64px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 3px solid var(--border-dark);
            border-radius: 12px;
            display: none;
            z-index: 1000;
            padding: 8px;
            min-width: 220px;
        }
        .nav-dropdown .item {
            padding: 10px 12px;
            font-weight: 800;
            border-radius: 8px;
            cursor: pointer;
        }
        .nav-dropdown .item:hover {
            background: rgba(var(--theme-accent-rgb), 0.15);
            color: var(--theme-bg);
        }
        .theme-panel { padding: 0 12px; }
        /* å¡ç‰‡å…§çš„ã€Œæ–°å¢ã€æŒ‰éˆ•å¼±åŒ–ï¼ˆç¶­æŒç½®ä¸­èˆ‡å…¨å¯¬ï¼‰ */
        .category-card .btn, .liab-card .btn, .simple-asset-card .btn {
            width: 100%;
            display: block;
            background: #f3f3f3;
            color: #666;
            border-color: #bbb;
            box-shadow: none;
            padding: 8px 10px;
            font-size: 0.85rem;
        }
        
        /* è®“ container åº•éƒ¨ç•™ç™½ï¼Œä¸ç„¶å…§å®¹æœƒè¢«å°è¦½åˆ—é®ä½ */
        .container {
            padding-bottom: 100px !important;
        }

        /* è‡ªè¨‚ Toast é€šçŸ¥ï¼ˆå–ä»£ alertï¼Œæ¨¡æ“¬è¦–çª—ä¹Ÿèƒ½é¡¯ç¤ºï¼‰ */
        #toastContainer { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
        .toast { padding: 14px 24px; border-radius: 10px; font-weight: bold; font-size: 0.95rem; box-shadow: 0 4px 20px rgba(0,0,0,0.2); animation: toastIn 0.3s ease; max-width: 90vw; transition: opacity 0.3s, transform 0.3s; }
        .toast.success { background: #00C853; color: white; border: 2px solid #009624; }
        .toast.error { background: #FF5252; color: white; border: 2px solid #D32F2F; }
        .toast.info { background: var(--theme-accent); color: var(--theme-bg); border: 2px solid var(--border-dark); }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* è‡ªè¨‚ç¢ºèª Modalï¼ˆå–ä»£ confirmï¼Œæ¨¡æ“¬è¦–çª—ä¹Ÿèƒ½é¡¯ç¤ºï¼‰ */
        #modalOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: none; align-items: center; justify-content: center; padding: 20px; }
        #modalOverlay.show { display: flex; animation: fadeIn 0.2s ease; }
        #confirmModal { background: white; border: 4px solid var(--border-dark); border-radius: var(--radius); padding: 24px; max-width: 320px; width: 100%; box-shadow: 8px 8px 0 var(--border-dark); }
        #confirmModal .modal-title { font-size: 1.1rem; font-weight: 900; margin-bottom: 16px; color: #1A1A1A; }
        #confirmModal .modal-btns { display: flex; gap: 12px; margin-top: 20px; }
        #confirmModal .modal-btn { flex: 1; padding: 12px; font-weight: 900; border-radius: 8px; cursor: pointer; border: 2px solid var(--border-dark); font-size: 0.95rem; }
        #confirmModal .modal-btn.cancel { background: #f0f0f0; color: #333; }
        #confirmModal .modal-btn.confirm { background: var(--theme-accent); color: var(--theme-bg); }
        #confirmModal .modal-btn.danger { background: #FF4444; color: white; border-color: #B30000; }

        /* ç¸½è¦½é å„ªåŒ–è¨­è¨ˆ */
        .dashboard-hero { background: #fff; color: var(--theme-accent); padding: 22px 18px; border-radius: var(--radius); margin-bottom: 18px; border: 3px solid var(--border-dark); box-shadow: 0 6px 18px rgba(0,0,0,0.08); text-align: center; }
        .dashboard-hero .hero-label { font-size: 0.9rem; font-weight: 900; letter-spacing: 1px; opacity: 1; margin-bottom: 6px; color: #1A1A1A; }
        .dashboard-hero .hero-value { font-size: 2.6rem; font-weight: 900; letter-spacing: -1px; color: var(--theme-bg); display: inline-block; }
        .dashboard-hero .hero-value.positive { border-bottom: 3px solid #4CAF50; }
        .dashboard-hero .hero-value.negative { border-bottom: 3px solid #FF8A80; }
        .net-worth-history-expand { margin: -8px 0 18px 0; padding: 14px; background: #fff; border: 3px solid var(--border-dark); border-radius: var(--radius); box-shadow: 0 4px 14px rgba(0,0,0,0.08); }
        .net-worth-history-inner { display: flex; flex-direction: column; }
        .net-worth-history-title { font-size: 0.85rem; margin-bottom: 8px; display: block; }
        .net-worth-history-canvas-wrap { height: 200px; position: relative; }
        .net-worth-history-canvas-wrap canvas { width: 100% !important; height: 100% !important; }
        .dashboard-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .dashboard-cards .dash-card { padding: 22px 16px; margin: 0; border-width: 3px; box-shadow: 0 4px 14px rgba(0,0,0,0.08); }
        .dashboard-cards .dash-card .dash-value { font-size: 1.4rem; margin-top: 6px; color: #666; }
        .dashboard-cards .dash-card .dash-label { font-size: 0.7rem; color: #999; }
        #dash-total-liabilities { color: #b45a5a !important; }
        .dashboard-cards .dash-card.wide { grid-column: 1 / -1; }
        .dual-title { line-height: 1.05; }
        .dual-title .title-en { font-size: 0.95em; letter-spacing: 2px; }
        .dual-title .title-zh { font-size: 0.65em; }
        #overviewChartContainer { margin-top: 8px; width: 100%; height: 150px; }
        #overviewChart { width: 100% !important; height: 150px !important; }
    </style>
</head>
<body>


    <div class="theme-panel" id="themePanel">
        <div class="theme-toggle-icon" onclick="toggleThemePanel()">ğŸ¨ ä¸»é¡Œé…è‰²</div>
        <div class="hide-toggle-icon" id="hideToggleBtn" onclick="toggleHideAmounts()">ğŸ™ˆ éš±è—é‡‘é¡</div>
        <div class="theme-options">
            <button style="background: #3D2B1F; --btn-accent: #FF8C42" onclick="setTheme('orange')"></button>
            <button style="background: #293d0b; --btn-accent: #dac4fc" onclick="setTheme('forest')"></button>
            <button style="background: #6e0000; --btn-accent: #80C5DE" onclick="setTheme('wine')"></button>
            <button style="background: #6245b7; --btn-accent: #B4D355" onclick="setTheme('purple')"></button>
            <button style="background: #1b2941; --btn-accent: #e4d9c4" onclick="setTheme('navy')"></button>
            <button style="background: #0045c6; --btn-accent: #F0A650" onclick="setTheme('amber')"></button>
            <button type="button" class="night-mode-btn" id="nightModeBtn" onclick="toggleNightMode()" title="å¤œé–“æ¨¡å¼">ğŸŒ™</button>
        </div>
    </div>
    
<div class="container">
    <div id="home-view" class="page-view">
            <h1 class="dual-title">
                <span class="title-en">Dashboard</span><br>
                <span class="title-zh">è²¡å‹™ç¸½è¦½</span>
            </h1>
            <div class="dashboard-hero" onclick="toggleNetWorthChart()" style="cursor:pointer;" title="é»æ“Šçœ‹æ­·å²è®ŠåŒ–">
                <div class="hero-label">æ·¨è³‡ç”¢ Net Worth</div>
                <div id="dash-net-worth" class="hero-value">$0</div>
            </div>
            <div id="netWorthHistoryExpand" class="net-worth-history-expand" style="display:none;">
                <div class="net-worth-history-inner">
                    <strong class="net-worth-history-title">æ·¨è³‡ç”¢ æ­·å²è®ŠåŒ–</strong>
                    <div class="net-worth-history-canvas-wrap"><canvas id="netWorthHistoryCanvas"></canvas></div>
                    <p id="netWorthHistoryHint" class="chart-history-hint">æ¯æ—¥ä¸€ç­†ï¼Œå„²å­˜æœ€è¿‘ 60 å¤©</p>
                </div>
            </div>
            <div class="dashboard-cards">
                <div class="dash-card" onclick="showPage('assets-view')">
                    <span class="dash-label">ğŸ’° ç¸½è³‡ç”¢</span>
                    <span id="dash-total-assets" class="dash-value">$0</span>
                </div>
                <div class="dash-card" onclick="showPage('liabilities-view')">
                    <span class="dash-label">ğŸ“‰ ç¸½è² å‚µ</span>
                    <span id="dash-total-liabilities" class="dash-value" style="color: #FF4444;">$0</span>
                </div>
                <div class="dash-card wide" style="background: rgba(var(--theme-accent-rgb), 0.12); border-color: var(--theme-accent); cursor: default;">
                    <span class="dash-label">è³‡ç”¢ vs è² å‚µ</span>
                    <div id="overviewChartContainer">
                        <canvas id="overviewChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    
    <div id="assets-view" class="page-view" style="display:none;">
        <h1 class="dual-title">
            <span class="title-en">Portfolio Engine</span><br>
            <span class="title-zh">è³‡ç”¢çµ„åˆè¨ˆç®—å™¨</span>
        </h1>
    
        <div class="save-status">
            <div class="status-dot" id="saveDot"></div>
            <span id="saveText">æ•¸æ“šè¼‰å…¥ä¸­...</span>
        </div>
    
        <div class="rebalance-panel">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
                <div style="font-size: 0.75rem; font-weight: 900; color: #888; flex-grow: 1;">Total Assetsï½œè³‡ç”¢ç¸½ç¾å€¼ (TWD)</div>
                <div style="display:flex; gap:8px;">
                    <button class="chart-btn" onclick="syncPrices()" id="syncBtn">ğŸ”„ æœ€æ–°è‚¡åƒ¹</button>
                    <button class="chart-btn" onclick="toggleChart()">åœ–è¡¨</button>
                </div>
            </div>
            <div class="summary-with-trend"><span id="rebalanceSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px;">$0</span><span id="rebalanceSummaryTrend" class="summary-trend"></span></div>
            <div id="target-sum-alert" style="display:none; font-size:12px; margin-top:10px; padding:5px; border-radius:5px; background:#FFE5E5; color:#B30000; border:2px solid #FF4444; text-align:center; font-weight:bold;"></div>
            <div class="chart-wrapper">
            <div id="chartContainer">
                <div class="chart-slides" id="chartSlides">
                    <div class="chart-slide chart-slide-pie">
                        <div class="chart-inner-wrap">
                            <canvas id="portfolioChart"></canvas>
                            <button type="button" class="chart-to-history" onclick="openHistoryChart('assets')" title="çœ‹æ­·å²è®ŠåŒ–">â†’</button>
                        </div>
                    </div>
                    <div class="chart-slide chart-slide-history">
                        <button type="button" class="chart-to-pie" onclick="closeHistoryChart()" title="å›åœ“é¤…åœ–">â†</button>
                        <div class="chart-history-inner">
                            <div class="chart-history-header">
                                <strong id="historyChartTitle">æµå‹•è³‡ç”¢ç¸½é¡ æ­·å²è®ŠåŒ–</strong>
                            </div>
                            <div class="chart-history-canvas-wrap">
                                <canvas id="historyChartCanvas"></canvas>
                            </div>
                            <p id="historyChartHint" class="chart-history-hint">æ¯æ—¥ä¸€ç­†ï¼Œå„²å­˜æœ€è¿‘ 60 å¤©</p>
                        </div>
                    </div>
                </div>
                <div class="chart-dots" id="chartDots" aria-hidden="true">
                    <span class="chart-dot active" data-slide="0"></span>
                    <span class="chart-dot" data-slide="1"></span>
                </div>
            </div>
        </div>
        </div>
    
        <div id="mainGrid"></div>
        <button class="btn btn-subtle" onclick="addCategory()">+ æ–°å¢æŠ•è³‡å€åŸŸ</button>
        <button class="btn" style="background:#ddd; border-color:#bbb; color:#888; box-shadow:3px 3px 0px #999; font-size:0.8rem;" onclick="clearAll()">é‡ç½®è³‡æ–™</button>
    </div>    
    
    <div id="fixed-assets-view" class="page-view" style="display:none;">
        <h1>
            <span style="font-size: 0.8em; letter-spacing: 2px;">Fixed Assets</span><br>
            <span style="font-size: 0.6em;">å›ºå®šè³‡ç”¢</span>
        </h1>

        <div class="save-status">
            <div class="status-dot" id="saveDotFixed"></div>
            <span id="saveTextFixed">è‡ªå‹•å„²å­˜è‡³æœ¬åœ°</span>
        </div>

        <div class="rebalance-panel">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
                <div style="font-size: 0.75rem; font-weight: 900; color: #888; flex-grow: 1;">Total Fixed Assetsï½œå›ºå®šè³‡ç”¢ç¸½é¡ (TWD)</div>
            </div>
            <div class="summary-with-trend"><span id="fixedRebalanceSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px;">$0</span><span id="fixedRebalanceSummaryTrend" class="summary-trend"></span></div>
        </div>

        <div id="fixedGrid"></div>
        <button class="btn btn-subtle" onclick="addFixedCategory()">+ æ–°å¢å›ºå®šè³‡ç”¢é¡åˆ¥</button>
        <button class="btn" style="background:#ddd; border-color:#bbb; color:#888; box-shadow:3px 3px 0px #999; font-size:0.8rem;" onclick="clearAllFixed()">é‡ç½®å›ºå®šè³‡ç”¢è³‡æ–™</button>
    </div>

    <div id="receivables-view" class="page-view" style="display:none;">
        <h1>
            <span style="font-size: 0.8em; letter-spacing: 2px;">Accounts Receivable</span><br>
            <span style="font-size: 0.6em;">æ‡‰æ”¶å¸³æ¬¾</span>
        </h1>

        <div class="save-status">
            <div class="status-dot" id="saveDotRecv"></div>
            <span id="saveTextRecv">è‡ªå‹•å„²å­˜è‡³æœ¬åœ°</span>
        </div>

        <div class="rebalance-panel">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
                <div style="font-size: 0.75rem; font-weight: 900; color: #888; flex-grow: 1;">Total Receivablesï½œæ‡‰æ”¶å¸³æ¬¾ç¸½é¡ (TWD)</div>
            </div>
            <div class="summary-with-trend"><span id="recvRebalanceSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px;">$0</span><span id="recvRebalanceSummaryTrend" class="summary-trend"></span></div>
        </div>

        <div id="recvGrid"></div>
        <button class="btn btn-subtle" onclick="addRecvCategory()">+ æ–°å¢æ‡‰æ”¶å¸³æ¬¾é¡åˆ¥</button>
        <button class="btn" style="background:#ddd; border-color:#bbb; color:#888; box-shadow:3px 3px 0px #999; font-size:0.8rem;" onclick="clearAllRecv()">é‡ç½®æ‡‰æ”¶å¸³æ¬¾è³‡æ–™</button>
    </div>
    
    <div id="liabilities-view" class="page-view" style="display:none;">
        <h1>
            <span style="font-size: 0.8em; letter-spacing: 2px;">Liability Manager</span><br>
            <span style="font-size: 0.6em;">è² å‚µç®¡ç†</span>
        </h1>

        <div class="save-status">
            <div class="status-dot" id="saveDotLiab"></div>
            <span id="saveTextLiab">è‡ªå‹•å„²å­˜è‡³æœ¬åœ°</span>
        </div>

        <div class="rebalance-panel">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 10px;">
                <div style="font-size: 0.75rem; font-weight: 900; color: #888; flex-grow: 1;">Total Liabilitiesï½œè² å‚µç¸½é¡ (TWD)</div>
                <div style="display:flex; gap:8px;">
                    <button class="chart-btn" onclick="toggleLiabChart()">åœ–è¡¨</button>
                </div>
            </div>
            <div class="summary-with-trend"><span id="liabRebalanceSummary" style="font-size: 2.2rem; font-weight: 900; letter-spacing: -1px;">$0</span><span id="liabRebalanceSummaryTrend" class="summary-trend"></span></div>
            <div id="liabChartContainer">
                <canvas id="liabChart"></canvas>
            </div>
        </div>

        <div id="liabGrid"></div>
        <button class="btn btn-subtle" onclick="addLiabCategory()">+ æ–°å¢è² å‚µé¡åˆ¥</button>
        <button class="btn" style="background:#ddd; border-color:#bbb; color:#888; box-shadow:3px 3px 0px #999; font-size:0.8rem;" onclick="clearAllLiabilities()">é‡ç½®è² å‚µè³‡æ–™</button>
    </div>
</div>
<div id="toastContainer"></div>
<!-- åº•éƒ¨æ»‘å‡ºç´°ç¯€é  -->
<div id="sheetBackdrop" class="sheet-backdrop" onclick="closeSheet()"></div>
    <div id="detailSheet" class="sheet">
    <div class="sheet-grabber"></div>
    <div class="sheet-scroll-wrap">
        <div id="sheetContent"></div>
    </div>
    <div id="sheetFooter" class="sheet-footer" style="display:none;">
        <button type="button" class="btn-delete-card-bottom" id="sheetDeleteCardBtn">åˆªé™¤æ­¤å¡ç‰‡</button>
    </div>
    <div id="pickerBackdrop" class="picker-backdrop" style="display:none;" onclick="closePickerPanel()"></div>
    <div id="pickerPanelWrap" class="picker-panel-wrap" style="display:none;">
        <div class="picker-tabs">
            <button type="button" class="picker-tab active" data-tab="icons" onclick="switchPickerTab('icons')">åœ–ç¤º</button>
            <button type="button" class="picker-tab" data-tab="colors" onclick="switchPickerTab('colors')">é¡è‰²</button>
        </div>
        <div id="pickerPanel" class="picker-panel picker-floating">
        <div class="picker-panel-inner">
            <div class="picker-tab-content active" id="pickerTabIcons">
                <div id="iconSectionLabel">é‡‘éŒ¢ï¼è¨˜å¸³åœ–ç¤º</div>
                <div id="iconGrid" class="icon-grid"></div>
                <div id="iconSectionLabel2">å…¶ä»–åœ–ç¤º</div>
                <div id="iconGridOther" class="icon-grid"></div>
            </div>
            <div class="picker-tab-content" id="pickerTabColors">
                <div id="colorSectionLabel">åŒè‰²ç³»èƒŒæ™¯ï¼ˆé¸ä¸€å€‹ï¼‰</div>
                <div id="colorGrid" class="color-grid"></div>
            </div>
        </div>
        </div>
    </div>
    <div style="height:20px"></div>
</div>
<div id="modalOverlay">
    <div id="confirmModal">
        <div class="modal-title" id="modalTitle">ç¢ºèª</div>
        <div class="modal-btns">
            <button class="modal-btn cancel" id="modalCancel">å–æ¶ˆ</button>
            <button class="modal-btn confirm" id="modalConfirm">ç¢ºå®š</button>
        </div>
    </div>
</div>
<nav class="bottom-nav">
        <div id="nav-home" class="item" onclick="showPage('home-view')">ğŸ  ç¸½è¦½</div>
        <div id="nav-assets" class="item" onclick="handleNavAssetsClick()">ğŸ’° è³‡ç”¢ â–¾</div>
        <div id="nav-liab" class="item" onclick="showPage('liabilities-view')">ğŸ“‰ è² å‚µ</div>
    </nav>
<div id="assetsMenu" class="nav-dropdown">
    <div class="item" onclick="showPage('assets-view'); hideAssetsMenu()">æµå‹•è³‡ç”¢</div>
    <div class="item" onclick="showPage('fixed-assets-view'); hideAssetsMenu()">å›ºå®šè³‡ç”¢</div>
    <div class="item" onclick="showPage('receivables-view'); hideAssetsMenu()">æ‡‰æ”¶å¸³æ¬¾</div>
</div>
<datalist id="stockList"></datalist>

<script>
    function showToast(msg, type) {
        const c = document.getElementById('toastContainer');
        const t = document.createElement('div');
        t.className = 'toast ' + (type || 'info');
        t.textContent = msg;
        c.appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(-8px)'; setTimeout(() => t.remove(), 300); }, 2500);
    }
    function showConfirm(msg, opts) {
        return new Promise(resolve => {
            const overlay = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const cancelBtn = document.getElementById('modalCancel');
            const confirmBtn = document.getElementById('modalConfirm');
            title.textContent = msg || 'ç¢ºèª';
            confirmBtn.textContent = opts?.confirmText || 'ç¢ºå®š';
            confirmBtn.className = 'modal-btn ' + (opts?.danger ? 'danger' : 'confirm');
            overlay.classList.add('show');
            const close = (ok) => { overlay.classList.remove('show'); resolve(ok); };
            cancelBtn.onclick = () => close(false);
            confirmBtn.onclick = () => close(true);
            overlay.onclick = (e) => { if (e.target === overlay) close(false); };
        });
    }
    function showPage(pageId) {
    // 1. éš±è—æ‰€æœ‰é é¢
    document.querySelectorAll('.page-view').forEach(p => {
        p.style.display = 'none';
    });
    // 2. é¡¯ç¤ºé»æ“Šçš„é‚£ä¸€é 
    document.getElementById(pageId).style.display = 'block';
    
    // 3. æ›é å¾Œè‡ªå‹•æ²å›é ‚éƒ¨ï¼Œé«”é©—æ¯”è¼ƒå¥½
    window.scrollTo(0, 0);
    // 4. æ›´æ–°åº•éƒ¨å°è¦½çš„é¸ä¸­æ¨£å¼
    const navMap = {
        'home-view':'nav-home',
        'assets-view':'nav-assets',
        'fixed-assets-view':'nav-assets',
        'receivables-view':'nav-assets',
        'liabilities-view':'nav-liab'
    };
    document.querySelectorAll('.bottom-nav .item').forEach(i => i.classList.remove('active'));
    const navId = navMap[pageId];
    if (navId) {
        const el = document.getElementById(navId);
        if (el) el.classList.add('active');
    }
    }
    
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxy9lgNdsTEW4fCpEmyYeAlAsYhQzHNlXfWFztXdx_W5Qn6vNBgNcRU-THXesDopY_k/exec"; 
    let myChart = null, myLiabChart = null, myOverviewChart = null;
    let hideAmounts = false;
    let categories = [], stockData = [], usdRate = 32.5;
    let liabCategories = [], fixedCategories = [], recvCategories = [];
    let assetTotal = 0, liabilityTotal = 0, fixedTotal = 0, receivableTotal = 0;
    let prevAssetTotal = null, prevFixedTotal = null, prevRecvTotal = null, prevLiabTotal = null;
    function setSummaryTrend(summaryId, trendId, total, prev) {
        var trendEl = document.getElementById(trendId);
        if (!trendEl) return;
        if (prev === null) { trendEl.textContent = ''; trendEl.className = 'summary-trend'; return; }
        if (total > prev) { trendEl.textContent = 'â–²'; trendEl.className = 'summary-trend up'; }
        else if (total < prev) { trendEl.textContent = 'â–¼'; trendEl.className = 'summary-trend down'; }
        else { trendEl.textContent = ''; trendEl.className = 'summary-trend'; }
    }
    const moneyIconList = [
        'wallet','credit-card','banknote','coins','landmark','receipt','circle-dollar-sign','dollar-sign','piggy-bank',
        'trending-up','trending-down','percent','calculator','pie-chart','bar-chart','activity','briefcase','hand-coins','receipt-text'
    ];
    const iconList = [
        'wallet','credit-card','banknote','coins','landmark','briefcase','trending-up','trending-down','pie-chart','bar-chart','activity',
        'shopping-bag','shopping-cart','home','car','plane','gift','coffee','utensils','heart','star','user','users','settings','lock','unlock',
        'key','shield','bell','calendar','clock','mail','phone','camera','image','music','video','globe','map-pin','navigation','cloud','sun',
        'moon','zap','anchor','award','bookmark','box','cpu','database','gem','hard-hat','layers'
    ];
    /* æ¯æ’ç¬¬ä¸€å€‹æ”¾å¯æ„›è‰²ï¼Œå…¶é¤˜ç‚ºè©²è‰²ç³»ï¼›æ¯æ’ 5 æ ¼ï¼›æœ€ä¸‹ä¸€æ’ç°éš */
    const colorFamilies = [
        { label: 'ç´…', colors: ['#FFB5BA','#FF9AA2','#F58A92','#EB7A82','#DD6B72'] },
        { label: 'æ©™', colors: ['#FFCCA0','#FFB88C','#F5A87A','#E8986A','#D9885A'] },
        { label: 'é»ƒ', colors: ['#FFE580','#FFE066','#F5D055','#E8C04A','#D4B040'] },
        { label: 'ç¶ ', colors: ['#90E0A0','#7ED89A','#6BC98A','#5ABA7A','#4AAA6A'] },
        { label: 'è—', colors: ['#7DD3FC','#6EC2F5','#5AB0E8','#4A9ED9','#408CC4'] },
        { label: 'é›', colors: ['#A5B5FD','#9090E8','#7A7AD8','#6565C8','#5555B5'] },
        { label: 'ç´«', colors: ['#C4B5FD','#B89DD4','#A58AC4','#9078B5','#7E68A5'] },
        { label: 'ç°', colors: ['#E5E5E5','#BDBDBD','#8E8E8E','#616161','#424242'] }
    ];

    function formatNum(num) { return (num === '' || isNaN(num) || num == 0) ? "-" : parseFloat(num).toLocaleString('en-US'); }
    function formatCurrency(num) { return hideAmounts ? "***" : ("$" + Math.round(num || 0).toLocaleString('en-US')); }
    function applySumDisplaySize(el) {
        if (!el) return;
        var len = (el.textContent || '').length;
        el.classList.remove('sum-len-m', 'sum-len-l', 'sum-len-xl');
        if (len > 11) el.classList.add('sum-len-xl');
        else if (len > 8) el.classList.add('sum-len-l');
        else if (len > 6) el.classList.add('sum-len-m');
    }

    function sanitizeIconName(name) {
        var fallback = 'wallet';
        var map = { 'ğŸ’³':'credit-card','ğŸ’°':'coins','ğŸ’µ':'banknote','ğŸ’¸':'banknote','ğŸª™':'coins','ğŸ¦':'landmark' };
        var n = (map[name] || name || fallback).replace(/\s/g,'');
        return n || fallback;
    }
    function getIconHTML(name, color) {
        const n = sanitizeIconName(name);
        const c = color || getComputedStyle(document.documentElement).getPropertyValue('--theme-accent').trim();
        return `<span class="card-icon" style="background:${c}"><i data-lucide="${n}"></i></span>`;
    }
    function refreshIcons(scopeEl) {
        var lucide = window.lucide || window.Lucide;
        if (!lucide || typeof lucide.createIcons !== 'function') return;
        try {
            if (scopeEl) lucide.createIcons({ root: scopeEl });
            else lucide.createIcons();
        } catch (e) {
            try { lucide.createIcons(scopeEl || document.body); } catch (e2) {}
        }
    }
    const DEFAULT_CONFIG = [
        { id: 'cat_1', name: 'æˆé•·å‹æŠ•è³‡', target: 40 },
        { id: 'cat_2', name: 'é€²æ”»å‹æŠ•è³‡', target: 10 },
        { id: 'cat_3', name: 'é˜²å®ˆå‹æŠ•è³‡', target: 20 },
        { id: 'cat_4', name: 'é«˜è‚¡æ¯æŠ•è³‡', target: 20 },
        { id: 'cat_5', name: 'å®‰å…¨å­˜æ¬¾', target: 10 }
    ];

    const LIAB_DEFAULT_CONFIG = [
        { id: 'debt_1', name: 'æˆ¿è²¸' },
        { id: 'debt_2', name: 'è»Šè²¸' },
        { id: 'debt_3', name: 'ä¿¡ç”¨å¡' }
    ];
    const FIXED_DEFAULT_CONFIG = [
        { id: 'fixed_1', name: 'æˆ¿ç”¢' },
        { id: 'fixed_2', name: 'è¨­å‚™' }
    ];
    const RECV_DEFAULT_CONFIG = [
        { id: 'recv_1', name: 'å®¢æˆ¶A' },
        { id: 'recv_2', name: 'å®¢æˆ¶B' }
    ];

    async function loadStockData() {
        try {
            const resp = await fetch('csvjson.json');
            stockData = await resp.json();
            const dl = document.getElementById('stockList');
            stockData.forEach(i => { const opt = document.createElement('option'); opt.value = `${i.s} ${i.n}`; dl.appendChild(opt); });
            document.getElementById('saveText').innerText = "è‡ªå‹•å„²å­˜è‡³æœ¬åœ°";
        } catch (e) { document.getElementById('saveText').innerText = "æ•¸æ“šè¼‰å…¥å¤±æ•—"; }
    }

    function forceSave() {
        try {
            const data = {}, newCats = [];
            document.querySelectorAll('.category-card').forEach(card => {
                const assets = [];
                card.querySelectorAll('.asset-item').forEach(item => {
                    assets.push({
                        name: item.querySelector('.asset-name').value || '',
                        qty: item.querySelector('.asset-qty').value || '',
                        price: item.querySelector('.asset-price').value || '',
                        value: parseFloat(item.querySelector('.asset-value').value) || 0,
                        targetP: parseFloat(item.querySelector('.target-p-input').value) || 0
                    });
                });
                newCats.push({ id: card.id, name: card.querySelector('.cat-name-text').innerText, color: card.getAttribute('data-color') || '', icon: card.getAttribute('data-icon') || '' });
                data[card.id] = { target: parseFloat(card.querySelector('.target-input').value) || 0, collapsed: card.classList.contains('collapsed'), assets: assets };
            });
            categories = newCats;
            localStorage.setItem('myPortfolio_v5', JSON.stringify(data));
            localStorage.setItem('catConfig_v5', JSON.stringify(categories));
            const dot = document.getElementById('saveDot'); dot.classList.add('active'); setTimeout(() => dot.classList.remove('active'), 800);
        } catch(e) {}
    }

    function setTheme(themeName) {
    // 1. åˆ‡æ›ç¶²é æ•´é«”ä¸»é¡Œ
    document.documentElement.setAttribute('data-theme', themeName);
    localStorage.setItem('userTheme', themeName);
    
    // 2. æ›´æ–° Icon è·¯å¾‘
    // é€™é‚Šæœƒæ ¹æ“šå‚³å…¥çš„ themeName (å¦‚ 'forest') è‡ªå‹•è®Šæˆ 'icon-forest.png'
    const newPath = `icon-${themeName}.png?v=4`; 
    document.getElementById('apple-icon').href = newPath;
    document.getElementById('favicon').href = newPath;

    // 3. é—œé–‰ä¸»é¡Œé¢æ¿èˆ‡é‡æ–°è¨ˆç®—
    if (document.getElementById('themePanel')) {
        document.getElementById('themePanel').classList.remove('active');
    }
    calculateAll();
}
    
    function toggleThemePanel() { document.getElementById('themePanel').classList.toggle('active'); }

    function toggleNightMode() {
        var on = document.body.classList.toggle('night-mode');
        localStorage.setItem('userNightMode', on ? '1' : '0');
        var btn = document.getElementById('nightModeBtn');
        if (btn) { btn.classList.toggle('active', on); btn.textContent = on ? 'â˜€ï¸' : 'ğŸŒ™'; }
        document.getElementById('themePanel').classList.remove('active');
    }
    function initNightMode() {
        var on = localStorage.getItem('userNightMode') === '1';
        if (on) document.body.classList.add('night-mode');
        var btn = document.getElementById('nightModeBtn');
        if (btn) { btn.classList.toggle('active', on); btn.textContent = on ? 'â˜€ï¸' : 'ğŸŒ™'; }
    }

    function editMode(el) {
        const con = el.nextElementSibling; el.style.display = 'none'; con.style.display = 'block';
        const i = con.querySelector('input'); if (i) { i.focus(); i.select(); }
    }

    function autoViewMode(iEl) {
        const item = iEl.closest('.asset-item'), view = iEl.parentElement.previousElementSibling;
        if (iEl.classList.contains('asset-name')) {
            let val = iEl.value.trim(); if (val.includes(' ')) val = val.split(' ')[0];
            iEl.value = val;
            const s = stockData.find(st => st.s == val);
            if (s && s.p) { const pI = item.querySelector('.asset-price'); if (!pI.value || pI.value == 0) pI.value = s.p; }
        }
        const name = item.querySelector('.asset-name').value.trim(), q = parseFloat(item.querySelector('.asset-qty').value), p = parseFloat(item.querySelector('.asset-price').value);
        if (q > 0 && p > 0) {
            const vI = item.querySelector('.asset-value');
            const vV = vI.parentElement.previousElementSibling; // æ‰¾åˆ°ç¾å€¼çš„é¡¯ç¤ºå±¤
            vI.value = /^[A-Za-z]+$/.test(name) ? Math.round(q * p * usdRate) : Math.round(q * p);
            if (vV) { 
                vV.innerText = formatCurrency(vI.value); 
                vV.classList.remove('empty-placeholder');
            }
        }

        let dV = iEl.value;
        if (iEl.type === 'number') {
            if (dV === "" || dV == 0) {
                view.innerText = (iEl.classList.contains('asset-qty') || iEl.classList.contains('asset-price')) ? "-" : (iEl.classList.contains('target-p-input') ? "0%" : "$0");
                view.classList.toggle('empty-placeholder', view.innerText === "-");
            } else {
                if (iEl.classList.contains('asset-qty') || iEl.classList.contains('asset-price')) view.innerText = formatNum(dV);
                else if (iEl.classList.contains('asset-value')) view.innerText = formatCurrency(dV);
                else if (iEl.classList.contains('target-p-input')) view.innerText = dV + "%";
                view.classList.remove('empty-placeholder');
            }
        } else { view.innerText = dV || "é»æ“Šè¼¸å…¥"; }
        setTimeout(() => { iEl.parentElement.style.display = 'none'; view.style.display = 'flex'; calculateAll(); }, 150);
    }

    async function syncPrices() {
    const btn = document.getElementById('syncBtn'), oT = btn.innerText;
    let sL = []; document.querySelectorAll('.asset-item').forEach(i => {
        const s = i.querySelector('.asset-name').value.trim().toUpperCase();
        if (s && s !== 'é»æ“Šè¼¸å…¥') sL.push(s);
    });
    if (sL.length === 0) { showToast("è«‹å…ˆè¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ", "info"); return; }
    try {
        btn.innerText = "â³..."; btn.disabled = true;
        const resp = await fetch(`${GAS_URL}?symbols=${encodeURIComponent(sL.join(','))}`);
        const cloud = await resp.json();
        if (cloud["CURRENCY:USDTWD"]) usdRate = cloud["CURRENCY:USDTWD"];
        document.querySelectorAll('.asset-item').forEach(i => {
            const nI = i.querySelector('.asset-name'), s = nI.value.trim().toUpperCase(), p = cloud[s];
            if (p && p > 0) { 
                const pI = i.querySelector('.asset-price'), qI = i.querySelector('.asset-qty'), vI = i.querySelector('.asset-value');
                pI.value = p; 
                autoViewMode(pI); 
                
                // è‡ªå‹•æ›´æ–°ç¾å€¼åŠŸèƒ½
                const q = parseFloat(qI.value) || 0;
                let nV = /^[A-Za-z]+$/.test(nI.value.trim()) ? Math.round(q * p * usdRate) : Math.round(q * p);
                vI.value = nV;
                const vV = vI.parentElement.previousElementSibling;
                if (vV) { vV.innerText = formatCurrency(nV); vV.classList.remove('empty-placeholder'); }
            }
        });
        showToast(`è‚¡åƒ¹æ›´æ–°å®Œæˆï¼åŒ¯ç‡ USD/TWDï¼š${usdRate.toFixed(2)}`, "success");
    } catch (e) { showToast("è‚¡åƒ¹æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦", "error"); } finally { btn.innerText = oT; btn.disabled = false; calculateAll(); }
}


    function calculateAll() {
        let total = 0, catSums = {}, totalTargetP = 0;
        document.querySelectorAll('.category-card').forEach(card => {
            totalTargetP += parseFloat(card.querySelector('.target-input').value) || 0;
            let sum = 0; card.querySelectorAll('.asset-value').forEach(i => { sum += parseFloat(i.value) || 0; });
            catSums[card.id] = sum; total += sum;
        });
        const alertDiv = document.getElementById('target-sum-alert');
        if (Math.abs(totalTargetP - 100) > 0.01) { alertDiv.style.display = 'block'; alertDiv.innerText = `âš ï¸ ç›®æ¨™ç¸½å’Œ: ${totalTargetP}%`; } else alertDiv.style.display = 'none';

        document.querySelectorAll('.category-card').forEach(card => {
            const target = parseFloat(card.querySelector('.target-input').value) || 0, curP = total > 0 ? (catSums[card.id] / total * 100) : 0;
            card.querySelector('.target-amount-label').innerText = formatCurrency(total * (target / 100));
            var catSumEl = card.querySelector('.cat-sum-display'); catSumEl.innerText = formatCurrency(catSums[card.id]); applySumDisplaySize(catSumEl);
            const curEl = card.querySelector('.current-p');
            curEl.innerText = curP.toFixed(1) + "%";
            curEl.classList.remove('p-high','p-low');
            if (target > 0 && total > 0) {
                var withinTolerance = Math.abs(curP - target) <= 3;
                if (!withinTolerance) {
                    if (curP < target) curEl.classList.add('p-low');
                    else curEl.classList.add('p-high');
                }
            }
            const td = card.querySelector('.target-display'); if (td) td.innerText = `ç›®æ¨™ ${target}%`;
            const tag = card.querySelector('.status-alert'), diff = catSums[card.id] - (total * (target / 100));
            if (total === 0) tag.innerText = "âœ… ç­‰å¾…è³‡æ–™";
            else if (Math.abs(curP - target) <= 3) tag.innerText = "âœ… æ¯”ä¾‹ç†æƒ³";
            else tag.innerHTML = diff > 0 ? `âš ï¸ å»ºè­°ç§»å‡º <span style="color:#FF4444">${formatCurrency(diff)}</span>` : `âš ï¸ å»ºè­°è£œå…¥ <span style="color:#008800">${formatCurrency(Math.abs(diff))}</span>`;

            card.querySelectorAll('.asset-item').forEach(item => {
                const val = parseFloat(item.querySelector('.asset-value').value) || 0, tP = parseFloat(item.querySelector('.target-p-input').value) || 0;
                item.querySelector('.ratio-val').innerText = (catSums[card.id] > 0 ? (val / catSums[card.id] * 100).toFixed(1) : 0) + '%';
                const sug = item.querySelector('.diff-suggestion');
                if (total > 0 && catSums[card.id] > 0 && tP > 0) {
                    const d = (total * (target/100) * (tP/100)) - val;
                    sug.innerText = (d > 0 ? "+" : "") + Math.round(d).toLocaleString();
                    sug.style.color = d > 0 ? "#008800" : "#FF4444";
                } else sug.innerText = "";
            });
        });
        document.getElementById('rebalanceSummary').innerText = formatCurrency(total);
        setSummaryTrend('rebalanceSummary', 'rebalanceSummaryTrend', total, prevAssetTotal);
        prevAssetTotal = total;

        // å°‡è³‡ç”¢ç¸½é¡å­˜æˆå…¨åŸŸè®Šæ•¸ï¼Œçµ¦ Dashboard ä½¿ç”¨
        assetTotal = total;
        updateDashboard();

        updateChart(catSums, total); 
        forceSave();
    }

    function calculateAllLiabilities() {
        let total = 0;
        document.querySelectorAll('.liab-card').forEach(card => {
            let sum = 0;
            card.querySelectorAll('.liab-amount').forEach(i => { sum += parseFloat(i.value) || 0; });
            const sumDisplay = card.querySelector('.liab-sum-display');
            if (sumDisplay) { sumDisplay.innerText = formatCurrency(sum); applySumDisplaySize(sumDisplay); }
            total += sum;
        });

        liabilityTotal = total;
        const totalEl = document.getElementById('liabRebalanceSummary');
        if (totalEl) totalEl.innerText = formatCurrency(total);
        setSummaryTrend('liabRebalanceSummary', 'liabRebalanceSummaryTrend', total, prevLiabTotal);
        prevLiabTotal = total;

        updateLiabChart();
        updateDashboard();
        forceSaveLiab();
    }

    // ===== å›ºå®šè³‡ç”¢é é¢ï¼šUI èˆ‡è³‡æ–™è™•ç† =====
    function renderFixedAssetsUI() {
        const saved = JSON.parse(localStorage.getItem('myFixed_v1')) || {};
        const grid = document.getElementById('fixedGrid');
        if (!grid) return;
        grid.innerHTML = '';
        fixedCategories.forEach(cat => {
            if (sheetCardEl && sheetCardEl.classList.contains('simple-asset-card') && sheetCardEl.id.startsWith('fixed_') && cat.id === sheetCardEl.id) {
                var ph = document.createElement('div'); ph.id = 'sheet-placeholder-' + cat.id; ph.style.display = 'none'; ph.setAttribute('data-sheet-placeholder', '1');
                grid.appendChild(ph);
                return;
            }
            const data = saved[cat.id] || { items: [], collapsed: true };
            const card = document.createElement('div');
            card.id = cat.id;
            card.className = `simple-asset-card collapsed`;
            const iconHTML = getIconHTML(cat.icon || 'home', cat.color || '');
            card.innerHTML = `
                <button class="btn-delete-card" onclick="deleteFixedCategory('${cat.id}')">Ã—</button>
                <div class="simple-asset-header" onclick="toggleFixedCategory('${cat.id}')">
                    <div>${iconHTML}</div>
                    <div><span class="fixed-name-text">${cat.name}</span></div>
                </div>
                <div class="simple-asset-header-row">
                    <span></span><span>åç¨±</span><span>é‡‘é¡</span>
                </div>
                <div class="simple-asset-list" id="fixed-list-${cat.id}"></div>
                <button class="btn" style="padding:6px; font-size:0.8rem;" onclick="addFixedAsset('${cat.id}')">+ æ–°å¢è³‡ç”¢</button>
                <div class="card-footer">
                    <div class="footer-row">
                        <span class="sum-label">åˆè¨ˆ</span>
                        <span class="fixed-sum-display">$0</span>
                        <span class="current-p" style="visibility:hidden">0%</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
            if (cat.color) card.setAttribute('data-color', cat.color);
            if (cat.icon) card.setAttribute('data-icon', cat.icon);
            if (data.items && data.items.length > 0) data.items.forEach(i => addFixedAsset(cat.id, i.name, i.amount));
            else addFixedAsset(cat.id);
            new Sortable(document.getElementById(`fixed-list-${cat.id}`), {
                animation: 150, delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5,
                group: { name: 'fixed-items', put: ['fixed-items'] },
                onMove: function(evt){ return !evt.dragged.classList.contains('simple-asset-card'); },
                onEnd: () => calculateAllFixedAssets()
            });
        });
        new Sortable(grid, {
            animation: 150, handle: '.simple-asset-header', delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5,
            group: { name: 'fixed-cards', pull: true, put: ['fixed-cards'] }, draggable: '.simple-asset-card',
            onMove: function(evt){ var g = document.getElementById('fixedGrid'); return evt.related && evt.related.parentNode === g && evt.related.classList.contains('simple-asset-card'); },
            onEnd: function(){ var g = document.getElementById('fixedGrid'); document.querySelectorAll('.simple-asset-card').forEach(function(card){ if (card.classList.contains('in-sheet') || !card.id.startsWith('fixed_')) return; if (card.parentElement && card.parentElement !== g){ var idx = fixedCategories.findIndex(function(c){ return c.id === card.id; }); var next = idx >= 0 && idx < g.children.length ? g.children[idx] : null; if (next) g.insertBefore(card, next); else g.appendChild(card); } }); calculateAllFixedAssets(); }
        });
        calculateAllFixedAssets();
        refreshIcons(grid);
    }
    function addFixedAsset(catId, name='', amount=0) {
        const list = document.getElementById(`fixed-list-${catId}`); if (!list) return;
        const div = document.createElement('div'); div.className = 'simple-asset-item';
        const amountDisplay = (amount === '' || amount == 0) ? '-' : formatCurrency(amount);
        div.innerHTML = `
            <button class="btn-delete-left" onclick="this.closest('.simple-asset-item').remove(); calculateAllFixedAssets();">Ã—</button>
            <div>
                <div class="static-view" onclick="editMode(this)">${name || 'é»æ“Šè¼¸å…¥'}</div>
                <div class="edit-container"><input type="text" class="edit-input fixed-name" value="${name}" onblur="autoViewModeFixed(this)"></div>
            </div>
            <div>
                <div class="static-view" onclick="editMode(this)">${amountDisplay}</div>
                <div class="edit-container prefix"><input type="number" inputmode="decimal" step="any" class="edit-input fixed-amount" value="${amount}" onblur="autoViewModeFixed(this)" oninput="calculateAllFixedAssets()"></div>
            </div>
        `;
        list.appendChild(div);
    }
    function autoViewModeFixed(iEl) {
        const view = iEl.parentElement.previousElementSibling;
        let dV = iEl.value;
        if (iEl.type === 'number') {
            if (dV === "" || isNaN(dV) || dV == 0) {
                view.innerText = "-";
                view.classList.add('empty-placeholder');
            } else {
                view.innerText = formatCurrency(dV);
                view.classList.remove('empty-placeholder');
            }
        } else {
            view.innerText = dV || "é»æ“Šè¼¸å…¥";
            view.classList.toggle('empty-placeholder', !dV);
        }
        setTimeout(() => {
            iEl.parentElement.style.display = 'none';
            view.style.display = 'flex';
            calculateAllFixedAssets();
        }, 150);
    }
    function addFixedCategory() {
        fixedCategories.push({ id: 'fixed_'+Date.now(), name: 'æ–°å›ºå®šè³‡ç”¢' });
        renderFixedAssetsUI();
    }
    async function deleteFixedCategory(id) {
        if (await showConfirm('æ˜¯å¦ç¢ºå®šè¦åˆªé™¤æ­¤å›ºå®šè³‡ç”¢é¡åˆ¥ï¼Ÿ', { danger: true })) {
            if (sheetCardEl && sheetCardEl.id === id) closeSheet();
            fixedCategories = fixedCategories.filter(c => c.id !== id);
            renderFixedAssetsUI();
            forceSaveFixed();
        }
    }
    function toggleFixedCategory(id) {
        const target = event.target;
        if (target.tagName === 'INPUT' || target.isContentEditable) return;
        openSheetWithCard(id);
    }
    function forceSaveFixed() {
        try {
            const data = {}, newCats = [];
            document.getElementById('fixedGrid')?.querySelectorAll('.simple-asset-card').forEach(card => {
                const items = [];
                card.querySelectorAll('.simple-asset-item').forEach(item => {
                    items.push({
                        name: item.querySelector('.fixed-name').value || '',
                        amount: parseFloat(item.querySelector('.fixed-amount').value) || 0
                    });
                });
                newCats.push({ id: card.id, name: card.querySelector('.fixed-name-text').innerText, color: card.getAttribute('data-color') || '', icon: card.getAttribute('data-icon') || '' });
                data[card.id] = { collapsed: card.classList.contains('collapsed'), items: items };
            });
            fixedCategories = newCats;
            localStorage.setItem('myFixed_v1', JSON.stringify(data));
            localStorage.setItem('fixedConfig_v1', JSON.stringify(fixedCategories));
            const dot = document.getElementById('saveDotFixed');
            if (dot) { dot.classList.add('active'); setTimeout(() => dot.classList.remove('active'), 800); }
        } catch(e) {}
    }
    async function clearAllFixed() {
        if (await showConfirm('æ˜¯å¦æ¸…é™¤æ‰€æœ‰å›ºå®šè³‡ç”¢è³‡æ–™ä¸¦é‡ç½®ï¼Ÿ', { danger: true })) {
            localStorage.removeItem('myFixed_v1');
            localStorage.removeItem('fixedConfig_v1');
            fixedCategories = FIXED_DEFAULT_CONFIG.map(d => ({ id: d.id, name: d.name }));
            renderFixedAssetsUI();
            calculateAllFixedAssets();
        }
    }
    function calculateAllFixedAssets() {
        let total = 0;
        const grid = document.getElementById('fixedGrid');
        if (!grid) return;
        let cards = Array.from(grid.querySelectorAll('.simple-asset-card'));
        if (sheetCardEl && sheetCardEl.classList.contains('simple-asset-card') && sheetCardEl.id && String(sheetCardEl.id).startsWith('fixed_')) cards.push(sheetCardEl);
        cards.forEach(card => {
            let sum = 0;
            card.querySelectorAll('.fixed-amount').forEach(i => { sum += parseFloat(i.value) || 0; });
            const sumDisplay = card.querySelector('.fixed-sum-display');
            if (sumDisplay) { sumDisplay.innerText = formatCurrency(sum); applySumDisplaySize(sumDisplay); }
            total += sum;
        });
        fixedTotal = total;
        const totalEl = document.getElementById('fixedRebalanceSummary');
        if (totalEl) totalEl.innerText = formatCurrency(total);
        setSummaryTrend('fixedRebalanceSummary', 'fixedRebalanceSummaryTrend', total, prevFixedTotal);
        prevFixedTotal = total;
        updateDashboard();
        forceSaveFixed();
    }

    // ===== æ‡‰æ”¶å¸³æ¬¾é é¢ï¼šUI èˆ‡è³‡æ–™è™•ç† =====
    function renderReceivablesUI() {
        const saved = JSON.parse(localStorage.getItem('myRecv_v1')) || {};
        const grid = document.getElementById('recvGrid');
        if (!grid) return;
        grid.innerHTML = '';
        recvCategories.forEach(cat => {
            if (sheetCardEl && sheetCardEl.classList.contains('simple-asset-card') && !sheetCardEl.id.startsWith('fixed_') && cat.id === sheetCardEl.id) {
                var ph = document.createElement('div'); ph.id = 'sheet-placeholder-' + cat.id; ph.style.display = 'none'; ph.setAttribute('data-sheet-placeholder', '1');
                grid.appendChild(ph);
                return;
            }
            const data = saved[cat.id] || { items: [], collapsed: true };
            const card = document.createElement('div');
            card.id = cat.id;
            card.className = `simple-asset-card collapsed`;
            const iconHTML = getIconHTML(cat.icon || 'file', cat.color || '');
            card.innerHTML = `
                <button class="btn-delete-card" onclick="deleteRecvCategory('${cat.id}')">Ã—</button>
                <div class="simple-asset-header" onclick="toggleRecvCategory('${cat.id}')">
                    <div>${iconHTML}</div>
                    <div><span class="recv-name-text">${cat.name}</span></div>
                </div>
                <div class="simple-asset-header-row">
                    <span></span><span>åç¨±</span><span>é‡‘é¡</span>
                </div>
                <div class="simple-asset-list" id="recv-list-${cat.id}"></div>
                <button class="btn" style="padding:6px; font-size:0.8rem;" onclick="addRecvAsset('${cat.id}')">+ æ–°å¢æ‡‰æ”¶</button>
                <div class="card-footer">
                    <div class="footer-row">
                        <span class="sum-label">åˆè¨ˆ</span>
                        <span class="recv-sum-display">$0</span>
                        <span class="current-p" style="visibility:hidden">0%</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
            if (cat.color) card.setAttribute('data-color', cat.color);
            if (cat.icon) card.setAttribute('data-icon', cat.icon);
            if (data.items && data.items.length > 0) data.items.forEach(i => addRecvAsset(cat.id, i.name, i.amount));
            else addRecvAsset(cat.id);
            new Sortable(document.getElementById(`recv-list-${cat.id}`), {
                animation: 150, delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5,
                group: { name: 'recv-items', put: ['recv-items'] },
                onMove: function(evt){ return !evt.dragged.classList.contains('simple-asset-card'); },
                onEnd: () => calculateAllReceivables()
            });
        });
        new Sortable(grid, {
            animation: 150, handle: '.simple-asset-header', delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5,
            group: { name: 'recv-cards', pull: true, put: ['recv-cards'] }, draggable: '.simple-asset-card',
            onMove: function(evt){ var g = document.getElementById('recvGrid'); return evt.related && evt.related.parentNode === g && evt.related.classList.contains('simple-asset-card'); },
            onEnd: function(){ var g = document.getElementById('recvGrid'); document.querySelectorAll('.simple-asset-card').forEach(function(card){ if (card.classList.contains('in-sheet') || card.id.startsWith('fixed_')) return; if (card.parentElement && card.parentElement !== g){ var idx = recvCategories.findIndex(function(c){ return c.id === card.id; }); var next = idx >= 0 && idx < g.children.length ? g.children[idx] : null; if (next) g.insertBefore(card, next); else g.appendChild(card); } }); calculateAllReceivables(); }
        });
        calculateAllReceivables();
        refreshIcons(grid);
    }
    function addRecvAsset(catId, name='', amount=0) {
        const list = document.getElementById(`recv-list-${catId}`); if (!list) return;
        const div = document.createElement('div'); div.className = 'simple-asset-item';
        const amountDisplay = (amount === '' || amount == 0) ? '-' : formatCurrency(amount);
        div.innerHTML = `
            <button class="btn-delete-left" onclick="this.closest('.simple-asset-item').remove(); calculateAllReceivables();">Ã—</button>
            <div>
                <div class="static-view" onclick="editMode(this)">${name || 'é»æ“Šè¼¸å…¥'}</div>
                <div class="edit-container"><input type="text" class="edit-input recv-name" value="${name}" onblur="autoViewModeRecv(this)"></div>
            </div>
            <div>
                <div class="static-view" onclick="editMode(this)">${amountDisplay}</div>
                <div class="edit-container prefix"><input type="number" inputmode="decimal" step="any" class="edit-input recv-amount" value="${amount}" onblur="autoViewModeRecv(this)" oninput="calculateAllReceivables()"></div>
            </div>
        `;
        list.appendChild(div);
    }
    function autoViewModeRecv(iEl) {
        const view = iEl.parentElement.previousElementSibling;
        let dV = iEl.value;
        if (iEl.type === 'number') {
            if (dV === "" || isNaN(dV) || dV == 0) {
                view.innerText = "-";
                view.classList.add('empty-placeholder');
            } else {
                view.innerText = formatCurrency(dV);
                view.classList.remove('empty-placeholder');
            }
        } else {
            view.innerText = dV || "é»æ“Šè¼¸å…¥";
            view.classList.toggle('empty-placeholder', !dV);
        }
        setTimeout(() => {
            iEl.parentElement.style.display = 'none';
            view.style.display = 'flex';
            calculateAllReceivables();
        }, 150);
    }
    function addRecvCategory() {
        recvCategories.push({ id: 'recv_'+Date.now(), name: 'æ–°æ‡‰æ”¶å¸³æ¬¾' });
        renderReceivablesUI();
    }
    async function deleteRecvCategory(id) {
        if (await showConfirm('æ˜¯å¦ç¢ºå®šè¦åˆªé™¤æ­¤æ‡‰æ”¶å¸³æ¬¾é¡åˆ¥ï¼Ÿ', { danger: true })) {
            if (sheetCardEl && sheetCardEl.id === id) closeSheet();
            recvCategories = recvCategories.filter(c => c.id !== id);
            renderReceivablesUI();
            forceSaveRecv();
        }
    }
    function toggleRecvCategory(id) {
        const target = event.target;
        if (target.tagName === 'INPUT' || target.isContentEditable) return;
        openSheetWithCard(id);
    }
    function forceSaveRecv() {
        try {
            const data = {}, newCats = [];
            document.getElementById('recvGrid')?.querySelectorAll('.simple-asset-card').forEach(card => {
                const items = [];
                card.querySelectorAll('.simple-asset-item').forEach(item => {
                    items.push({
                        name: item.querySelector('.recv-name').value || '',
                        amount: parseFloat(item.querySelector('.recv-amount').value) || 0
                    });
                });
                newCats.push({ id: card.id, name: card.querySelector('.recv-name-text').innerText, color: card.getAttribute('data-color') || '', icon: card.getAttribute('data-icon') || '' });
                data[card.id] = { collapsed: card.classList.contains('collapsed'), items: items };
            });
            recvCategories = newCats;
            localStorage.setItem('myRecv_v1', JSON.stringify(data));
            localStorage.setItem('recvConfig_v1', JSON.stringify(recvCategories));
            const dot = document.getElementById('saveDotRecv');
            if (dot) { dot.classList.add('active'); setTimeout(() => dot.classList.remove('active'), 800); }
        } catch(e) {}
    }
    async function clearAllRecv() {
        if (await showConfirm('æ˜¯å¦æ¸…é™¤æ‰€æœ‰æ‡‰æ”¶å¸³æ¬¾è³‡æ–™ä¸¦é‡ç½®ï¼Ÿ', { danger: true })) {
            localStorage.removeItem('myRecv_v1');
            localStorage.removeItem('recvConfig_v1');
            recvCategories = RECV_DEFAULT_CONFIG.map(d => ({ id: d.id, name: d.name }));
            renderReceivablesUI();
            calculateAllReceivables();
        }
    }
    function calculateAllReceivables() {
        let total = 0;
        const grid = document.getElementById('recvGrid');
        if (!grid) return;
        let cards = Array.from(grid.querySelectorAll('.simple-asset-card'));
        if (sheetCardEl && sheetCardEl.classList.contains('simple-asset-card') && sheetCardEl.id && String(sheetCardEl.id).startsWith('recv_')) cards.push(sheetCardEl);
        cards.forEach(card => {
            let sum = 0;
            card.querySelectorAll('.recv-amount').forEach(i => { sum += parseFloat(i.value) || 0; });
            const sumDisplay = card.querySelector('.recv-sum-display');
            if (sumDisplay) { sumDisplay.innerText = formatCurrency(sum); applySumDisplaySize(sumDisplay); }
            total += sum;
        });
        receivableTotal = total;
        const totalEl = document.getElementById('recvRebalanceSummary');
        if (totalEl) totalEl.innerText = formatCurrency(total);
        setSummaryTrend('recvRebalanceSummary', 'recvRebalanceSummaryTrend', total, prevRecvTotal);
        prevRecvTotal = total;
        updateDashboard();
        forceSaveRecv();
    }

    var myHistoryChart = null;
    var HISTORY_MAX = 60;
    function pushHistory(key, value) {
        try {
            var arr = JSON.parse(localStorage.getItem('history_' + key) || '[]');
            var now = Date.now();
            var today = new Date(now).toDateString();
            var last = arr[arr.length - 1];
            var lastDay = last ? new Date(last.t).toDateString() : '';
            if (lastDay !== today) {
                arr.push({ t: now, v: value });
                if (arr.length > HISTORY_MAX) arr = arr.slice(-HISTORY_MAX);
                localStorage.setItem('history_' + key, JSON.stringify(arr));
            } else {
                arr[arr.length - 1] = { t: now, v: value };
                localStorage.setItem('history_' + key, JSON.stringify(arr));
            }
        } catch (e) {}
    }
    function openHistoryChart(type) {
        if (type === 'netWorth') return;
        var container = document.getElementById('chartContainer');
        var slides = document.getElementById('chartSlides');
        var titleEl = document.getElementById('historyChartTitle');
        var canvas = document.getElementById('historyChartCanvas');
        if (!container || !slides || !canvas) return;
        container.style.display = 'flex';
        titleEl.textContent = 'æµå‹•è³‡ç”¢ç¸½é¡ æ­·å²è®ŠåŒ–';
        var arr = JSON.parse(localStorage.getItem('history_assets') || '[]');
        var hintEl = document.getElementById('historyChartHint');
        if (arr.length === 0) {
            if (hintEl) hintEl.textContent = 'å°šç„¡æ­·å²ç´€éŒ„ï¼Œè«‹å…ˆè¼¸å…¥è³‡æ–™ä¸¦åœ¨ç¸½è¦½é æ›´æ–°å¾Œå†è©¦ã€‚';
            slides.classList.add('show-history');
            updateChartDots(1);
            return;
        }
        if (hintEl) hintEl.textContent = 'æ¯æ—¥ä¸€ç­†ï¼Œå„²å­˜æœ€è¿‘ 60 å¤©';
        var labels = arr.map(function (d) {
            var dt = new Date(d.t);
            return (dt.getMonth() + 1) + '/' + dt.getDate();
        });
        var values = arr.map(function (d) { return d.v; });
        if (myHistoryChart) myHistoryChart.destroy();
        myHistoryChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'æµå‹•è³‡ç”¢',
                    data: values,
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--theme-accent').trim(),
                    backgroundColor: 'rgba(0,0,0,0.05)',
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });
        slides.classList.add('show-history');
        updateChartDots(1);
    }
    var myNetWorthHistoryChart = null;
    function toggleNetWorthChart() {
        var el = document.getElementById('netWorthHistoryExpand');
        var canvas = document.getElementById('netWorthHistoryCanvas');
        var hintEl = document.getElementById('netWorthHistoryHint');
        if (!el || !canvas) return;
        if (el.style.display === 'none' || !el.style.display) {
            el.style.display = 'block';
            var arr = JSON.parse(localStorage.getItem('history_netWorth') || '[]');
            if (hintEl) hintEl.textContent = arr.length === 0 ? 'å°šç„¡æ­·å²ç´€éŒ„ï¼Œè«‹å…ˆè¼¸å…¥è³‡æ–™ä¸¦åœ¨ç¸½è¦½é æ›´æ–°å¾Œå†è©¦ã€‚' : 'æ¯æ—¥ä¸€ç­†ï¼Œå„²å­˜æœ€è¿‘ 60 å¤©';
            if (arr.length > 0) {
                var labels = arr.map(function (d) {
                    var dt = new Date(d.t);
                    return (dt.getMonth() + 1) + '/' + dt.getDate();
                });
                var values = arr.map(function (d) { return d.v; });
                if (myNetWorthHistoryChart) myNetWorthHistoryChart.destroy();
                myNetWorthHistoryChart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ·¨è³‡ç”¢',
                            data: values,
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--theme-accent').trim(),
                            backgroundColor: 'rgba(0,0,0,0.05)',
                            fill: true,
                            tension: 0.2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: false } }
                    }
                });
            }
        } else {
            el.style.display = 'none';
            if (myNetWorthHistoryChart) { myNetWorthHistoryChart.destroy(); myNetWorthHistoryChart = null; }
        }
    }
    function closeHistoryChart() {
        var slides = document.getElementById('chartSlides');
        if (slides) slides.classList.remove('show-history');
        updateChartDots(0);
    }
    function updateChartDots(activeIndex) {
        var dots = document.getElementById('chartDots');
        if (!dots) return;
        dots.querySelectorAll('.chart-dot').forEach(function(dot, i) {
            dot.classList.toggle('active', i === activeIndex);
        });
    }

    function updateDashboard() {
        const dashAssets = document.getElementById('dash-total-assets');
        const dashNet = document.getElementById('dash-net-worth');
        const dashLiabilities = document.getElementById('dash-total-liabilities');
        const totalAssets = (assetTotal || 0) + (fixedTotal || 0) + (receivableTotal || 0);
        const netWorth = totalAssets - liabilityTotal;
        pushHistory('netWorth', netWorth);
        pushHistory('assets', assetTotal != null ? assetTotal : 0);
        if (dashAssets) dashAssets.innerText = formatCurrency(totalAssets);
        if (dashLiabilities) dashLiabilities.innerText = formatCurrency(liabilityTotal);
        if (dashNet) {
            dashNet.innerText = formatCurrency(netWorth);
            dashNet.classList.remove('positive', 'negative');
            dashNet.classList.add(netWorth >= 0 ? 'positive' : 'negative');
        }
        updateOverviewChart(totalAssets, liabilityTotal);
    }

    function updateOverviewChart(totalAssets, totalLiab) {
        const ctx = document.getElementById('overviewChart');
        if (!ctx) return;
        const cA = getComputedStyle(document.documentElement).getPropertyValue('--theme-accent').trim();
        const cB = getComputedStyle(document.documentElement).getPropertyValue('--theme-bg').trim();
        const colors = [cA, cB];
        const data = {
            labels: ['è³‡ç”¢', 'è² å‚µ'],
            datasets: [{ data: [totalAssets, totalLiab], backgroundColor: colors, borderWidth: 2 }]
        };
        const options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } };
        if (myOverviewChart) {
            myOverviewChart.data = data;
            myOverviewChart.update();
            myOverviewChart.resize();
        } else {
            myOverviewChart = new Chart(ctx, { type: 'doughnut', data, options });
        }
    }

    function updateChart(catSums, grandTotal) {
        const container = document.getElementById('chartContainer');
        const ctx = document.getElementById('portfolioChart'); 
        if (!ctx || container.style.display === 'none') return;
        const cA = getComputedStyle(document.documentElement).getPropertyValue('--theme-accent').trim();
        const cB = getComputedStyle(document.documentElement).getPropertyValue('--theme-bg').trim();
        const ids = Object.keys(catSums);
        const colors = ids.map((_, i) => interpolateColor(cA, cB, i / (ids.length > 1 ? ids.length - 1 : 1)));
        const labels = ids.map(id => document.getElementById(id).querySelector('.cat-name-text').innerText);
        const dataValues = ids.map(id => catSums[id]);
        if (myChart) {
            myChart.data.labels = labels; myChart.data.datasets[0].data = dataValues; myChart.data.datasets[0].backgroundColor = colors;
            myChart.update(); myChart.resize();
        } else {
            myChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: dataValues, backgroundColor: colors, borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
            });
        }
    }

    function updateLiabChart() {
        const container = document.getElementById('liabChartContainer');
        const ctx = document.getElementById('liabChart');
        if (!ctx || !container) return;
        const liabSums = {};
        document.querySelectorAll('.liab-card').forEach(card => {
            let sum = 0;
            card.querySelectorAll('.liab-amount').forEach(i => { sum += parseFloat(i.value) || 0; });
            liabSums[card.id] = sum;
        });
        const ids = Object.keys(liabSums).filter(id => liabSums[id] > 0);
        if (ids.length === 0 && myLiabChart) {
            myLiabChart.data.labels = ['å°šç„¡è³‡æ–™']; myLiabChart.data.datasets[0].data = [1]; myLiabChart.update();
            return;
        }
        if (ids.length === 0) return;
        const cA = getComputedStyle(document.documentElement).getPropertyValue('--theme-accent').trim();
        const cB = getComputedStyle(document.documentElement).getPropertyValue('--theme-bg').trim();
        const labels = ids.map(id => document.getElementById(id)?.querySelector('.liab-name-text')?.innerText || id);
        const dataValues = ids.map(id => liabSums[id]);
        const colors = ids.map((_, i) => interpolateColor(cA, cB, ids.length > 1 ? i / (ids.length - 1) : 0));
        if (myLiabChart) {
            myLiabChart.data.labels = labels; myLiabChart.data.datasets[0].data = dataValues; myLiabChart.data.datasets[0].backgroundColor = colors;
            myLiabChart.update(); myLiabChart.resize();
        } else {
            myLiabChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: dataValues, backgroundColor: colors, borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }
            });
        }
    }

    function toggleLiabChart() {
        const c = document.getElementById('liabChartContainer');
        if (c) { c.style.display = c.style.display === 'none' ? 'block' : 'none'; calculateAllLiabilities(); }
    }

    function interpolateColor(c1, c2, f) {
        const r1 = parseInt(c1.substring(1,3), 16), g1 = parseInt(c1.substring(3,5), 16), b1 = parseInt(c1.substring(5,7), 16);
        const r2 = parseInt(c2.substring(1,3), 16), g2 = parseInt(c2.substring(3,5), 16), b2 = parseInt(c2.substring(5,7), 16);
        return `rgb(${Math.round(r1 + f * (r2-r1))}, ${Math.round(g1 + f * (g2-g1))}, ${Math.round(b1 + f * (b2-b1))})`;
    }

    // === åº•éƒ¨æ»‘å‡ºç´°ç¯€é  ===
    let sheetCardEl = null, sheetOriginalParent = null, sheetPlaceholder = null, sheetOpenedAt = 0;
    function openSheetWithCard(cardId) {
        var card = document.getElementById(cardId);
        if (!card) return;
        sheetCardEl = card;
        sheetOriginalParent = card.parentElement;
        sheetPlaceholder = document.createElement('div');
        sheetPlaceholder.id = 'sheet-placeholder-' + cardId;
        sheetPlaceholder.style.display = 'none';
        sheetOriginalParent.insertBefore(sheetPlaceholder, card);
        card.classList.remove('collapsed');
        card.classList.add('in-sheet');
        document.getElementById('sheetContent').appendChild(card);
        document.getElementById('sheetBackdrop').style.display = 'block';
        document.getElementById('detailSheet').classList.add('open');
        sheetOpenedAt = Date.now();
        var footer = document.getElementById('sheetFooter');
        var deleteBtn = document.getElementById('sheetDeleteCardBtn');
        if (footer) footer.style.display = 'block';
        if (deleteBtn) {
            deleteBtn.onclick = function() {
                var id = sheetCardEl.id;
                var isCat = sheetCardEl.classList.contains('category-card');
                var isLiab = sheetCardEl.classList.contains('liab-card');
                var isSimple = sheetCardEl.classList.contains('simple-asset-card');
                closeSheet();
                if (isCat) deleteCategory(id);
                else if (isLiab) deleteLiabCategory(id);
                else if (isSimple) { if (String(id).startsWith('fixed_')) deleteFixedCategory(id); else deleteRecvCategory(id); }
            };
        }
        refreshIcons(document.getElementById('detailSheet'));
        closePickerPanel();
        closeAllAssetItemReveal();
        var iconEl = sheetCardEl.querySelector('.card-icon');
        if (iconEl) {
            iconEl.onclick = function(e) { e.stopPropagation(); openPickerPanel(); };
        }
        var nameEl = sheetCardEl.querySelector('.cat-name-text') || sheetCardEl.querySelector('.liab-name-text') || sheetCardEl.querySelector('.fixed-name-text') || sheetCardEl.querySelector('.recv-name-text');
        if (nameEl) {
            nameEl.setAttribute('contenteditable', 'true');
            nameEl._sheetBlur = function() {
                if (sheetCardEl.classList.contains('category-card')) forceSave();
                else if (sheetCardEl.classList.contains('liab-card')) forceSaveLiab();
                else if (sheetCardEl.classList.contains('simple-asset-card')) { if (sheetCardEl.id.startsWith('fixed_')) forceSaveFixed(); else forceSaveRecv(); }
            };
            nameEl.onblur = nameEl._sheetBlur;
        }
    }
    function closeSheet() {
        closePickerPanel();
        var sheet = document.getElementById('detailSheet');
        var backdrop = document.getElementById('sheetBackdrop');
        if (sheet) sheet.classList.remove('open');
        if (backdrop) backdrop.style.display = 'none';
        if (sheetCardEl && sheetOriginalParent) {
            var nameEl = sheetCardEl.querySelector('.cat-name-text') || sheetCardEl.querySelector('.liab-name-text') || sheetCardEl.querySelector('.fixed-name-text') || sheetCardEl.querySelector('.recv-name-text');
            if (nameEl) { nameEl.removeAttribute('contenteditable'); nameEl.onblur = null; nameEl._sheetBlur = null; }
            sheetCardEl.classList.remove('in-sheet');
            sheetCardEl.classList.add('collapsed');
            let container = null;
            if (sheetCardEl.classList.contains('category-card')) container = document.getElementById('mainGrid');
            else if (sheetCardEl.classList.contains('liab-card')) container = document.getElementById('liabGrid');
            else if (sheetCardEl.classList.contains('simple-asset-card')) {
                const isFixed = sheetCardEl.querySelector('.simple-asset-header-row')?.textContent?.includes('åç¨±') && sheetCardEl.id.startsWith('fixed_');
                container = isFixed ? document.getElementById('fixedGrid') : document.getElementById('recvGrid');
            }
            if (!container) container = sheetOriginalParent;
            var placeById = document.getElementById('sheet-placeholder-' + sheetCardEl.id);
            if (placeById && placeById.parentNode) {
                placeById.parentNode.replaceChild(sheetCardEl, placeById);
            } else if (sheetPlaceholder && sheetPlaceholder.parentElement) {
                sheetPlaceholder.parentElement.replaceChild(sheetCardEl, sheetPlaceholder);
            } else if (container) {
                var idx = -1;
                if (sheetCardEl.classList.contains('category-card')) idx = categories.findIndex(function(c){ return c.id === sheetCardEl.id; });
                else if (sheetCardEl.classList.contains('liab-card')) idx = liabCategories.findIndex(function(c){ return c.id === sheetCardEl.id; });
                else if (sheetCardEl.classList.contains('simple-asset-card')) {
                    var arr = sheetCardEl.id.startsWith('fixed_') ? fixedCategories : recvCategories;
                    idx = arr.findIndex(function(c){ return c.id === sheetCardEl.id; });
                }
                var next = idx >= 0 && idx < container.children.length ? container.children[idx] : null;
                if (next) container.insertBefore(sheetCardEl, next);
                else container.appendChild(sheetCardEl);
            }
            sheetCardEl = null; sheetOriginalParent = null; sheetPlaceholder = null; sheetOpenedAt = 0;
        }
        var footer = document.getElementById('sheetFooter');
        if (footer) footer.style.display = 'none';
    }
    function applyIconToCard(card, iconName) {
        const icon = sanitizeIconName(iconName);
        card.setAttribute('data-icon', icon);
        const holder = card.querySelector('.card-icon');
        const color = card.getAttribute('data-color') || '';
        if (holder) holder.outerHTML = getIconHTML(icon, color);
        refreshIcons(card);
    }
    function applyColorToCard(card, color) {
        card.setAttribute('data-color', color);
        const holder = card.querySelector('.card-icon');
        const icon = card.getAttribute('data-icon') || 'wallet';
        if (holder) holder.outerHTML = getIconHTML(icon, color);
        refreshIcons(card);
    }
    function persistCardStyle(card) {
        if (card.classList.contains('category-card')) forceSave();
        else if (card.classList.contains('liab-card')) forceSaveLiab();
        else if (card.classList.contains('simple-asset-card')) {
            const pid = card.parentElement?.id || '';
            if (pid.startsWith('fixed')) forceSaveFixed(); else forceSaveRecv();
        }
    }
    function setSheetCardIcon(iconName) {
        if (!sheetCardEl) return;
        applyIconToCard(sheetCardEl, iconName);
        persistCardStyle(sheetCardEl);
        reattachPickerTrigger();
        closePickerPanel();
    }
    function setSheetCardColor(color) {
        if (!sheetCardEl) return;
        applyColorToCard(sheetCardEl, color);
        persistCardStyle(sheetCardEl);
        reattachPickerTrigger();
        closePickerPanel();
    }
    function reattachPickerTrigger() {
        if (!sheetCardEl) return;
        var iconEl = sheetCardEl.querySelector('.card-icon');
        if (iconEl) iconEl.onclick = function(e) { e.stopPropagation(); openPickerPanel(); };
    }
    function closePickerPanel() {
        var wrap = document.getElementById('pickerPanelWrap');
        var backdrop = document.getElementById('pickerBackdrop');
        if (wrap) wrap.style.display = 'none';
        if (backdrop) backdrop.style.display = 'none';
    }
    function switchPickerTab(tabId) {
        var wrap = document.getElementById('pickerPanelWrap');
        if (!wrap) return;
        wrap.querySelectorAll('.picker-tab').forEach(function(btn) {
            btn.classList.toggle('active', btn.getAttribute('data-tab') === tabId);
        });
        var iconsContent = document.getElementById('pickerTabIcons');
        var colorsContent = document.getElementById('pickerTabColors');
        if (iconsContent) iconsContent.classList.toggle('active', tabId === 'icons');
        if (colorsContent) colorsContent.classList.toggle('active', tabId === 'colors');
    }
    function openPickerPanel() {
        var wrap = document.getElementById('pickerPanelWrap');
        var panel = document.getElementById('pickerPanel');
        var backdrop = document.getElementById('pickerBackdrop');
        if (!wrap || !panel) return;
        buildIconGrid();
        buildColorGrid();
        if (backdrop) backdrop.style.display = 'block';
        wrap.style.display = 'flex';
        switchPickerTab('icons');
        var inner = panel.querySelector('.picker-panel-inner');
        if (inner) inner.scrollTop = 0;
        setTimeout(function() { refreshIcons(panel); }, 80);
    }
    function closeIconGrid() {
        closePickerPanel();
    }
    function closeColorGrid() {
        closePickerPanel();
    }
    function buildIconGrid() {
        const g = document.getElementById('iconGrid');
        const g2 = document.getElementById('iconGridOther');
        if (!g) return;
        var allNames = [...new Set([...moneyIconList, ...iconList])];
        var moneyIcons = moneyIconList.filter(function(n){ return allNames.indexOf(n) !== -1; });
        var otherIcons = iconList.filter(function(n){ return moneyIconList.indexOf(n) === -1; });
        g.innerHTML = '';
        moneyIcons.forEach(function(n) {
            var b = document.createElement('button');
            b.className = 'icon-dot';
            b.innerHTML = '<i data-lucide="' + n + '"></i>';
            b.onclick = function(){ setSheetCardIcon(n); };
            b.title = n;
            g.appendChild(b);
        });
        if (g2) {
            g2.innerHTML = '';
            otherIcons.forEach(function(n) {
                var b = document.createElement('button');
                b.className = 'icon-dot';
                b.innerHTML = '<i data-lucide="' + n + '"></i>';
                b.onclick = function(){ setSheetCardIcon(n); };
                b.title = n;
                g2.appendChild(b);
            });
        }
        setTimeout(function(){ refreshIcons(g); if (g2) refreshIcons(g2); }, 50);
    }
    function buildColorGrid() {
        var g = document.getElementById('colorGrid');
        if (!g) return;
        g.innerHTML = '';
        colorFamilies.forEach(function(fam) {
            fam.colors.forEach(function(c) {
                var b = document.createElement('button');
                b.className = 'color-dot';
                b.style.background = c;
                b.title = fam.label + ' ' + c;
                b.onclick = function(){ setSheetCardColor(c); };
                g.appendChild(b);
            });
        });
    }
    document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide && typeof window.lucide.createIcons === 'function') {
            window.lucide.createIcons();
        }
    });
    function attachLongPressDelete(card) {
        var timer = null;
        var start = function() { timer = setTimeout(function() { card.classList.add('show-delete'); }, 1000); };
        var clear = function() { if (timer) { clearTimeout(timer); timer = null; } };
        card.addEventListener('touchstart', start, { passive: true });
        card.addEventListener('touchend', clear);
        card.addEventListener('touchcancel', clear);
        card.addEventListener('mousedown', start);
        card.addEventListener('mouseup', clear);
        card.addEventListener('mouseleave', clear);
    }
    function attachAssetItemSwipe(wrapEl) {
        if (!wrapEl || !wrapEl.classList.contains('asset-item-wrap')) return;
        var startX = 0, touchStartTime = 0;
        var row = wrapEl.querySelector('.asset-item');
        if (!row) return;
        var hoverTimer = null;
        wrapEl.addEventListener('mouseenter', function() {
            hoverTimer = setTimeout(function() { wrapEl.classList.add('reveal'); }, 450);
        });
        wrapEl.addEventListener('mouseleave', function() {
            if (hoverTimer) { clearTimeout(hoverTimer); hoverTimer = null; }
            wrapEl.classList.remove('reveal');
        });
        wrapEl.addEventListener('focusin', function(e) {
            if (e.target.matches('input, [contenteditable="true"]')) { wrapEl.classList.add('editing'); wrapEl.classList.remove('swiped'); wrapEl.classList.remove('reveal'); row.style.transform = ''; if (hoverTimer) { clearTimeout(hoverTimer); hoverTimer = null; } }
        });
        wrapEl.addEventListener('focusout', function(e) {
            if (!wrapEl.contains(e.relatedTarget)) wrapEl.classList.remove('editing');
        });
        wrapEl.addEventListener('touchstart', function(e) { startX = e.touches[0].clientX; touchStartTime = Date.now(); }, { passive: true });
        wrapEl.addEventListener('touchmove', function(e) {
            var x = e.touches[0].clientX;
            var delta = startX - x;
            if (delta > 0) row.style.transform = 'translateX(-' + Math.min(delta, 56) + 'px)';
            else row.style.transform = 'translateX(0)';
        }, { passive: true });
        wrapEl.addEventListener('touchend', function(e) {
            var endX = e.changedTouches[0].clientX;
            var delta = startX - endX;
            var duration = Date.now() - touchStartTime;
            var justOpened = sheetOpenedAt && (Date.now() - sheetOpenedAt < 550);
            row.style.transform = '';
            if (delta > 50 && duration > 180 && !justOpened) wrapEl.classList.add('swiped');
            else if (delta < -30) wrapEl.classList.remove('swiped');
        }, { passive: true });
    }
    function closeAllAssetItemReveal() {
        document.querySelectorAll('.asset-item-wrap').forEach(function(w) {
            w.classList.remove('reveal', 'swiped');
            var row = w.querySelector('.asset-item');
            if (row) row.style.transform = '';
        });
    }
    document.addEventListener('click', function(e) {
        if (e.target.closest('.asset-item-delete-reveal') || e.target.closest('.asset-item-delete-btn')) return;
        if (document.querySelector('.asset-item-wrap.reveal, .asset-item-wrap.swiped')) closeAllAssetItemReveal();
    });
    document.addEventListener('touchend', function(e) {
        if (e.target.closest('.asset-item-delete-reveal') || e.target.closest('.asset-item-delete-btn')) return;
        if (!e.target.closest('.asset-item-wrap') && document.querySelector('.asset-item-wrap.reveal, .asset-item-wrap.swiped')) closeAllAssetItemReveal();
    }, { passive: true });

    function renderUI() {
        const saved = JSON.parse(localStorage.getItem('myPortfolio_v5')) || {}, grid = document.getElementById('mainGrid'); grid.innerHTML = '';
        categories.forEach(cat => {
            if (sheetCardEl && sheetCardEl.classList.contains('category-card') && cat.id === sheetCardEl.id) {
                var ph = document.createElement('div'); ph.id = 'sheet-placeholder-' + cat.id; ph.style.display = 'none'; ph.setAttribute('data-sheet-placeholder', '1');
                grid.appendChild(ph);
                return;
            }
            const data = saved[cat.id] || { target: 20, assets: [], collapsed: true };
            const card = document.createElement('div'); card.id = cat.id; card.className = `category-card collapsed`;
            const iconHTML = getIconHTML(cat.icon || 'wallet', cat.color || '');
            card.innerHTML = `
                <button class="btn-delete-card" onclick="deleteCategory('${cat.id}')">Ã—</button>
                <div class="category-header" onclick="toggleCategory('${cat.id}')">
                    <div>${iconHTML}</div>
                    <div><span class="cat-name-text">${cat.name}</span></div>
                    <div class="card-subtitle"><span class="target-display">ç›®æ¨™ ${data.target}%</span></div>
                    <div class="target-edit" onclick="event.stopPropagation()">ç›®æ¨™ <input type="number" class="target-input" value="${data.target}" oninput="calculateAll()"> %<div class="target-amount-label">$0</div></div>
                </div>
                <div class="asset-header-row"><span></span><span>åç¨±</span><span>è‚¡æ•¸</span><span>å–®åƒ¹</span><span>ç¾å€¼</span><span>ç›®æ¨™%</span><span>å¯¦éš›%</span></div>
                <div class="asset-list" id="list-${cat.id}"></div>
                <button class="btn" style="padding:6px; font-size:0.8rem;" onclick="addAsset('${cat.id}')">+ æ–°å¢æ¨™çš„</button>
                <div class="card-footer"><div class="footer-row"><span class="sum-label">åˆè¨ˆ</span><span class="cat-sum-display">$0</span><span class="current-p">0%</span></div><div class="status-tag status-alert">âœ… æ¯”ä¾‹ç†æƒ³</div></div>
            `;
            grid.appendChild(card);
            card.addEventListener('click', function(e) {
                if (card.classList.contains('collapsed')) toggleCategory(card.id);
            });
            if (cat.color) card.setAttribute('data-color', cat.color);
            if (cat.icon) card.setAttribute('data-icon', cat.icon);
            if (data.assets && data.assets.length > 0) data.assets.forEach(a => addAsset(cat.id, a.name, a.value, a.targetP, a.qty, a.price));
            else addAsset(cat.id);
            new Sortable(document.getElementById(`list-${cat.id}`), { animation: 150, delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5, group: { name: 'asset-items', put: ['asset-items'] }, draggable: '.asset-item-wrap', onMove: function(evt){ return !evt.dragged.classList.contains('category-card'); }, onEnd: () => calculateAll() });
        });
        new Sortable(grid, { animation: 150, handle: '.category-header', delay: 200, delayOnTouchOnly: true, touchStartThreshold: 5, group: { name: 'asset-cards', pull: true, put: ['asset-cards'] }, draggable: '.category-card', onMove: function(evt){ var g = document.getElementById('mainGrid'); return evt.to === g && evt.related && evt.related.parentNode === g && evt.related.classList.contains('category-card'); }, onEnd: function(){ var g = document.getElementById('mainGrid'); document.querySelectorAll('.category-card').forEach(function(card){ if (card.classList.contains('in-sheet')) return; if (card.parentElement && card.parentElement !== g){ var idx = categories.findIndex(function(c){ return c.id === card.id; }); var next = idx >= 0 && idx < g.children.length ? g.children[idx] : null; if (next) g.insertBefore(card, next); else g.appendChild(card); } }); calculateAll(); } });
        calculateAll();
        refreshIcons(grid);
    }

    function addAsset(catId, name='', value=0, targetP=0, qty='', price='') {
        const list = document.getElementById(`list-${catId}`); if(!list) return;
        const wrap = document.createElement('div'); wrap.className = 'asset-item-wrap';
        const qD = (qty === '' || qty == 0) ? '-' : formatNum(qty), pD = (price === '' || price == 0) ? '-' : formatNum(price);
        wrap.innerHTML = `
            <div class="asset-item-delete-reveal"><button type="button" class="asset-item-delete-btn" onclick="var w=this.closest('.asset-item-wrap'); w.remove(); calculateAll();">åˆªé™¤</button></div>
            <div class="asset-item">
                <div><div class="static-view" onclick="editMode(this)">${name||'é»æ“Šè¼¸å…¥'}</div><div class="edit-container"><input type="text" class="edit-input asset-name" list="stockList" value="${name}" onblur="autoViewMode(this)"></div></div>
                <div><div class="static-view" onclick="editMode(this)">${qD}</div><div class="edit-container"><input type="number" inputmode="numeric" class="edit-input asset-qty" value="${qty}" onblur="autoViewMode(this)"></div></div>
                <div><div class="static-view" onclick="editMode(this)">${pD}</div><div class="edit-container"><input type="number" inputmode="decimal" step="any" class="edit-input asset-price" value="${price}" onblur="autoViewMode(this)"></div></div>
                <div><div class="static-view" onclick="editMode(this)">${formatCurrency(value)}</div><div class="edit-container prefix"><input type="number" inputmode="decimal" step="any" class="edit-input asset-value" value="${value}" onblur="autoViewMode(this)"></div></div>
                <div><div class="static-view" onclick="editMode(this)">${targetP}%</div><div class="edit-container suffix"><input type="number" inputmode="numeric" class="target-p-input edit-input" value="${targetP}" onblur="autoViewMode(this)"></div></div>
                <div style="font-size:10px; font-weight:bold; text-align:right;"><div class="ratio-val">0%</div><div class="diff-suggestion" style="font-size:8px;"></div></div>
            </div>
        `;
        list.appendChild(wrap);
        attachAssetItemSwipe(wrap);
    }

    function addCategory() { categories.push({ id: 'cat_'+Date.now(), name: 'æ–°å€åŸŸ' }); renderUI(); }
    async function deleteCategory(id) { if (await showConfirm('æ˜¯å¦ç¢ºå®šè¦åˆªé™¤æ­¤æŠ•è³‡å€åŸŸï¼Ÿ', { danger: true })) { if (sheetCardEl && sheetCardEl.id === id) closeSheet(); categories = categories.filter(c => c.id !== id); renderUI(); forceSave(); } }

    // ===== è² å‚µé é¢ï¼šUI èˆ‡è³‡æ–™è™•ç† =====
    function renderLiabilitiesUI() {
        const saved = JSON.parse(localStorage.getItem('myLiabilities_v1')) || {};
        const grid = document.getElementById('liabGrid');
        if (!grid) return;
        grid.innerHTML = '';

        liabCategories.forEach(cat => {
            if (sheetCardEl && sheetCardEl.classList.contains('liab-card') && cat.id === sheetCardEl.id) {
                var ph = document.createElement('div'); ph.id = 'sheet-placeholder-' + cat.id; ph.style.display = 'none'; ph.setAttribute('data-sheet-placeholder', '1');
                grid.appendChild(ph);
                return;
            }
            const data = saved[cat.id] || { items: [], collapsed: true };
            const card = document.createElement('div');
            card.id = cat.id;
            card.className = `liab-card collapsed`;
            const iconHTML = getIconHTML(cat.icon || 'credit-card', cat.color || '');
            card.innerHTML = `
                <button class="btn-delete-card" onclick="deleteLiabCategory('${cat.id}')">Ã—</button>
                <div class="liab-header" onclick="toggleLiabCategory('${cat.id}')">
                    <div>${iconHTML}</div>
                    <div><span class="liab-name-text">${cat.name}</span></div>
                </div>
                <div class="liab-header-row">
                    <span></span><span>åç¨±</span><span>é‡‘é¡</span>
                </div>
                <div class="liab-list" id="liab-list-${cat.id}"></div>
                <button class="btn" style="padding:6px; font-size:0.8rem;" onclick="addLiability('${cat.id}')">+ æ–°å¢è² å‚µ</button>
                <div class="card-footer">
                    <div class="footer-row">
                        <span class="sum-label">åˆè¨ˆ</span>
                        <span class="liab-sum-display">$0</span>
                        <span class="current-p" style="visibility:hidden">0%</span>
                    </div>
                </div>
            `;
            grid.appendChild(card);
            card.setAttribute('data-color', cat.color || '');
            card.setAttribute('data-icon', cat.icon || 'credit-card');

            if (data.items && data.items.length > 0) {
                data.items.forEach(i => addLiability(cat.id, i.name, i.amount));
            } else {
                addLiability(cat.id);
            }

            new Sortable(document.getElementById(`liab-list-${cat.id}`), {
                animation: 150,
                delay: 200,
                delayOnTouchOnly: true,
                touchStartThreshold: 5,
                group: { name: 'liab-items', put: ['liab-items'] },
                onMove: function(evt){ return !evt.dragged.classList.contains('liab-card'); },
                onEnd: () => calculateAllLiabilities()
            });
        });

        new Sortable(grid, {
            animation: 150,
            handle: '.liab-header',
            delay: 200,
            delayOnTouchOnly: true,
            touchStartThreshold: 5,
            group: { name: 'liab-cards', pull: true, put: ['liab-cards'] },
            draggable: '.liab-card',
            onMove: function(evt){ var g = document.getElementById('liabGrid'); return evt.related && evt.related.parentNode === g && evt.related.classList.contains('liab-card'); },
            onEnd: function(){ var g = document.getElementById('liabGrid'); document.querySelectorAll('.liab-card').forEach(function(card){ if (card.classList.contains('in-sheet')) return; if (card.parentElement && card.parentElement !== g){ var idx = liabCategories.findIndex(function(c){ return c.id === card.id; }); var next = idx >= 0 && idx < g.children.length ? g.children[idx] : null; if (next) g.insertBefore(card, next); else g.appendChild(card); } }); calculateAllLiabilities(); }
        });

        calculateAllLiabilities();
        refreshIcons(grid);
    }

    function addLiability(catId, name='', amount=0) {
        const list = document.getElementById(`liab-list-${catId}`); if (!list) return;
        const div = document.createElement('div'); div.className = 'liab-item';
        const amountDisplay = (amount === '' || amount == 0) ? '-' : formatCurrency(amount);
        div.innerHTML = `
            <button class="btn-delete-left" onclick="this.closest('.liab-item').remove(); calculateAllLiabilities();">Ã—</button>
            <div>
                <div class="static-view" onclick="editMode(this)">${name || 'é»æ“Šè¼¸å…¥'}</div>
                <div class="edit-container"><input type="text" class="edit-input liab-name" value="${name}" onblur="autoViewModeLiab(this)"></div>
            </div>
            <div>
                <div class="static-view" onclick="editMode(this)">${amountDisplay}</div>
                <div class="edit-container prefix"><input type="number" inputmode="decimal" step="any" class="edit-input liab-amount" value="${amount}" onblur="autoViewModeLiab(this)" oninput="calculateAllLiabilities()"></div>
            </div>
        `;
        list.appendChild(div);
    }

    function addLiabCategory() {
        liabCategories.push({ id: 'debt_'+Date.now(), name: 'æ–°è² å‚µ', color: '', icon: 'credit-card' });
        renderLiabilitiesUI();
    }

    async function deleteLiabCategory(id) {
        if (await showConfirm('æ˜¯å¦ç¢ºå®šè¦åˆªé™¤æ­¤è² å‚µé¡åˆ¥ï¼Ÿ', { danger: true })) {
            if (sheetCardEl && sheetCardEl.id === id) closeSheet();
            liabCategories = liabCategories.filter(c => c.id !== id);
            renderLiabilitiesUI();
            forceSaveLiab();
        }
    }

    function toggleLiabCategory(id) {
        const target = event.target;
        if (target.tagName === 'INPUT' || target.isContentEditable) {
            return;
        }
        openSheetWithCard(id);
    }

    function autoViewModeLiab(iEl) {
        const view = iEl.parentElement.previousElementSibling;
        let dV = iEl.value;
        if (iEl.type === 'number') {
            if (dV === "" || isNaN(dV) || dV == 0) {
                view.innerText = "-";
                view.classList.add('empty-placeholder');
            } else {
                view.innerText = formatCurrency(dV);
                view.classList.remove('empty-placeholder');
            }
        } else {
            view.innerText = dV || "é»æ“Šè¼¸å…¥";
            view.classList.toggle('empty-placeholder', !dV);
        }
        setTimeout(() => {
            iEl.parentElement.style.display = 'none';
            view.style.display = 'flex';
            calculateAllLiabilities();
        }, 150);
    }

    function forceSaveLiab() {
        try {
            const data = {}, newCats = [];
            document.querySelectorAll('.liab-card').forEach(card => {
                const items = [];
                card.querySelectorAll('.liab-item').forEach(item => {
                    items.push({
                        name: item.querySelector('.liab-name').value || '',
                        amount: parseFloat(item.querySelector('.liab-amount').value) || 0
                    });
                });
                newCats.push({ id: card.id, name: card.querySelector('.liab-name-text').innerText, color: card.getAttribute('data-color') || '', icon: card.getAttribute('data-icon') || '' });
                data[card.id] = { collapsed: card.classList.contains('collapsed'), items: items };
            });
            liabCategories = newCats;
            localStorage.setItem('myLiabilities_v1', JSON.stringify(data));
            localStorage.setItem('liabConfig_v1', JSON.stringify(liabCategories));
            const dot = document.getElementById('saveDotLiab');
            if (dot) {
                dot.classList.add('active');
                setTimeout(() => dot.classList.remove('active'), 800);
            }
        } catch(e) {}
    }

    async function clearAllLiabilities() {
        if (await showConfirm('æ˜¯å¦æ¸…é™¤æ‰€æœ‰è² å‚µè³‡æ–™ä¸¦é‡ç½®ï¼Ÿ', { danger: true })) {
            localStorage.removeItem('myLiabilities_v1');
            localStorage.removeItem('liabConfig_v1');
            liabCategories = LIAB_DEFAULT_CONFIG.map(d => ({ id: d.id, name: d.name, color: '', icon: 'credit-card' }));
            renderLiabilitiesUI();
            calculateAllLiabilities();
        }
    }

    function toggleCategory(id) {
        const target = event.target;
        if (target.tagName === 'INPUT' || target.isContentEditable) return;
        openSheetWithCard(id);
    }
    function toggleChart() { const c = document.getElementById('chartContainer'); c.style.display = c.style.display === 'none' ? 'flex' : 'none'; calculateAll(); }
    async function clearAll() { if (await showConfirm('æ˜¯å¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡ç½®ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚', { danger: true })) { localStorage.clear(); location.reload(); } }

    function toggleHideAmounts() {
        hideAmounts = !hideAmounts;
        localStorage.setItem('hideAmounts', hideAmounts ? '1' : '0');
        const btn = document.getElementById('hideToggleBtn');
        if (btn) btn.textContent = hideAmounts ? 'ğŸ‘ï¸ é¡¯ç¤ºé‡‘é¡' : 'ğŸ™ˆ éš±è—é‡‘é¡';
        calculateAll();
        calculateAllFixedAssets();
        calculateAllReceivables();
        calculateAllLiabilities();
        updateDashboard();
    }
    function initHideAmounts() {
        hideAmounts = localStorage.getItem('hideAmounts') === '1';
        const btn = document.getElementById('hideToggleBtn');
        if (btn) btn.textContent = hideAmounts ? 'ğŸ‘ï¸ é¡¯ç¤ºé‡‘é¡' : 'ğŸ™ˆ éš±è—é‡‘é¡';
    }
    function handleNavAssetsClick() {
        var currentPage = null;
        document.querySelectorAll('.page-view').forEach(function(p) { if (p.style.display === 'block') currentPage = p.id; });
        if (currentPage === 'home-view' || currentPage === 'liabilities-view') {
            showPage('assets-view');
            hideAssetsMenu();
        } else {
            toggleAssetsMenu();
        }
    }
    function toggleAssetsMenu() {
        var m = document.getElementById('assetsMenu');
        if (!m) return;
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
    }
    function hideAssetsMenu() {
        const m = document.getElementById('assetsMenu');
        if (m) m.style.display = 'none';
    }
    document.addEventListener('click', (e) => {
        const m = document.getElementById('assetsMenu');
        const navAssets = document.getElementById('nav-assets');
        if (!m || !navAssets) return;
        if (m.style.display === 'block' && !m.contains(e.target) && e.target !== navAssets) {
            m.style.display = 'none';
        }
    });

    window.onload = () => {
        loadStockData();
        const s = localStorage.getItem('catConfig_v5');
        categories = s ? JSON.parse(s) : DEFAULT_CONFIG.map(d => ({ id: d.id, name: d.name, color: '', icon: 'wallet' }));
        const liabS = localStorage.getItem('liabConfig_v1');
        liabCategories = liabS ? JSON.parse(liabS) : LIAB_DEFAULT_CONFIG.map(d => ({ id: d.id, name: d.name, color: '', icon: 'credit-card' }));
        const fixedS = localStorage.getItem('fixedConfig_v1');
        fixedCategories = fixedS ? JSON.parse(fixedS) : FIXED_DEFAULT_CONFIG.map(d => ({ id: d.id, name: d.name, color: '', icon: 'home' }));
        const recvS = localStorage.getItem('recvConfig_v1');
        recvCategories = recvS ? JSON.parse(recvS) : RECV_DEFAULT_CONFIG.map(d => ({ id: d.id, name: d.name, color: '', icon: 'file' }));
        renderUI();
        renderLiabilitiesUI();
        renderFixedAssetsUI();
        renderReceivablesUI();
        setTheme(localStorage.getItem('userTheme') || 'orange');
        initHideAmounts();
        initNightMode();
        showPage('home-view');
        var chartContainer = document.getElementById('chartContainer');
        if (chartContainer) {
            var startX = 0;
            chartContainer.addEventListener('touchstart', function(e) { startX = e.touches[0].clientX; }, { passive: true });
            chartContainer.addEventListener('touchend', function(e) {
                var endX = e.changedTouches[0].clientX;
                var slides = document.getElementById('chartSlides');
                if (slides && slides.classList.contains('show-history')) {
                    if (endX - startX > 80) closeHistoryChart();
                } else {
                    if (startX - endX > 80) openHistoryChart('assets');
                }
            }, { passive: true });
        }
    };
</script>
</body>
</html>
