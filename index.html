<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portfolio Engine</title>
    
    <link rel="apple-touch-icon" href="icon.png?v=3">
    <link rel="icon" type="image/png" href="icon.png?v=3">
    <meta name="apple-mobile-web-app-title" content="æŠ•è³‡é…æ¯”">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --theme-accent: #FF8C42;
            --theme-bg: #3D2B1F;
            --theme-accent-rgb: 255, 140, 66;
            --gray-marble: #F0F0F0;
            --radius: 12px;
        }
        [data-theme="orange"] { --theme-accent: #FF8C42; --theme-bg: #3D2B1F; --theme-accent-rgb: 255, 140, 66; }
        [data-theme="forest"] { --theme-accent: #dac4fc; --theme-bg: #293d0b; --theme-accent-rgb: 218, 196, 252; }
        [data-theme="wine"]   { --theme-accent: #80C5DE; --theme-bg: #6e0000; --theme-accent-rgb: 128, 197, 222; }
        [data-theme="purple"] { --theme-accent: #B4D355; --theme-bg: #6245b7; --theme-accent-rgb: 180, 211, 85; }
        [data-theme="navy"]   { --theme-accent: #e4d9c4; --theme-bg: #1b2941; --theme-accent-rgb: 228, 217, 196; }
        [data-theme="amber"]  { --theme-accent: #F0A650; --theme-bg: #0045c6; --theme-accent-rgb: 240, 166, 80; }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background-color: var(--gray-marble); color: #3D2B1F; font-family: -apple-system, sans-serif; margin: 0; padding: 0; }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 20px 15px; }

        /* æ¨™é¡Œèˆ‡é¢¨æ ¼å›æ­¸ */
        h1 { border: 4px solid #1A1A1A; text-align: center; margin: 0; background: var(--theme-accent); padding: 15px 12px; box-shadow: 6px 6px 0px #000; border-radius: var(--radius); color: var(--theme-bg); font-weight: 900; line-height: 1.2; }
        .save-status { text-align: center; font-size: 10px; font-weight: bold; margin: 10px 0 20px 0; color: #888; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; }
        .status-dot.active { background: #00C853; box-shadow: 0 0 8px #00C853; }

        .rebalance-panel { background: white; border: 4px solid #1A1A1A; padding: 20px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); }
        #rebalanceSummary { font-size: 2.5rem; font-weight: 900; letter-spacing: -1px; }

        /* å¡ç‰‡è¨­è¨ˆ */
        .category-card { background: #fff; border: 4px solid #1A1A1A; padding: 15px; margin-bottom: 25px; box-shadow: 6px 6px 0px #1A1A1A; border-radius: var(--radius); position: relative; }
        .category-header { background: var(--theme-bg); color: var(--theme-accent); padding: 12px 15px; margin: -15px -15px 15px -15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        
        /* æ¬„ä½æ¨™ç±¤ */
        .column-labels { display: grid; grid-template-columns: 20px 1.1fr 0.5fr 0.7fr 0.9fr 55px; gap: 4px; padding: 0 4px; margin-bottom: 5px; }
        .label-text { font-size: 8px; font-weight: 900; color: #bbb; text-align: center; }

        /* è³‡ç”¢åˆ— */
        .asset-item { display: grid; grid-template-columns: 20px 1.1fr 0.5fr 0.7fr 0.9fr 55px; gap: 4px; margin-bottom: 8px; align-items: center; }
        .static-view { background: #1A1A1A; color: white; padding: 6px 2px; font-size: 10px; text-align: center; min-height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 900; cursor: pointer; }
        .view-price { background: #F0F0F0; color: #1A1A1A; border: 1px solid #DDD; cursor: default; }
        .view-qty { background: #666; }
        
        .edit-container { position: relative; display: none; width: 100%; }
        .edit-input { width: 100%; height: 36px; border: 2px solid #1A1A1A; border-radius: 6px; text-align: center; font-weight: bold; font-size: 12px; outline: none; }
        
        .search-results { position: absolute; top: 38px; left: 0; right: 0; background: white; border: 3px solid #1A1A1A; border-radius: 8px; z-index: 1000; max-height: 150px; overflow-y: auto; box-shadow: 4px 4px 0px #000; display: none; }
        .search-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 11px; display: flex; justify-content: space-between; font-weight: bold; }

        .item-info { font-size: 9px; font-weight: 900; text-align: right; line-height: 1.1; }
        .status-tag { margin-top: 10px; padding: 8px; text-align: center; font-size: 0.8rem; border-radius: 8px; font-weight: 900; background: rgba(var(--theme-accent-rgb), 0.15); color: var(--theme-bg); border: 1px solid rgba(var(--theme-accent-rgb), 0.3); }

        .theme-panel { display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 10px; }
        .theme-toggle-icon { font-size: 0.75rem; font-weight: bold; cursor: pointer; background: white; padding: 5px 12px; border: 2px solid #1A1A1A; border-radius: 20px; box-shadow: 2px 2px 0px #000; }
        .theme-options { display: none; gap: 8px; margin-top: 10px; background: white; padding: 10px; border: 2px solid #1A1A1A; border-radius: 12px; box-shadow: 4px 4px 0px #000; z-index: 100; }
        .theme-panel.active .theme-options { display: flex; }
        .theme-options button { width: 25px; height: 25px; border-radius: 50%; border: 2px solid #1A1A1A; cursor: pointer; }

        .btn { background: var(--theme-accent); color: var(--theme-bg); border: 3px solid #1A1A1A; padding: 12px; font-weight: bold; width: 100%; border-radius: var(--radius); box-shadow: 4px 4px 0px #000; cursor: pointer; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="theme-panel" id="themePanel">
        <div class="theme-toggle-icon" onclick="this.parentElement.classList.toggle('active')">ğŸ¨ ä¸»é¡Œé…è‰²</div>
        <div class="theme-options">
            <button style="background: #FF8C42;" onclick="setTheme('orange')"></button>
            <button style="background: #dac4fc;" onclick="setTheme('forest')"></button>
            <button style="background: #80C5DE;" onclick="setTheme('wine')"></button>
            <button style="background: #B4D355;" onclick="setTheme('purple')"></button>
            <button style="background: #e4d9c4;" onclick="setTheme('navy')"></button>
            <button style="background: #F0A650;" onclick="setTheme('amber')"></button>
        </div>
    </div>

    <h1>
        <span style="font-size: 0.9em; letter-spacing: 2px;">Portfolio Engine</span><br>
        <span style="font-size: 0.7em;">è³‡ç”¢çµ„åˆè¨ˆç®—å™¨</span>
    </h1>

    <div class="save-status">
        <div class="status-dot" id="saveDot"></div>
        <span id="saveText">æ­£åœ¨è¼‰å…¥æœ¬åœ°å­˜æª”...</span>
    </div>

    <div class="rebalance-panel">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="font-size: 0.8rem; font-weight: 900; color: #888;">Total Assets | è³‡ç”¢ç¸½ç¾å€¼</div>
            <button style="background:var(--theme-accent); border:2px solid #000; font-size:10px; font-weight:900; padding:2px 8px; border-radius:5px;" onclick="toggleChart()">åœ–è¡¨</button>
        </div>
        <div id="rebalanceSummary">$0</div>
        <div id="target-sum-alert" style="margin-top:10px; font-size:11px; font-weight:bold; text-align:center; padding:5px; border-radius:6px; display:none;"></div>
        <div id="chartContainer" style="display:none; margin-top: 20px; height: 220px;"><canvas id="portfolioChart"></canvas></div>
    </div>

    <div id="mainGrid"></div>

    <button class="btn" onclick="addCategory()">+ æ–°å¢æŠ•è³‡å€åŸŸ</button>
    <button class="btn" style="background:#ddd; color:#888; border-color:#bbb; font-size:0.8rem;" onclick="clearAll()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
</div>

<script>
    let myChart = null, categories = [], STOCK_DB = [], EX_RATE = 32.5; 
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkSEPMNB8ApKn9N5fFjKjpTblkgvjOcJ1TE8r5SGC_rj2gNG8N2uKNCX92TxtJy9BL/exec";

    function formatCurrency(num) { return "$" + Math.round(num || 0).toLocaleString(); }

    const DEFAULT_CONFIG = [
        { id: 'cat_1', name: 'æˆé•·å‹æŠ•è³‡', target: 40 },
        { id: 'cat_2', name: 'é€²æ”»å‹æŠ•è³‡', target: 10 },
        { id: 'cat_3', name: 'é˜²å®ˆå‹æŠ•è³‡', target: 20 },
        { id: 'cat_4', name: 'é«˜è‚¡æ¯æŠ•è³‡', target: 20 },
        { id: 'cat_5', name: 'å®‰å…¨å­˜æ¬¾', target: 10 }
    ];

    function handleStockSearch(inputEl) {
        const query = inputEl.value.toUpperCase();
        const resultsEl = inputEl.parentElement.querySelector('.search-results');
        if (!query) { resultsEl.style.display = 'none'; return; }
        const filtered = STOCK_DB.filter(item => item.s.toString().includes(query) || item.n.includes(query)).slice(0, 8);
        if (filtered.length > 0) {
            resultsEl.innerHTML = filtered.map(item => `<div class="search-item" onclick="pickStock(this, '${item.s}', '${item.m}')"><span>${item.s}</span><span>${item.n}</span></div>`).join('');
            resultsEl.style.display = 'block';
        } else { resultsEl.style.display = 'none'; }
    }

    async function pickStock(el, s, m) {
        const item = el.closest('.asset-item');
        const nameInput = item.querySelector('.asset-name');
        const priceInput = item.querySelector('.asset-price');
        const marketInput = item.querySelector('.asset-market');
        
        nameInput.value = s;
        marketInput.value = m;
        item.querySelector('.search-results').style.display = 'none';
        
        // æŠ“å–åƒ¹æ ¼å‰å…ˆé¡¯ç¤ºè®€å–ç‹€æ…‹
        const priceView = item.querySelectorAll('.static-view')[3];
        priceView.innerText = "æŠ“å–ä¸­";

        try {
            const res = await fetch(`${SCRIPT_URL}?s=${s}&m=${m}`);
            const data = await res.json();
            if (data.price) { priceInput.value = data.price; }
            else { priceInput.value = 0; }
        } catch (e) { priceInput.value = 0; }
        
        autoViewMode(nameInput);
    }

    function addAsset(catId, name='', targetP=0, qty=0, price=0, market='TPE') {
        const list = document.getElementById(`list-${catId}`);
        const div = document.createElement('div');
        div.className = 'asset-item';
        div.innerHTML = `
            <button style="background:none; border:none; color:#FF4444; font-size:18px; cursor:pointer;" onclick="this.closest('.asset-item').remove(); calculateAll();">Ã—</button>
            <div style="position:relative;">
                <div class="static-view" onclick="editMode(this)">${name || 'æœå°‹ä»£ç¢¼'}</div>
                <div class="edit-container">
                    <input type="text" class="edit-input asset-name" value="${name}" oninput="handleStockSearch(this)" onblur="autoViewMode(this)">
                    <div class="search-results"></div>
                </div>
            </div>
            <div>
                <div class="static-view" style="background:#666;" onclick="editMode(this)">${targetP}%</div>
                <div class="edit-container"><input type="number" class="edit-input asset-target" value="${targetP}" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <div class="static-view view-qty" onclick="editMode(this)">${qty}</div>
                <div class="edit-container"><input type="number" class="edit-input asset-qty" value="${qty}" onblur="autoViewMode(this)"></div>
            </div>
            <div>
                <input type="hidden" class="asset-market" value="${market}">
                <input type="hidden" class="asset-price" value="${price}">
                <div class="static-view view-price" onclick="editMode(this)">${price}</div>
                <div class="edit-container"><input type="number" class="edit-input asset-price-edit" value="${price}" onblur="updatePrice(this)"></div>
            </div>
            <div class="item-info">
                <div class="item-total">$0</div>
                <div class="item-ratio" style="color:#888; font-size:8px;">0%</div>
            </div>
        `;
        list.appendChild(div);
        calculateAll();
    }

    function updatePrice(input) {
        const item = input.closest('.asset-item');
        item.querySelector('.asset-price').value = input.value;
        autoViewMode(input);
    }

    function calculateAll() {
        let total = 0, catSums = {}, totalTargetP = 0;
        
        // ç¬¬ä¸€è¼ªï¼šè¨ˆç®—å„å€ç¸½å’Œï¼ˆåŒ…å«åŒ¯ç‡æ›ç®—ï¼‰
        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if (!card) return;
            let sum = 0;
            totalTargetP += parseFloat(card.querySelector('.target-input').value) || 0;

            card.querySelectorAll('.asset-item').forEach(item => {
                const q = parseFloat(item.querySelector('.asset-qty').value) || 0;
                const p = parseFloat(item.querySelector('.asset-price').value) || 0;
                const m = item.querySelector('.asset-market').value;
                
                // åŒ¯ç‡æ›ç®—ï¼šå¦‚æœæ˜¯ç¾è‚¡ï¼Œåƒ¹æ ¼ä¹˜ä»¥åŒ¯ç‡
                const realPrice = (m === 'US') ? (p * EX_RATE) : p;
                const subtotal = q * realPrice;
                
                // æ›´æ–°å–®åƒ¹é¡¯ç¤º
                const priceView = item.querySelector('.view-price');
                priceView.innerText = (m === 'US' ? 'ğŸ‡ºğŸ‡¸ ' : '') + (p > 0 ? p.toLocaleString() : '---');
                if(m === 'US') priceView.style.color = "#0045c6";
                
                item.querySelector('.item-total').innerText = formatCurrency(subtotal);
                item._subtotal = subtotal; // æš«å­˜ç”¨æ–¼è¨ˆç®—ä½”æ¯”
                sum += subtotal;
            });
            catSums[cat.id] = sum;
            total += sum;
        });

        // ç¬¬äºŒè¼ªï¼šæ›´æ–°ä½”æ¯”èˆ‡å»ºè­°
        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            const sum = catSums[cat.id];
            const target = parseFloat(card.querySelector('.target-input').value) || 0;
            const targetAmt = total * (target / 100);
            
            card.querySelector('.cat-sum-display').innerText = formatCurrency(sum);
            card.querySelector('.current-p').innerText = (total > 0 ? (sum / total * 100).toFixed(1) : 0) + "%";
            
            card.querySelectorAll('.asset-item').forEach(item => {
                const ratio = sum > 0 ? (item._subtotal / sum * 100).toFixed(1) : 0;
                item.querySelector('.item-ratio').innerText = ratio + "%";
            });

            const diff = sum - targetAmt;
            const alertTag = card.querySelector('.status-alert');
            if (total === 0) alertTag.innerText = "âœ… è«‹é–‹å§‹è¼¸å…¥è³‡ç”¢";
            else if (Math.abs(sum - targetAmt) < (total * 0.01)) alertTag.innerText = "âœ… æ¯”ä¾‹ç†æƒ³";
            else alertTag.innerHTML = diff > 0 ? `âš ï¸ å»ºè­°ç§»å‡º <span style="color:#FF4444">${formatCurrency(diff)}</span>` : `âš ï¸ å»ºè­°è£œå…¥ <span style="color:#008800">${formatCurrency(Math.abs(diff))}</span>`;
        });

        document.getElementById('rebalanceSummary').innerText = formatCurrency(total);
        updateChart(catSums);
        forceSave();
    }

    function editMode(el) {
        if (el.classList.contains('view-price')) {
            // å–®åƒ¹æ¬„ä½é»æ“Šå¾Œå¯ç·¨è¼¯éš±è—çš„ price-edit
            const container = el.nextElementSibling;
            el.style.display = 'none';
            container.style.display = 'block';
            container.querySelector('input').focus();
            return;
        }
        const container = el.nextElementSibling;
        el.style.display = 'none';
        container.style.display = 'block';
        const input = container.querySelector('input');
        input.focus();
    }

    function autoViewMode(inputEl) {
        setTimeout(() => {
            if (document.activeElement.classList.contains('search-item')) return;
            const container = inputEl.parentElement;
            const view = container.previousElementSibling;
            const results = container.querySelector('.search-results');
            if (results) results.style.display = 'none';
            
            view.innerText = inputEl.value || (inputEl.classList.contains('asset-name') ? 'æœå°‹' : '0');
            container.style.display = 'none';
            view.style.display = 'flex';
            calculateAll();
        }, 200);
    }

    function renderUI() {
        const savedData = JSON.parse(localStorage.getItem('myPortfolio_v2')) || {};
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = '';
        categories.forEach(cat => {
            const data = savedData[cat.id] || { target: 20, assets: [] };
            const card = document.createElement('div');
            card.id = cat.id;
            card.className = 'category-card';
            card.innerHTML = `
                <div class="category-header">
                    <span style="font-weight:900;">${cat.name}</span>
                    <div style="font-size:12px; font-weight:900;">ç›®æ¨™ <input type="number" class="target-input" value="${data.target}" style="width:40px; background:var(--theme-accent); border:none; text-align:center; font-weight:900; border-radius:4px;" oninput="calculateAll()"> %</div>
                </div>
                <div class="column-labels" style="margin-top:10px;">
                    <div class="label-text"></div><div class="label-text">ä»£ç¢¼</div><div class="label-text">ç›®æ¨™</div><div class="label-text">è‚¡æ•¸</div><div class="label-text">å–®åƒ¹</div><div class="label-text">å€åŸŸæ¯”</div>
                </div>
                <div class="asset-list" id="list-${cat.id}"></div>
                <button class="btn" style="padding:8px; font-size:12px; margin-top:10px;" onclick="addAsset('${cat.id}')">+ æ–°å¢æ¨™çš„</button>
                <div class="card-footer" style="margin-top:15px; padding-top:10px; border-top:2px dashed #ddd;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="cat-sum-display" style="font-size:1.2rem; font-weight:900;">$0</span>
                        <span class="current-p" style="font-size:12px; font-weight:900;">0%</span>
                    </div>
                    <div class="status-tag status-alert">âœ… æ¯”ä¾‹ç†æƒ³</div>
                </div>
            `;
            grid.appendChild(card);
            if (data.assets && data.assets.length > 0) {
                data.assets.forEach(a => addAsset(cat.id, a.name, a.targetP, a.qty, a.value, a.market || 'TPE'));
            }
        });
    }

    function updateChart(catSums) {
        const ctx = document.getElementById('portfolioChart');
        if (!ctx || document.getElementById('chartContainer').style.display === 'none') return;
        const data = { labels: categories.map(c => c.name), datasets: [{ data: categories.map(c => catSums[c.id]), backgroundColor: ["#FF8C42","#dac4fc","#80C5DE","#B4D355","#e4d9c4","#F0A650"], borderWidth: 2, borderColor: '#fff' }] };
        if (myChart) { myChart.data = data; myChart.update(); }
        else { myChart = new Chart(ctx, { type: 'doughnut', data: data, options: { maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } } } } }); }
    }

    function toggleChart() { 
        const c = document.getElementById('chartContainer'); 
        c.style.display = c.style.display==='none'?'block':'none'; 
        calculateAll();
    }

    function forceSave() {
        const data = {};
        categories.forEach(cat => {
            const card = document.getElementById(cat.id);
            if (card) {
                const assets = [];
                card.querySelectorAll('.asset-item').forEach(item => {
                    assets.push({
                        name: item.querySelector('.asset-name').value,
                        targetP: parseFloat(item.querySelector('.asset-target').value) || 0,
                        qty: parseFloat(item.querySelector('.asset-qty').value) || 0,
                        value: parseFloat(item.querySelector('.asset-price').value) || 0,
                        market: item.querySelector('.asset-market').value
                    });
                });
                data[cat.id] = { target: parseFloat(card.querySelector('.target-input').value) || 0, assets: assets };
            }
        });
        localStorage.setItem('myPortfolio_v2', JSON.stringify(data));
        localStorage.setItem('catConfig_v2', JSON.stringify(categories));
        const dot = document.getElementById('saveDot');
        dot.classList.add('active'); setTimeout(()=>dot.classList.remove('active'), 800);
    }

    function setTheme(t) { document.documentElement.setAttribute('data-theme', t); localStorage.setItem('userTheme', t); }

    window.onload = () => {
        fetch('csvjson.json').then(res => res.json()).then(data => STOCK_DB = data);
        const savedCats = localStorage.getItem('catConfig_v2');
        categories = savedCats ? JSON.parse(savedCats) : DEFAULT_CONFIG;
        document.getElementById('saveText').innerText = "å·²è¼‰å…¥ Safari æœ¬åœ°å­˜æª”";
        renderUI();
        setTheme(localStorage.getItem('userTheme') || 'orange');
        calculateAll();
    };

    function clearAll() { if(confirm("é‡ç½®å°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    function addCategory() { const n = prompt("å€åŸŸåç¨±ï¼Ÿ"); if(n){ categories.push({id:'cat_'+Date.now(), name:n}); renderUI(); calculateAll(); } }
</script>
</body>
</html>
